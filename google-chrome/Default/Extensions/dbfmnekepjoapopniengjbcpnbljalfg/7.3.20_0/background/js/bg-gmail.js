"use strict";var gmail=function(){var i;function g(e){return e?e.textContent:null}return i={getUnreadEmails:function(e){return new Promise(function(d,h){var f=new XMLHttpRequest;f.onreadystatechange=function(){var e,i;if(4==f.readyState)if(f.responseXML){var t=f.responseXML,n=g(t.querySelector("title"));if(n)try{n=/(\w+)@(\w+\.\w+)/.exec(n)[0]}catch(e){}for(var a=parseInt(g(t.querySelector("fullcount")),10),r=t.querySelectorAll("entry"),o=[],l=-1,s=0,c=r.length;s<c;s++){var m=r[s],u={id:g(m.querySelector("id")),title:g(m.querySelector("title")),summary:g(m.querySelector("summary")),link:(e=m.querySelector("link"),i="href",e?e.getAttribute(i):null),authorEmail:g(m.querySelector("author email")),authorName:g(m.querySelector("author name")),issued:g(m.querySelector("issued"))};u.issued&&(u.issued=new Date(u.issued).valueOf(),l=Math.max(l,u.issued)),o.push(u)}d({account:n,lastIssuedTime:l,count:a,emails:o})}else h()},f.onerror=h,f.open("GET","https://mail.google.com/mail/feed/atom?zx="+encodeURIComponent(e),!0),f.send(null)})}},{check:function(){var s,c,m;return Promise.resolve(new Promise(function(e){chrome.storage.local.get("infinity-gmail",e)}).then(function(e){var i=e["infinity-gmail"];return{model:i=i||{account:null,lastIssuedTime:-1,instanceId:"gmc"+parseInt(Date.now()*Math.random(),10),emails:[]}}})).then(function(e){return s=e,i.getUnreadEmails(s.model.instanceId)}).then(function(e){var i,t=s.model.account,n=s.model.lastIssuedTime,a=e.emails;if(c=[],t===e.account)for(var r=0,o=a.length;r<o;r++){var l=a[r];l.issued>n&&c.push(l)}return m=e.count,s.model.account=e.account,s.model.lastIssuedTime=Math.max(n,e.lastIssuedTime),s.model.emails=a,i=s,new Promise(function(e){chrome.storage.local.set({"infinity-gmail":i.model},e)})}).then(function(){return{newEmails:c,unreadEmailCount:m}})},reset:function(){chrome.storage.local.remove("infinity-gmail")}}}(),bgGmail={delayTime:1,init:function(){var t=this;t.check(),chrome.alarms.onAlarm.addListener(function(e){"gmailCheck"==e.name&&t.check()}),infinity.onMessage("settingChange",function(e){if("isOpentGmailNotication"==e.type||"isShowGmailNum"==e.type){var i=infinity.get("infinity-settings");(i.isOpentGmailNotication||i.isShowGmailNum)&&t.check()}})},check:function(){var a=this,r=void 0;chrome.alarms.clear("gmailCheck"),(r=infinity.get("infinity-settings")).isOpentGmailNotication||r.isShowGmailNum?gmail.check().then(function(e){var i=r.gmailUnreadNum;e.unreadEmailCount>i&&infinity.sendMessage("updateGmailUnreadNum"),infinity.setting("gmailUnreadNum",e.unreadEmailCount),r=infinity.get("infinity-settings");var t=e.newEmails;if(r.isOpentGmailNotication){var n=void 0;t.map(function(e,i){n={type:"basic",contextMessage:e.authorName+"("+e.authorEmail+")",title:e.title,message:e.summary,iconUrl:"/icon/gmail.png",isClickable:!0},r.isOpentGmailRingNotication&&a.ring(),chrome.notifications.create(e.link,n,function(){})}),chrome.alarms.create("gmailCheck",{delayInMinutes:a.delayTime})}}).catch(function(e){chrome.alarms.create("gmailCheck",{delayInMinutes:a.delayTime})}):chrome.alarms.clear("gmailCheck")},ring:function(){var e=new Audio("/background/res/ring.mp3");e.play(),e.remove()}};