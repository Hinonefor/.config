"use strict";var iData={backupAjax:!1,recoveryAjax:!1,onBackupData:function(){var t=this;infinity.import("confirm","body",function(i){i.init({confirm:{title:infinity.i18n("are_you_sure"),subtitle:infinity.i18n("will_cover_cloud"),confirmBtn:infinity.i18n("backup_now"),cancelBtn:infinity.i18n("cancel"),whenConfirm:function(){},whenCancel:function(){}},loading:{title:infinity.i18n("backuping"),subtitle:infinity.i18n("i_please_wait"),loadingCancelBtn:infinity.i18n("cancel"),successText:infinity.i18n("backup_success"),successSubText:infinity.i18n("backup_success_desc"),failText:infinity.i18n("backup_failed")+","+infinity.i18n("try_later"),successBtn:infinity.i18n("done"),cancelBtn:infinity.i18n("cancel"),failBtn:infinity.i18n("done"),loader:null,whenLoading:function(i,n){t.backupData(i,n)},whenCancel:function(){t.backupAjax.abort()}}})})},createOldVersionBackupData:function(i,n,t,e){var a,o={},s={},c={"infinity://weather":"weather","infinity://todos":"todos","infinity://notes":"notepad","infinity://history":"history","infinity://bookmarks":"bookmarks","infinity://gmail":"gmail","infinity://extension":"apps","infinity://settings":"setting"};return s.autoWallpaper=!1,s.minimalistMode=!1,s.startAnimation=n.isOpenStartAnimation,s.openInNewtab=n.isOpenLinkInNewTab,s.displayAtTop=n.isShowTopBar,s.displayTopType="bookmarks"==n.topBarType?"Bookmarksbar":"mostVisited",s.OpenBookmarksInNewtab=n.isOpenBookmarkInNewTab,s.searchBox=n.isShowSearchBox,s.searchType=n.isShowSearchType,s.searchInNewtab=n.isSearchInNewTab,s.GmailMessage=n.isOpentGmailNotication,s.blurWallpaper=n.isBlurWallpaper,s.notificationSound=n.isOpentGmailRingNotication,s.iconOpacity=n.iconOpacity,s.iconFillet=n.iconBorderRadius,s.iconNum=n.column+"x"+n.row,s.temperatureUnit=n.tempUnitC?"Celsius":"Fahrenheit",s.fontColor=n.fontColor,s.todosfalse=t.todos.dones.map(function(i,n){return i.text}),s.todostrue=t.todos.todos.map(function(i,n){return i.text}),s.notes=t.notes.map(function(i,n){return i.title=i.text.substr(0,10)||infinity.i18n("new_edit_notes"),i}),s.searchBottom=e.additions.map(function(n,i){try{n.searchStart=n.url.split("%s")[0],n.searchEnd=n.url.split("%s")[1]}catch(i){n.searchStart="",n.searchEnd=""}return n}),a=i.map(function(i){return i.map(function(i){var n={};return n.type=c[i.url]||"ico",n.url=i.url,n.name=i.name,i.bgColor&&(n.bgColor=i.bgColor,0!=i.bgColor.indexOf("rgb")&&0!=n.bgColor.indexOf("#")&&"transparent"!=n.bgColor&&(n.bgColor="#"+i.bgColor)),n.ico=i.src,"text"==i.customType&&(n.title=i.showText,n.type="custom"),"image"==i.customType&&(n.title="",n.type="custom"),n})}),o.setting=encodeURIComponent(JSON.stringify(s)),o.main=encodeURIComponent(JSON.stringify(a)),o},setLocalBackupTime:function(i,n){var t=infinity.get("infinity-local-data");t.backupTime=parseInt(n),infinity.set("infinity-local-data",t),i.backupTime=n,infinity.set("infinity-user",i),infinity.sendMessage("bg-userStatusChange")},backupData:function(a,o){var s=this,c=infinity.get("infinity-icons"),r=infinity.get("infinity-searches"),f=infinity.get("infinity-settings"),y=infinity.get("infinity-user");infinity.get("infinity-data",!0,function(i){var n={type:"theNew__INFINITY",backupType:"cloud",version:10,icons:c,searches:r,settings:f,otherData:i},t=s.createOldVersionBackupData(infinity.deepCopy(c),infinity.deepCopy(f),infinity.deepCopy(i),infinity.deepCopy(r));n.main=t.main,n.setting=t.setting;var e=JSON.stringify(n);s.backupAjax=$.ajax({url:infinity.api+"/upSync.php",type:"POST",dataType:"json",data:{username:y.email,password:y.password,json:e}}).done(function(i){"2"==i.message?(a&&a(),s.setLocalBackupTime(y,i.backupTime)):o&&o()}).fail(function(){o&&o()}).always(function(){})})},onRecoveryData:function(){var o=this;infinity.import("confirm","body",function(a){a.init({confirm:{title:infinity.i18n("are_you_sure"),subtitle:infinity.i18n("will_cover_local"),confirmBtn:infinity.i18n("recovery_now"),cancelBtn:infinity.i18n("cancel"),whenConfirm:function(){},whenCancel:function(){}},loading:{title:infinity.i18n("restoring"),subtitle:infinity.i18n("i_please_wait"),loadingCancelBtn:infinity.i18n("cancel"),successText:infinity.i18n("restore_complete"),successSubText:infinity.i18n("local_is_new"),failText:infinity.i18n("data_recovery_failed")+","+infinity.i18n("try_later"),successBtn:infinity.i18n("done"),cancelBtn:infinity.i18n("cancel"),failBtn:infinity.i18n("done"),loader:null,whenLoading:function(e,i){o.recoveryData(function(i,n){var t=infinity.get("infinity-user");o.setLocalBackupTime(t,i),o.handleRecoverySuccess(n,a,a.loading,e),infinity.sendMessage("recoverySuccess"),infinity.sendMessage("bg-reCheckIsAdded")},function(){i()})},whenCancel:function(){o.recoveryAjax.abort(),fail&&fail()}}})})},recoveryData:function(f,y){var l=this,i=(infinity.get("infinity-icons"),infinity.get("infinity-searches"),infinity.get("infinity-settings"),infinity.get("infinity-user"));l.recoveryAjax=$.ajax({url:infinity.api+"/downSync.php",type:"POST",dataType:"json",data:{username:i.email,password:i.password}}).done(function(n){try{if(10==n.version){var i=n.icons,t=l.handleSettingData(n.settings),e=n.searches;e.all||(e.all=[]);for(var a=e.all,o=0,s=a.length;o<s;o++){if("dd3af9cc97ad7de8984baaf59514bb52"===a[o].seId){a.splice(o,1);break}}var c=n.otherData;infinity.set("infinity-icons",i),infinity.set("infinity-settings",t),infinity.set("infinity-searches",e),infinity.set("infinity-data",c,!0,function(){f&&f(n.backupTime,t)})}else{var r=l.getOldData(n,"cloud");infinity.sendMessage("transferOldData",r,function(i){i.isSuccess?f&&f(n.backupTime,settings):y&&y()})}}catch(i){y&&y()}}).fail(function(){y&&y()}).always(function(){})},handleSettingData:function(i){var n=infinity.get("infinity-settings"),t=infinity.deepCopy(i);return t.bingMd5=(new Date).getTime(),t.isAutoBackUp=n.isAutoBackUp,t.viewZoom=n.viewZoom,"local"==t.wallpaperType&&infinity.sendMessage("setDefaultWallpaper"),t},onGenerateBackupData:function(){var r=this,f=infinity.get("infinity-icons"),y=infinity.get("infinity-searches"),l=infinity.get("infinity-settings");infinity.get("infinity-user");infinity.get("infinity-data",!0,function(i){var n={type:"theNew__INFINITY",backupType:"local",time:(new Date).getTime(),version:10,icons:f,searches:y,settings:l,otherData:i},t=r.createOldVersionBackupData(infinity.deepCopy(f),infinity.deepCopy(l),infinity.deepCopy(i),infinity.deepCopy(y));n.main=t.main,n.setting=t.setting;var e=JSON.stringify(n),a=new Blob([e],{type:"text/infinity"}),o=new Date,s=o.getFullYear()+"-"+(o.getMonth()+1)+"-"+o.getDate(),c=document.createElement("a");c.href=window.URL.createObjectURL(a),c.download="infinityBackup-"+s+".infinity",c.click(),c.remove()})},getOldData:function(i,n){var t=decodeURIComponent(i.main),e=decodeURIComponent(i.setting);return{from:n,oldData:{user:null,main:JSON.parse(t),setting:JSON.parse(e),lastTime:null}}},handleRecoverySuccess:function(t,e,a,o){var s=[],c=[];chrome.permissions.getAll(function(i){if(i.permissions.includes("bookmarks")&&i.permissions.includes("notifications")&&i.permissions.includes("topSites")&&i.origins.includes("https://mail.google.com/*"))o&&o();else{var n="";i.permissions.includes("notifications")&&i.origins.includes("https://mail.google.com/*")||!0!==t.isShowGmailNum&&!0!==t.isOpentGmailNotication||(n+="\n\n• "+infinity.i18n("gmail_noti"),s.push("notifications"),c.push("https://mail.google.com/*")),t.isShowTopBar&&("bookmarks"!==t.topBarType||i.permissions.includes("bookmarks")||(n+="\n\n• "+infinity.i18n("show_bookmarks_at_top"),s.push("bookmarks")),"topsites"!==t.topBarType||i.permissions.includes("topSites")||(n+="\n\n• "+infinity.i18n("show_topsites_at_the_top"),s.push("topSites"))),0<n.length&&(a.successSubText=infinity.i18n("re_grant")+n+"\n")}(s.length||c.length)&&(e.afterDone=function(n){chrome.permissions.request({origins:c.concat("chrome://favicon/"),permissions:s},function(i){if(i)try{s.includes("topSites")&&chrome.topSites.get(function(i){infinity.set("infinity-topsites",i),_app.renderMostVisited()}),s.includes("bookmarks")&&_app.initTopBar()}catch(i){}n&&n()})}),o&&o()})},onRecoveryFromFileSuccess:function(n){var t=this;infinity.import("confirm-simple","body",function(i){i.title=infinity.i18n("restore_complete"),i.successBtn=infinity.i18n("done"),t.handleRecoverySuccess(n,i,i,function(){i.show()})}),infinity.sendMessage("recoverySuccess"),infinity.sendMessage("bg-reCheckIsAdded")},onRecoveryFromFile:function(){var r=this;infinity.chooseFile(".infinity,text/plain,application/json","readAsText").then(function(i){try{var n=JSON.parse(i);if(10==n.version){var t=n.icons,e=r.handleSettingData(n.settings),a=n.searches,o=n.otherData;infinity.set("infinity-icons",t),infinity.set("infinity-settings",e),infinity.set("infinity-searches",a),infinity.set("infinity-data",o,!0,function(){r.onRecoveryFromFileSuccess(e)})}else{var s=JSON.parse(i),c=r.getOldData(s,"file");infinity.alert({html:infinity.i18n("restoring"),isShowBackCover:!0}),infinity.sendMessage("transferOldData",c,function(i){if(i.isSuccess){var n=infinity.get("infinity-settings");r.onRecoveryFromFileSuccess(n)}else infinity.alert({html:infinity.i18n("data_recovery_failed"),autoCloseTime:1.5})})}}catch(i){infinity.alert({html:infinity.i18n("data_recovery_failed"),autoCloseTime:1.5})}})},checkIsNeedBackUp:function(){},checkAutoBackup:function(){var t=this,i=infinity.get("infinity-user");$.ajax({url:infinity.api+"/login.php?name="+i.email+"&password="+i.password+"&version=2",type:"GET",dataType:"json",timeout:1e3}).done(function(i){if("1"==i.message){var n=infinity.get("infinity-local-data");(parseInt(n.backupTime)||0)<(parseInt(i.backupTime)||0)?t.needRecoveryFirst():infinity.setting("isAutoBackUp",!0)}else infinity.setting("isAutoBackUp",!0)}).fail(function(){infinity.setting("isAutoBackUp",!0)})},needRecoveryFirst:function(){var t=this;infinity.import("confirm","body",function(i){i.init({confirm:{title:infinity.i18n("detect_cloud_backup"),subtitle:infinity.i18n("if_not_recovery_now"),confirmBtn:infinity.i18n("recovery_now"),cancelBtn:infinity.i18n("discard"),whenConfirm:function(){},whenCancel:function(){var i=infinity.modules.settings;infinity.setting("isAutoBackUp",!0),i.settings.isAutoBackUp=!0}},loading:{title:infinity.i18n("restoring"),subtitle:infinity.i18n("i_please_wait"),loadingCancelBtn:infinity.i18n("cancel"),successText:infinity.i18n("restore_complete"),successSubText:infinity.i18n("local_is_new"),failText:infinity.i18n("data_recovery_failed")+","+infinity.i18n("try_later"),successBtn:infinity.i18n("done"),cancelBtn:infinity.i18n("cancel"),failBtn:infinity.i18n("done"),loader:null,whenLoading:function(i,n){t.recoveryData(function(){i&&i(),infinity.setting("isAutoBackUp",!0)},n)},whenCancel:function(){infinity.setting("isAutoBackUp",!0)}}})})}};