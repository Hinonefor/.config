"use strict";var infinityLang=chrome.i18n.getUILanguage();infinity.modules["weather-weather"]=function(){return new Vue({el:"#v-weather",data:{weatherIconPath:"/modules/weather/icon/",weatherData:null,cityQueryAjax:null,currentList:0,isShowWeatherSetting:!1,preText:"",isShowCityAddLoading:!1,isShowInitWeatherLoading:!1,isInitWeatherFailed:!1,isTempUnitC:SETTING.tempUnitC,isShowPermissionRequest:!1,w_icons:{19:{color:"#B9B18F",img:"blowingsand.png"},22:{color:"#B9B18F",img:"ash.png"},26:{color:"#27CDFF",img:"cloudy.png"},27:{color:"#27CDFF",img:"cloudy.png"},28:{color:"#27CDFF",img:"cloudy.png"},29:{color:"#27CDFF",img:"cloudy.png"},30:{color:"#27CDFF",img:"cloudy.png"},44:{color:"#27CDFF",img:"cloudy.png"},9:{color:"#A1BAC6",img:"drizzle.png"},20:{color:"#AEAEAE",img:"fog.png"},21:{color:"#808080",img:"fogandhaze.png"},17:{color:"#A1BAC6",img:"hail.png"},41:{color:"#6C828D",img:"heavysnow.png"},43:{color:"#6C828D",img:"heavysnow.png"},13:{color:"#A1BAC6",img:"lightsnow.png"},14:{color:"#A1BAC6",img:"lightsnow.png"},15:{color:"#A1BAC6",img:"lightsnow.png"},16:{color:"#A1BAC6",img:"lightsnow.png"},25:{color:"#A1BAC6",img:"lightsnow.png"},31:{color:"#211A3E",img:"moon.png"},33:{color:"#211A3E",img:"moon.png"},6:{color:"#A1BAC6",img:"rainandsnow.png"},7:{color:"#A1BAC6",img:"rainandsnow.png"},18:{color:"#A1BAC6",img:"rainandsnow.png"},11:{color:"#A1BAC6",img:"shower.png"},12:{color:"#A1BAC6",img:"shower.png"},40:{color:"#A1BAC6",img:"shower.png"},8:{color:"#95BAD9",img:"sleet.png"},10:{color:"#95BAD9",img:"sleet.png"},32:{color:"#27CDFF",img:"sunny.png"},34:{color:"#27CDFF",img:"sunny.png"},3:{color:"#A1BAC6",img:"thunder.png"},4:{color:"#A1BAC6",img:"thunder.png"},37:{color:"#A1BAC6",img:"thunderstorm.png"},38:{color:"#A1BAC6",img:"thunderstorm.png"},39:{color:"#A1BAC6",img:"thunderstorm.png"},45:{color:"#A1BAC6",img:"thunderstorm.png"},47:{color:"#A1BAC6",img:"thunderstorm.png"},35:{color:"#A1BAC6",img:"thunderstormandhail.png"},0:{color:"#808080",img:"typhoon.png"},1:{color:"#808080",img:"typhoon.png"},2:{color:"#808080",img:"typhoon.png"},23:{color:"#27CDFF",img:"wind.png"},24:{color:"#27CDFF",img:"wind.png"},5:{color:"#A1BAC6",img:"rainandsnow.png"},46:{color:"#A1BAC6",img:"snowshowers.png"}}},created:function(){var t=this;t.updateData(),t.addCity(),t.onSettingChangeFromOtherNewTab(),t.onBackgroundUpdate(),infinity.onMessage("weatherCityChange",function(){t.updateData()})},methods:{onOpen:function(){var e=this;chrome.permissions.contains({origins:["https://www.yahoo.com/*"]},function(t){t||(e.isShowPermissionRequest=!0)})},requestPermission:function(){var e=this;chrome.permissions.request({origins:["https://www.yahoo.com/*"]},function(t){t&&(e.isShowInitWeatherLoading=!0,e.isInitWeatherFailed=!1,e.onGetPermission(infinity.setting("woeid")))})},close:function(){iView.hideSideBar()},updateData:function(){var e=this;infinity.get("infinity-weather",!0,function(t){e.weatherData=t})},onBackgroundUpdate:function(){var t=this;infinity.onMessage("updateWeather",function(){t.updateData()})},onSettingChangeFromOtherNewTab:function(){var t=this;infinity.onMessage("settingChange",function(){setTimeout(function(){t.isTempUnitC=SETTING.tempUnitC},10)})},closeWeatherSetting:function(){$(".weather-input").val(""),$(".weather-city-lists").html(""),this.isShowWeatherSetting=!1},showWeatherSetting:function(){$(".weather-city-lists").html(""),this.isShowWeatherSetting=!0},saveAndSync:function(){var e=this;infinity.get("infinity-weather",!0,function(t){t=e.weatherData,infinity.set("infinity-weather",t,!0)})},hideCityAddLoading:function(){this.isShowCityAddLoading=!1,this.cityAddAjax.abort()},addCity:function(){var n=this;$(document).on("input",".weather-input",function(t){var e=$(".weather-input").val();$(".weather-city-lists").html(""),0<e.length&&$(".w-add-sugg").show()}),$(document).on("keydown",".weather-input",function(t){$(".weather-city-res").removeClass("weather-city-res-select");var e=$(".weather-city-res").length;if(38==t.which)t.preventDefault(),--n.currentList,n.currentList<=-1&&(n.currentList=e),$(".weather-city-lists-in").scrollTop(30*(n.currentList-1)),$(".weather-city-res:nth-child("+n.currentList+")").addClass("weather-city-res-select"),0==n.currentList?$(".weather-input").val(n.preText):$(".weather-input").val($(".weather-city-res:nth-child("+n.currentList+")").attr("data-city"));else if(40==t.which)t.preventDefault(),n.currentList+=1,n.currentList>=e+1&&(n.currentList=0),$(".weather-city-lists-in").scrollTop(30*(n.currentList-1)),$(".weather-city-res:nth-child("+n.currentList+")").addClass("weather-city-res-select"),0==n.currentList?$(".weather-input").val(n.preText):$(".weather-input").val($(".weather-city-res:nth-child("+n.currentList+")").attr("data-city"));else if(13==t.which&&0!=n.currentList)return n.onSetCity($(".weather-city-res:nth-child("+n.currentList+")")),void $(".weather-city-lists").html("")}),$(document).on("keydown",".weather-input",function(t){if(13==t.which){$("#w-loading").show(),$(".w-add-sugg").hide();var e=$(".weather-input").val();n.preText=e;var i="https://www.yahoo.com/news/_td/api/resource/WeatherSearch;text="+encodeURIComponent(e)+"?bkt=news-d-147&device=desktop&feature=cacheContentCanvas%2Ccanvass%2Cfeaturebar%2CdeferModalCluster%2CspecRetry&intl="+infinityLang+"&lang="+infinityLang+"&partner=none&region=US&site=fp&tz=America%2FLos_Angeles&ver=2.0.2213002&returnMeta=true&t="+(new Date).getTime();$(".weather-city-lists").html('<div class="weather-city-loading"><div class="spinner"><div class="dot1"></div><div class="dot2"></div></div></div>'),n.cityQueryAjax&&n.cityQueryAjax.abort(),n.cityQueryAjax=$.ajax({url:i,dataType:"json"}).done(function(t){$("#w-loading").hide(),n.currentList=0;var e=t.data.splice(0,20),i="";i='<div class="weather-city-lists-in">',0===e.length?$(".weather-city-lists").html('<div class="weather-error">'+infinity.i18n("city_not_found")+"</div>"):(e.map(function(t,e){i+='<li class="weather-city-res" data-city="'+t.city+'" data-woeid="'+t.woeid+'">'+t.qualifiedName+"</li>"}),i+="</div>",$(".weather-city-lists").html(i))}).fail(function(t,e,i){"abort"!=e&&$(".weather-city-lists").html('<div class="weather-error">'+infinity.i18n("net_error")+"</div>")})}}),$(document).on("click",".weather-city-res",function(t){t.preventDefault(),n.onSetCity($(this))})},onSetCity:function(t){var o=this,r=t.attr("data-woeid"),e="https://www.yahoo.com/news/_tdnews/api/resource/WeatherService;woeids=%5B"+r+"%5D?t="+Date.now();o.isShowCityAddLoading=!0,o.cityAddAjax=$.ajax({url:e,dataType:"json",timeout:5e3}).done(function(t){try{var e=t.weathers[0];if(e&&e.location&&e.location.woeid==r&&e.provider&&e.provider.name){var i=e.observation,n={};n.today={code:i.conditionCode,temp:{current:i.temperature.now,high:i.temperature.high,low:i.temperature.low},text:i.conditionDescription,humidity:i.humidity+" %",pressure:i.barometricPressure.toFixed(1)+" bar",wind:i.windSpeed+" mph"},n.future=[],n.location={},n.location.country=e.location.countryName,n.location.city=e.location.displayName,n.woeid=r,infinity.setting("woeid",r),e.forecasts.daily.map(function(t,e){if(0<e&&e<6){var i={};i.code=t.conditionCode,i.date=new Date(t.observationTime.timestamp),i.high=t.temperature.high,i.low=t.temperature.low,i.text=t.conditionDescription,n.future.push(i)}}),infinity.set("infinity-weather",n,!0,function(){o.updateData(),o.hideCityAddLoading(),o.closeWeatherSetting(),document.getElementById("w-content").scrollTop=0,infinity.sendMessage("weatherCityChange"),infinity.sendMessage("backupToCloud")})}else infinity.alert({html:infinity.i18n("city_set_failed"),autoCloseTime:1.5}),o.hideCityAddLoading()}catch(t){infinity.alert({html:infinity.i18n("city_set_failed"),autoCloseTime:1.5}),o.hideCityAddLoading()}}).fail(function(t,e,i){"abort"!=e&&(infinity.alert({html:infinity.i18n("city_set_failed"),autoCloseTime:1.5}),o.hideCityAddLoading())})},onGetPermission:function(t){var o=this,r=t,e="https://www.yahoo.com/news/_tdnews/api/resource/WeatherService;woeids=%5B"+r+"%5D?t="+Date.now();$.ajax({url:e,dataType:"json",timeout:5e3}).done(function(t){try{var e=t.weathers[0];if(e&&e.location&&e.location.woeid==r&&e.provider&&e.provider.name){var i=e.observation,n={};n.today={code:i.conditionCode,temp:{current:i.temperature.now,high:i.temperature.high,low:i.temperature.low},text:i.conditionDescription,humidity:i.humidity+" %",pressure:i.barometricPressure.toFixed(1)+" bar",wind:i.windSpeed+" mph"},n.future=[],n.location={},n.location.country=e.location.countryName,n.location.city=e.location.displayName,n.woeid=r,infinity.setting("woeid",r),e.forecasts.daily.map(function(t,e){if(0<e&&e<6){var i={};i.code=t.conditionCode,i.date=new Date(t.observationTime.timestamp),i.high=t.temperature.high,i.low=t.temperature.low,i.text=t.conditionDescription,n.future.push(i)}}),infinity.set("infinity-weather",n,!0,function(){o.isShowPermissionRequest=!1,o.updateData(),document.getElementById("w-content").scrollTop=0,infinity.sendMessage("weatherCityChange"),infinity.sendMessage("backupToCloud")})}else o.getWeatherFailed(r)}catch(t){o.getWeatherFailed(r)}}).fail(function(t,e,i){o.getWeatherFailed(r)})},getWeatherFailed:function(){this.isInitWeatherFailed=!0},transWeek:function(t){return new Date(t).toLocaleString([infinityLang],{weekday:"short"})},onChangeTempUnit:function(){this.isTempUnitC=JSON.parse(this.isTempUnitC),infinity.setting("tempUnitC",this.isTempUnitC),infinity.sendMessage("backupToCloud")},transUnit:function(e){try{var t=parseInt(e);return this.isTempUnitC?Math.round((t-32)/1.8):t}catch(t){return e}}}})};