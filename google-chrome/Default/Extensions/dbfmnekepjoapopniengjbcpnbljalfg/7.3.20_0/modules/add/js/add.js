"use strict";infinity.modules["add-add"]=function(){return new Vue({el:"#v-add",data:{categorys:[{id:"popular"},{id:"games"},{id:"shopping"},{id:"app"},{id:"music"},{id:"photos"},{id:"news"},{id:"social"},{id:"sports"},{id:"life"},{id:"education"},{id:"tech"},{id:"finance"},{id:"read"},{id:"others"}],currentType:"popular",currentList:[],staticLang:infinity.isZh()?"zh":"en",page:0,addedIcons:[],isShowMoreLoading:!1,isLockLoadMore:!1,isLoadError:!1,input:"",isSearching:!1,isSearchQuery:!1,isSearchDone:!1,iconPath:iconPath,isShowSearchResult:!1,custom:{isShow:!1,isAddDone:!1,colors:[{select:!1,id:"transparent",value:"transparent",border:"ccc",bgImage:"url(/icon/transparent.png)"},{select:!0,id:"1abc9c",value:"1abc9c",border:"1abc9c",bgImage:"none"},{select:!1,id:"2ecc71",value:"2ecc71",border:"2ecc71",bgImage:"none"},{select:!1,id:"33c5c5",value:"33c5c5",border:"33c5c5",bgImage:"none"},{select:!1,id:"3498db",value:"3498db",border:"3498db",bgImage:"none"},{select:!1,id:"9b59b6",value:"9b59b6",border:"9b59b6",bgImage:"none"},{select:!1,id:"34495e",value:"34495e",border:"34495e",bgImage:"none"},{select:!1,id:"f1c40f",value:"f1c40f",border:"f1c40f",bgImage:"none"},{select:!1,id:"e67e22",value:"e67e22",border:"e67e22",bgImage:"none"},{select:!1,id:"e74c3c",value:"e74c3c",border:"e74c3c",bgImage:"none"},{select:!1,id:"picker",value:"3b3333",border:"3b3333",bgImage:"none"}],selectColor:{id:"1abc9c",value:"1abc9c",border:"1abc9c",bgImage:"none"},croppedImage:null,isShowCustomAddLoading:!1,cusUrl:"",cusName:"",showText:"",customIconType:"text",searchAjax:!1}},created:function(){var e=this;e.moduleInit(),e.onOpen(),infinity.onMessage("reCheckIsAdded",function(){e.reCheckIsAdded()})},methods:{moduleInit:function(){var i=this;$(".i-add").one("transitionend",function(e){e.preventDefault(),i.setAllAddedIcons(),i.onReloadResponse(),setTimeout(function(){i.getPopular(),i.onInitCustom()},50),i.debouncedSearch=$.debounce(500,!1,i.search)})},openSetting:function(){$(".i-add").removeClass("i-side-show"),$(".main").removeClass("main-move"),infinity.import("settings",".side-all",function(){$(".i-settings").removeClass("i-side-hide"),$(".i-settings")[0].offsetHeight,$(".i-settings").addClass("i-side-show")})},close:function(){iView.hideSideBar()},onOpen:function(){$(".i-add").on("transitionend",function(e){0<=e.target.className.indexOf("i-add")&&e.target.className.indexOf("i-side-show")})},onsearch:function(){var e=this,i=document.getElementById("add-search").value;(i=i.trim())?i==e.input&&(e.isSearching=!0,e.currentType="search",e.doSearch()):e.getPopular()},doSearch:function(){this.isSearchQuery=!0,this.debouncedSearch()},search:function(){var i=this,e=document.getElementById("add-search").value;if(e){i.isSearchQuery=!0,i.isSearchDone=!1;var t=chrome.i18n.getUILanguage(),n=infinity.apiPro+"get-icons?type=search&lang="+t+"&page=0&keyword="+e;i.searchAjax&&i.searchAjax.abort(),i.searchAjax=$.ajax({url:n,dataType:"json"}).done(function(e){i.isSearchDone=!0,i.currentList=e.icons,i.currentList.length?i.isShowSearchResult=!0:i.isShowSearchResult=!1}).fail(function(){}).always(function(){i.isSearchQuery=!1})}},setAllAddedIcons:function(){for(var e=infinity.get("infinity-icons"),i=[],t=0;t<e.length;t++)for(var n=e[t],o=0;o<n.length;o++)i.push(n[o]);this.addedIcons=i},getPopular:function(){this.getList({id:"popular"})},onScrollBottom:function(e){var n=this,i=void 0,t=void 0;n.lockScroll||(t=e.target.clientHeight,i=e.target.scrollHeight,t+e.target.scrollTop!==i||n.isLockLoadMore||(n.isLockLoadMore=!0,infinity.get("infinity-cloud-icon-"+n.currentType,!0,function(e){var i=n.page+1;if(i<e.pages){n.isShowMoreLoading=!0;var t=e.data[i];setTimeout(function(){n.isShowMoreLoading=!1,n.currentList=n.currentList.concat(t),n.isLockLoadMore=!1,n.page=i},200)}else n.isLockLoadMore=!1,n.isShowMoreLoading=!1})))},getList:function(e){var i=this;i.searchAjax&&i.searchAjax.abort(),i.currentType=e.id,i.currentList=[],i.page=0,i.isLockLoadMore=!0,i.isSearching=!1,i.isSearchQuery=!1,i.isSearchDone=!1,i.isShowSearchResult=!1,infinity.get("infinity-cloud-icon-"+e.id,!0,function(e){null==e?i.isLoadError=!0:setTimeout(function(){i.currentList=e.data[i.page],i.isLockLoadMore=!1},100)})},reload:function(){var t=this;t.isLoadError=!1,chrome.tabs.getCurrent(function(e){var i={type:t.currentType,tabId:e.id};infinity.sendMessage("cloud-api-reload",i)})},onReloadResponse:function(){var t=this;infinity.onMessage("cloud-api-reload-response",function(i){chrome.tabs.getCurrent(function(e){e.id==i.tabId&&t.getList({id:t.currentType})})})},isAdded:function(e){var i=this.addedIcons;for(var t in i)if(i[t].url&&i[t].url==e)return!0;return!1},reCheckIsAdded:function(){this.currentList.map(function(e){e.isAdded=!1}),this.currentList=infinity.deepCopy(this.currentList)},getAddPosition:function(){var e=infinity.get("infinity-icons"),i=SETTING.row*SETTING.column;if(0==e.length&&e.push([]),e[_app.data.currentPage].length<i)return _app.data.currentPage;var t=e.length;for(var n in e)if(e[n].length<i){t=n;break}return parseInt(t)},onAdd:function(e,i){if(this.lockAdd)return!1;this.lockAdd=!0;var t=void 0;"official"==i?(t={uid:e.uid,name:infinity.i18n(e.name),url:e.url,src:e.src,iconType:i},infinity.sendMessage("ga-add-icon",{url:e.url,type:"官方"})):((t=e).iconType=i,infinity.sendMessage("ga-add-icon",{url:e.url,type:"自定义"}));var n=this.getAddPosition(),o=document.createElement("div");o.setAttribute("draggable","true"),o.className="icon-item-out OPACITY infinity-zoom-show";var s='\n\t\t                <div class="item-icon" url="'+t.url+'" data-icon="'+encodeURIComponent(JSON.stringify(t))+'">\n\t\t                \t<div class="item-icon-del"></div>\n\t\t                    <div class="icon-img BORDERRADIUS" style="background-image:url('+(t.src?t.src+iconPath:"")+");background-color:"+t.bgColor+';">'+(t.showText&&"text"==t.customType?t.showText:"")+'</div>\n\t\t                    <div class="icon-item-edit BORDERRADIUS"></div>\n\t\t                </div>\n\t\t                <div class="icon-name FONTCOLOR ICONNAMEOPACITY">'+t.name+"</div>\n\t\t        ";o.innerHTML=s,this.handleAdd(n,o,t,e),$(o).one(animationendEvent,function(){$(this).removeClass("infinity-zoom-show"),window.iDrag&&iDrag.listen(o.querySelector(".icon-img"))})},handleAdd:function(e,i,t,n){var o=this,s=void 0,c=(SETTING.row,SETTING.column,infinity.get("infinity-icons"));e>=c.length?(c.push([]),_app.data.groups=c,_app.render(),s=0==e?0:400,Vue.set(n,"isAdded",!0)):(Vue.set(n,"isAdded",!0),s=0,_app.data.currentPage!=e&&(s=400)),iView.slideToPage(e,s,function(){$(".group:nth-child("+(e+1)+")").append(i),c[e].push(t),infinity.set("infinity-icons",c),o.lockAdd=!1,infinity.sendMessage("icon-handle",{type:"add"}),infinity.sendMessage("backupToCloud")})},onInitCustom:function(){var n=this;function i(t){n.custom.colors.map(function(e,i){"picker"==e.id?(e.select=!0,e.value=t,e.border=t,n.custom.selectColor=JSON.parse(JSON.stringify(e))):e.select=!1})}infinity.require("color-picker",!0).then(function(){var e=new CP(document.querySelector(".color-item-picker"));e.set("rgb(255,255,255)"),e.on("exit",function(e,i,t){}),e.on("enter",function(e,i,t){}),e.on("start",function(e){i(e)}),e.on("drag",function(e){i(e)})})},onOpenCustomAdd:function(){this.clearCustom(),this.custom.isAddDone=!1,this.custom.isShow=!0,Vue.nextTick(function(){$("#add-custom-url")[0].focus()})},onCloseCustom:function(){this.custom.isShow=!1},clearCustom:function(){var t=this;t.custom.croppedImage=null,t.custom.isShowCustomAddLoading=!1,t.custom.cusUrl="",t.custom.cusName="",t.custom.showText="",t.custom.customIconType="text",t.custom.colors.map(function(e,i){"1abc9c"==e.id?(e.select=!0,t.custom.selectColor=e):e.select=!1})},onSelectColor:function(e){"picker"!=e.id&&(this.custom.colors.map(function(e,i){e.select=!1}),e.select=!0,this.custom.selectColor=e)},selectImage:function(){var t=this;infinity.chooseFile().then(function(i){t.custom.selectColor={select:!0,id:"transparent",value:"transparent",border:"ccc",bgImage:"url(/icon/transparent.png)"},t.custom.colors.map(function(e,i){"transparent"==e.id?e.select=!0:e.select=!1}),infinity.import("cropper","body",function(e){e.show(t.custom),t.custom.customIconType="image",e.onEditImage(i,!0,function(e){t.custom.croppedImage=e})})})},editImage:function(){var i=this;infinity.import("cropper","body",function(e){e.show(i.custom)})},removeImage:function(){this.custom.customIconType="text",this.custom.croppedImage=""},inputUrl:function(){},inputName:function(){this.custom.showText=this.custom.cusName.substr(0,2).toUpperCase()},onCustomAdd:function(){var i=this;if(!i.custom.isShowCustomAddLoading){i.custom.isShowCustomAddLoading=!0;var e=infinity.isUrl(i.custom.cusUrl),t="";t=e.isValid?e.str:i.custom.cusUrl;var n={customType:i.custom.customIconType,name:i.custom.cusName,url:t,showText:i.custom.showText,bgColor:i.custom.selectColor.value,uid:infinity.randomId(900),src:""};if(i.custom.croppedImage){i.custom.isShowCustomAddLoading=!0;var o={src:i.custom.croppedImage};infinity.sendMessage("upload2Qiuniu",o,function(e){e?(n.src=e,i.onAdd(n,"custom"),i.custom.isShowCustomAddLoading=!1,i.custom.isAddDone=!0):(i.custom.isShowCustomAddLoading=!1,infinity.alert({html:infinity.i18n("add_fail_due_to_network_error"),isShowCloseBtn:!0,isShowOkBtn:!0,okBtn:infinity.i18n("got_it")}))})}else i.onAdd(n,"custom"),i.custom.isShowCustomAddLoading=!1,i.custom.isAddDone=!0}},onAddNext:function(){this.clearCustom(),this.custom.isAddDone=!1,Vue.nextTick(function(){$("#add-custom-url")[0].focus()})},onCustomAddDone:function(){this.custom.isShow=!1}}})};