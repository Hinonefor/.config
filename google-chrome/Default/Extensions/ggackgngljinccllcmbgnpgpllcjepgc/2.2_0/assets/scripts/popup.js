var backend=chrome.extension.getBackgroundPage();var loadingMessage={1:"正在登入...<span class='loading-tips'>注意:请勿与其他代理插件同时使用！</span>",8:"###,请<b class='logout'>退出重登</b>!",3:"插件正在启动...<span class='loading-tips'>注意:请勿与其他代理插件同时使用！</span>",4:"正在连接服务器...<span class='loading-tips'>注意:请勿与其他代理插件同时使用！</span>",5:"当前版本需要<b class='update website'>更新</b>！",6:"登入超时,请<b class='re-login'>重登</b>或<b class='logout'>退出</b>!",7:"账号被挤出,请<b class='logout'>退出重登</b>!"};$("#login-btn").click(function(){var data=checkLogin();if(data){backend.tryLogin=0;backend.login(data)}});function isEmail(email){var reg=/^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/;return reg.test(email)}function checkLogin(){var email=$.trim($("#login-email").val());if(email==null||email==""||!isEmail(email)){alertErrorMsg({title:"",message:"请输入正确的邮箱！"});return false}var password=$("#login-pwd").val();if(password==null||password==""){alertErrorMsg("","请输入密码！");return false}var jsonData={action:"api/login"};jsonData.userEmail=email;jsonData.password=$.md5(password);return jsonData}$("#reg-btn").click(function(){var data=checkReg();var btn=$(this);if(data&&!btn.hasClass("disabled")){btn.addClass("disabled");backend.startRequest(backend._s.web_site,data,function(result){if(result.err==99){alertErrorMsg({title:"",message:"注册失败，请联系我们！"})}else{if(result.err==0){alertInfoMsg({title:"",message:result.data})}else{$("#active-code").trigger("click");alertErrorMsg({title:"",message:result.data})}}btn.removeClass("disabled")})}});function checkReg(){var email=$.trim($("#reg-email").val());if(email==null||email==""||!isEmail(email)){alertErrorMsg({title:"",message:"请输入正确的邮箱！"});return false}var password=$("#reg-pwd").val();if(password==null||password.length<6){alertErrorMsg({title:"",message:"密码长度不得小于6！"});return false}var password2=$("#reg-pwd2").val();if(password2!=password){alertErrorMsg({title:"",message:"两次输入密码不一致！"});return false}var code=$.trim($("#reg-code").val());var authCode=$.trim($("#auth-code").val());if(authCode==null||authCode==""){alertErrorMsg({title:"",message:"请输入验证码！"});return false}var jsonData={action:"api/register"};jsonData.userEmail=email;jsonData.password=$.md5(password);jsonData.password2=$.md5(password2);jsonData.authCode=authCode;if(code!=""){jsonData.code=code}return jsonData}$("#domain-list").on("click","i.fa-edit",function(){var parent=$(this).parent().parent();var readMode=parent.find(".read-mode");readMode.addClass("hidden");var editMode=parent.find(".edit-mode");editMode.removeClass("hidden");editMode.find(".domain-input").focus();return false});$("#domain-list").on("click","i.fa-trash",function(){var parent=$(this).parent().parent();var id=parseInt(parent.attr("id"));backend.deleteDomain(id);parent.remove();return false});$("#domain-list").on("click","i.fa-check",function(){var parent=$(this).parent().parent();var readMode=parent.find(".read-mode");readMode.removeClass("hidden");var editMode=parent.find(".edit-mode");editMode.addClass("hidden");var id=parseInt(parent.attr("id"));var domain=$.trim(editMode.find(".domain-input").val().toLowerCase());if(domain==""){alertErrorMsg({title:"",message:"请输入正确域名！"})}else{if(domain!=readMode.find(".domain-text").val()){backend.updateDomain({id:id,domain:domain})}}readMode.find(".domain-text").text(editMode.find(".domain-input").val());return false});$("#domain-list").on("click","i.fa-ban",function(){var parent=$(this).parent().parent();var readMode=parent.find(".read-mode");readMode.removeClass("hidden");var editMode=parent.find(".edit-mode");editMode.addClass("hidden");editMode.find(".domain-input").val(readMode.find(".domain-text").text());return false});$("#domain-list").on("click","span.domain-text",function(){var domain=$(this).text();chrome.tabs.create({url:"http://"+domain});return false});function alertInfoMsg(data){$.notify({title:data.title,message:data.message,icon:"fa fa-check"},{type:"info"})}function alertErrorMsg(data){$.notify({title:data.title,message:data.message,icon:"fa fa-times"},{type:"danger"})}function showPage(){var status=backend.loginStatus.status;var msg=backend.loginStatus.message;switch(status){case 2:$(".overlay").hide();$(".login-content").hide();$(".main-page").show();loadPagePage();backend.removeIconWarn();showTips();break;case 1:case 3:case 4:$(".overlay").show();$(".login-content").hide();$(".main-page").show();$("#ext-loading").removeClass("hide");$("#err-loading").addClass("hide");$("#ext-loading").find(".l-text").html(loadingMessage[status]);backend.removeIconWarn();break;case 8:case 5:case 6:case 7:$(".overlay").show();$(".login-content").hide();$(".main-page").show();$("#ext-loading").addClass("hide");$("#err-loading").removeClass("hide");var mmm=loadingMessage[status].replace("###",msg);$("#err-loading").find("span").html(mmm);backend.setIconUpdate();break;default:$(".overlay").hide();$(".login-content").show();$(".main-page").hide();backend.removeIconUpdate();break}}function loadPagePage(){$("#ext-version").text(chrome.runtime.getManifest().version);
showCurrentDomain();showUserInfo();showRunModel();setSelectNode();showEnableStatus();showAutoNodeStatus();setNodeData();setDomainData()}function refreshNode(){setSelectNode();setNodeData()}function setSelectNode(){var sn=backend.PAC_Setting.currentNode;if(sn==null){$("#select-node").val("请选择节点！")}else{var autoNode=backend.PAC_Setting.getNodeModel()=="true"?"自动":"手动";var model=backend.PAC_Setting.getModel();var runModelText=$("#"+model).text();$("#select-node").val(sn.name+" ("+runModelText+"-"+autoNode+")");if(sn.type){$("#select-node").addClass("vip-node")}else{$("#select-node").removeClass("vip-node")}}}function showRunModel(){var model=backend.PAC_Setting.getModel();$(".model").find("i").remove();$('<i class="active fa fa-check-square">').appendTo($("#"+model))}var checkinTimeId;function showUserInfo(){var usr=backend.usr;var placeHolder=$("#exchang-input").attr("placeHolder");if(usr){$("#exchang-input").attr("placeHolder",placeHolder.replace("#1#",backend.extConfig.exchangeRule));$(".user-email").text(usr.userEmail);$(".free-time").text(backend.computeFreeDate());$(".vip-time").text(backend.computeVIPDate());$(".integral").text(usr.integral);$(".invite-code").text(usr.inviteCode);if(isSameDay(usr.extCheckIn,backend.getNow())){$(".checkin-btn").addClass("disabled");$(".checkin-btn").text("已签")}else{$(".checkin-btn").removeClass("disabled");$(".checkin-btn").text("签到");shakeCheckin();checkinTimeId=setInterval(shakeCheckin,3000)}showCheckinMessage();var days=parseInt(usr.integral/backend.extConfig.exchangeRule);$("#exchange-days").text(days)}}function isSameDay(checkin,now){var d1=new Date(checkin);var d2=new Date(now);if(d1.getFullYear()==d2.getFullYear()&&d1.getMonth()==d2.getMonth()&&d1.getDate()==d2.getDate()){return true}else{return false}}function showEnableStatus(){var status=backend.PAC_Setting.getEnableStatus();if(status=="true"){$("#sys-enabled").prop("checked",true)}else{$("#sys-enabled").prop("checked",false)}}function showCurrentDomain(){chrome.tabs.getSelected(function(tab){var url=tab.url;var isLocal=false;if(url.indexOf("chrome-extension://")==0||url.indexOf("chrome://")==0||url=="newtab"){isLocal=true}url=checkReturnHost(url);if(url=="127.0.0.1"||url=="localhost"){isLocal=true}$("#current-domain").val(url);var sessionObj=backend.getSessionObj(tab.id);$("#add-domain1").attr("tabId",tab.id);$("#add-domain1").removeAttr("disabled");$("#unknowDomains").remove();if(sessionObj!=null){sessionObj=$.parseJSON(sessionObj);if(sessionObj.list.length>0&&sessionObj.url==tab.url){$("#current-domain-label").text("疑似无法访问的域名：");var divTag="<div id='unknowDomains'>";for(var i=0;i<sessionObj.list.length;i++){divTag+="<input type='checkbox' checked='checked' value='"+sessionObj.list[i]+"' />"+sessionObj.list[i]+"<br/>"}divTag+="</div>";$(divTag).insertAfter($("#current-domain-label").parent());$("#add-domain1").find("i").attr("class","fa fa-plus");$("#add-domain1").attr("multi","true");$("#current-domain").val("添加选中域名到个人列表");return}}if(isLocal){$("#add-domain1").attr("disabled",true);$("#current-domain-label").text("添加当前域名到个人列表");$("#add-domain1").find("i").attr("class","fa fa-plus")}else{if(backend.isInDomainList(url)){$("#current-domain-label").text("当前域名已在系统列表或个人列表里！");var id=backend.queryUserDomainList(url);if(id){$("#add-domain1").attr("disabled",false);$("#add-domain1").attr("domain-id",id);$("#add-domain1").find("i").attr("class","fa fa-minus")}else{$("#add-domain1").attr("disabled",false);$("#add-domain1").find("i").attr("class","fa fa-plus")}}else{$("#current-domain-label").text("添加当前域名到个人列表");$("#add-domain1").attr("disabled",false);$("#add-domain1").find("i").attr("class","fa fa-plus")}}})}function setNodeData(){var ns=backend.PAC_Setting._ns;var sn=backend.PAC_Setting.currentNode;var autoNode=backend.PAC_Setting.getNodeModel();$("#node-content").html("");if(ns!=null){var nodeHtml='<li class="list-group-item radio animated-radio-button" id="node-item-#3#"><embed  class="signal-svg" src="assets/images/signal#0#.svg" type="image/svg+xml" /><img src="assets/images/flag/#1#" /><label><input type="radio" name="node" id="node-#3#"/><span class="label-text"><b>#2#</b></span></label><div class="node-desc"></div></li>';for(i=0;i<ns.length;i++){var node=nodeHtml.replace("#1#",ns[i].flag);var ping=getPing(ns[i]);node=node.replace("#0#",ping);node=node.replace("#2#",ns[i].name);node=node.replace(/#3#/g,ns[i].id);var nodeObj=$(node);if(sn!=null&&sn.id==ns[i].id){nodeObj.find("input").prop("checked",true)}if(ns[i].type==true){nodeObj.find("span").css("color","#F44336")}if(autoNode=="true"){nodeObj.addClass("disabled");nodeObj.find("input").attr("disabled","disabled")}else{nodeObj.removeClass("disabled");nodeObj.find("input").removeAttr("disabled")}if(ns[i].info==""){nodeObj.find("input").prop("checked",false);nodeObj.find("input").attr("disabled","disabled")}if(ns[i].desc&&ns[i].desc!=""&&ns[i].desc!="null"){nodeObj.find(".node-desc").html(ns[i].desc)}nodeObj.appendTo($("#node-content"))}}else{$("#node-content").html("没有节点！")
}}function setDomainData(){var ud=backend.getStorgeJson("_UD");showUserDomain(ud)}function showUserDomain(ud){$("#domain-list").html("");if(ud!=null&&ud.length>0){var domainHtml='<li class="list-group-item domain-item" id="#2#"><div class="read-mode"><i class="fa fa-trash"></i><i class="fa fa-edit"></i><span class="domain-text">#1#</span></div><div class="edit-mode hidden" ><input class="domain-input" spellcheck="false" type="text" value="#1#"><i class="fa fa-ban"></i><i class="fa fa-check"></i></div></li>';for(i=0;i<ud.length;i++){var domain=domainHtml.replace(new RegExp("#1#","gm"),ud[i].domain);domain=domain.replace("#2#",ud[i].id);$(domain).appendTo($("#domain-list"))}}else{$("#domain-list").html("没有域名！")}}function initEvent(){$("#ext-version").text("V"+chrome.runtime.getManifest().version);$("[data-toggle='tooltip']").tooltip();switchPage();switchModel();selectNode();switchEnabled();switchNodeEnabled();refreshEvent();domainOperator();queryDomain();otherAction();requestAuthCode()}function requestAuthCode(){$("#reg-link").click(function(){$("#active-code").attr("src",backend._s.web_site+"getCode?"+new Date().getTime())});$("#active-code").click(function(){$("#active-code").attr("src",backend._s.web_site+"getCode?"+new Date().getTime())})}function otherAction(){$(".logout").click(function(){backend.removeIconUpdate();backend.logout()});$("#login-pwd").keydown(function(e){var currentKey=e.which;if(currentKey==13){var data=checkLogin();if(data){backend.login(data)}return false}});$("#err-loading").on("click",".logout",function(){backend.logout();return false});$("#err-loading").on("click",".re-login",function(){backend.removeIconUpdate();backend.needReadRootFile(true);return false});$("#err-loading").on("click",".update",function(){backend.openHomePage();return false});$(".website").click(function(){backend.openHomePage();return false});$(".service").click(function(){backend.openService();return false});$(".help-page").click(function(){backend.openHelpPage();return false});$(".personal-home").click(function(){var delay=$(this).attr("delayAction");backend.openPersonalPage(delay)});$(".checkin-btn").click(function(){if(!$(this).hasClass("disabled")){backend.checkin()}});$("#exchang-btn").click(function(){var input=$("#exchang-input");var days=input.val();if(backend.extConfig.openPay){if(days==""){alertErrorMsg({title:"",message:"请输入兑换天数！"})}else{days=parseInt(days);if(days>0&&days<101){var total=days*backend.extConfig.exchangeRule;if(total>backend.usr.integral){alertErrorMsg({title:"",message:"您的积分不足！"})}else{input.val(days);backend.exchange(days)}}else{alertErrorMsg({title:"",message:"兑换天数范围在1-100之间！"})}}}else{alertErrorMsg({title:"",message:"试运营期间无需兑换！"})}});$("#not-received-email").click(function(){backend.openResendActiveEmailPage()});$("#forget-password").click(function(){backend.openResetPasswordEmailPage()});$(".model").hover(function(){$("#model-tip").show();var id=this.id;if(id=="NModel"){$("#tooltip-content").html("科学模式：只有列表里的域名会经过代理");$("#model-tip").attr("class","NModel-tip")}else{if(id=="AModel"){$("#tooltip-content").html("全局模式：访问所有的域名都会经过代理");$("#model-tip").attr("class","AModel-tip")}else{if(id=="CModel"){$("#tooltip-content").html("关闭模式：访问所有域名都不会经过代理");$("#model-tip").attr("class","CModel-tip")}}}},function(){$("#model-tip").hide()})}function queryDomain(){$("#query-domain").click(function(){var domain=$("#input-domain").val();domain=$.trim(domain);if(domain==""){setDomainData()}else{showUserDomain(backend.simpleQueryUserDomain(domain))}})}function domainOperator(){$("#add-domain1").click(function(){this.disabled="disabled";if($(this).find("i").hasClass("fa-plus")){var tabId=$(this).attr("tabId");if($(this).attr("multi")=="true"){var list=[];$("#unknowDomains input:checkbox:checked").each(function(){var domain=$.trim($(this).val().toLowerCase());if(backend.queryUserDomainList(domain)==null){list.push(domain)}});addDomains(list,parseInt(tabId))}else{var domain=$("#current-domain").val();if(tabId!=null){addDomain(domain,parseInt(tabId))}else{addDomain(domain)}}}else{var id=$(this).attr("domain-id");if(id!=null){backend.deleteDomain(parseInt(id))}}});$("#add-domain2").click(function(){var domain=$("#input-domain").val();addDomain(domain)})}function addDomain(domain,tabId){domain=$.trim(domain);if(domain==""){alertErrorMsg({title:"",message:"请输入正确域名！"})}else{backend.addDomain(domain,tabId)}}function addDomains(domains,tabId){if(domains.length==0){alertErrorMsg({title:"",message:"请选择需要添加的域名！"})}else{backend.addDomains(domains,tabId)}}function refreshEvent(){$(".refresh-user").click(function(){backend.refreshUser()});$(".refresh-node").click(function(){backend.refreshNS(true)});$(".refresh-domain").click(function(){backend.refreshDomains()})}function selectNode(){$("#node-content").on("click","li.list-group-item",function(){var node=$(this).find("input");var checked=node.prop("checked");var disabled=node.prop("disabled");if(checked==false&&disabled==false){node.prop("checked",true);var nid=parseInt(node.attr("id").replace("node-",""));
backend.PAC_Setting.changeNode(backend.PAC_Setting.getSelectNodeById(nid));backend.PAC_Setting.resetting();setSelectNode()}return false})}function switchModel(){$(".model").click(function(){var i=$(this).find("i");if(i.length==0){backend.PAC_Setting.changeModel($(this).attr("id"));showRunModel();setSelectNode()}})}function switchEnabled(){$("#enabled-span").click(function(){var checked=$("#sys-enabled").prop("checked");if(checked==true){backend.PAC_Setting.changeEnable("false")}else{backend.PAC_Setting.changeEnable("true")}})}function switchNodeEnabled(){$("#node-enabled-span").click(function(){var checked=$("#node-model").prop("checked");if(checked==true){backend.PAC_Setting.changeNodeModel("false")}else{backend.PAC_Setting.changeNodeModel("true")}setSelectNode();setNodeData()})}function showAutoNodeStatus(){var status=backend.PAC_Setting.getNodeModel();if(status=="true"){$("#node-model").prop("checked",true)}else{$("#node-model").prop("checked",false)}}function switchPage(){$(".switch-page").click(function(){var page=$(this).attr("switch-page");if(page){$(".content-page").addClass("hide");$("#"+page+"-page").removeClass("hide");$(".page-tab").removeClass("active");$("#"+page+"-tab").addClass("active")}});$(".back-home").click(backHome)}function backHome(){$(".content-page").addClass("hide");$("#home-page").removeClass("hide");$(".page-tab").removeClass("active")}function getFirstDomain(host){var parts=host.split(".");if(parts.length>=3){parts.shift();return parts.join(".")}return host}function isHostIP(host){var re=/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/;if(re.test(host)){if(RegExp.$1<256&&RegExp.$2<256&&RegExp.$3<256&&RegExp.$4<256){return true}}return false}function getURLHost(url){url=url.toLowerCase();var regex=/.*\:\/\/([^\/]*).*/;if(url.indexOf("://")==-1){url="http://"+url}var match=url.match(regex);if(typeof match!="undefined"&&null!=match){host=match[1]}return host.split(":")[0]}function checkReturnHost(url){if(url){var host=getURLHost(url);if(isHostIP(host)){return host}else{return getFirstDomain(host)}}else{return""}}function computeVIPTime(){var usr=backend.usr;if(usr!=null){var expire=usr.expireTime;var now=backend.getNow();if(now<expire){var time=(expire-now)/1000;if(time<3600){return parseInt(time/60)+"分钟"}else{if(time<86400){return parseInt(time/3600)+"小时"}else{return parseInt(time/86400)+"天"}}}else{return"0天"}}else{return"0天"}}function getPing(node){if(typeof(node.ping)=="undefined"||node.ping==-1){return 0}else{if(node.ping==1000){return -1}else{var ping=node.ping/2;if(ping+node.balance<200){return 1}else{if(ping+node.balance<300){return 2}else{if(ping+node.balance<400){return 3}else{return 4}}}}}return 0}function refreshPing(){var ns=backend.PAC_Setting._ns;if(ns!=null){for(var i=0;i<ns.length;i++){var svg=$("#node-item-"+ns[i].id).find(".signal-svg");var svgName="signal"+getPing(ns[i])+".svg";svg.attr("src","assets/images/"+svgName)}}}chrome.extension.onMessage.addListener(function(request,sender,sendResponse){var callback;try{callback=eval(request.callback);if(typeof callback==="function"){new callback(request.data)}}catch(exception){}sendResponse(request)});function showTips(){if(backend.tips.length>0){$("#tips-p").removeClass("hide");var index=parseInt(Math.random()*backend.tips.length,10);showOneTip(index)}}function showOneTip(i){if(backend.tips.length>0&&i<backend.tips.length){$("#tips-p span").html(backend.tips[i].content);$("#tips-p span").fadeIn(1000,function(){setTimeout(function(){$("#tips-p span").fadeOut(1000,function(){var index=parseInt(Math.random()*backend.tips.length,10);showOneTip(index)})},5000)})}else{if(backend.tips.length>0){var index=parseInt(Math.random()*backend.tips.length,10);showOneTip(index)}else{$("#tips-p").hide()}}}function shakeCheckin(){var $panel=$("#checkin-btn");if($panel.hasClass("disabled")){clearTimeout(checkinTimeId)}else{box_left=0;$panel.css({"left":box_left,"position":"relative"});for(var i=1;3>=i;i++){$panel.animate({left:box_left-(6-2*i)},"fast","linear");$panel.animate({left:box_left+(6-2*i)},"fast","linear")}}}function showCheckinMessage(){var usr=backend.usr;if(usr!=null){var expire=usr.expireTime;var now=backend.getNow();if(now>expire){if(isSameDay(usr.extCheckIn,now)){var ms=usr.extCheckIn+backend.extConfig.freeMins*60000;if(ms<now){$("#checkin-message b").html("您的免费时间已用完，请明天再来签到吧！");return}}else{$("#checkin-message b").html("请签到获取免费时间来使用免费节点！");$("#checkin-message span").removeClass("hide");return}}}$("#checkin-message b").html("");$("#checkin-message span").addClass("hide")}initEvent();showPage();