$.ajaxSetup({timeout:10000});var tmpMessage="WyJodHRwOi8vY2xvdWQxLmFsaWNvdWxkY2RuLmNvbS9mYXZpY29uLmljbyIsImh0dHA6Ly8xMzkuMTYyLjgzLjE0Ny9mYXZpY29uLmljbyIsImh0dHA6Ly8xNzIuMTA1LjY3LjIwNS9mYXZpY29uLmljbyJd";var root=$.parseJSON($.base64.decode(tmpMessage));var index=0;var wsIndex=0;var _r=null;var _s=null;var loginStatus={status:0,message:null};var ws=null;var usr=null;var showTime=30;var tryFreq=0;var extConfig=null;var extId=chrome.runtime.id;var range=0;var appName="Windmill";var debug="0";var tips=[];var maxLoginTimes=3;var tryLogin=0;var pingInterval=null;function needReadRootFile(bool,callback){var now=new Date().getTime()/1000;var lastAccessSec=getStorgeString("lastAccessSec");if(lastAccessSec==null||now-parseInt(lastAccessSec)>28800||bool){readRootFile(callback)}else{readRootFromLocal();if(_r==null){readRootFile()}else{autoLogin()}}}function readRootFile(callback){switchStatus(4);$.ajax({url:root[parseInt(index%root.length)]+"?"+new Date().getTime(),dataType:"text",success:function(data){data=$.base64.decode(data.split("###")[1]);index=0;parseRootFile(data);setStorgeString("_r",data);setStorgeString("lastAccessSec",new Date().getTime()/1000);autoLogin(callback)},error:function(){setTimeout(function(){index++;readRootFile()},1000)}})}function parseRootFile(data){var json=null;if(data){try{_r=$.parseJSON(data);if(typeof(_r.key)=="object"){_s=_r.key}else{_s=$.parseJSON(XXTEA.decryptFromBase64(_r.key,appName))}}catch(e){setTimeout(function(){index++;readRootFile()},1000)}}}function login(data){switchStatus(1);data.extId=extId;tryLogin++;requestApi(data,function(result){if(result.err==0){setStorgeString("_t",result.data);connectWS(result.data,true)}else{if(result.err==99){switchStatus(0);needReadRootFile(true,function(){if(tryLogin>maxLoginTimes){disptchMessage({callback:"alertErrorMsg",disptch:true,data:{title:"",message:"登入失败!请重试,或联系我们！"}})}else{login(data)}})}else{switchStatus(0);disptchMessage({callback:"alertErrorMsg",disptch:true,data:{title:"",message:result.data}})}}})}function register(data){requestApi(data,function(result){if(result.err==99){needReadRootFile(true);disptchMessage({callback:"alertErrorMsg",disptch:true,data:{title:"",message:"注册失败!请重试,或联系我们！"}})}else{disptchMessage({callback:"alertInfoMsg",disptch:true,data:{title:"",message:result.data}})}})}function autoLogin(callback){switchStatus(1);var _t=getStorgeString("_t");if(_r!=null){if(_r.ext_min_ver>parseFloat(chrome.runtime.getManifest().version)){switchStatus(5)}else{if(_t!=null){connectWS(_t)}else{switchStatus(0);if(callback){callback()}}}}else{disptchMessage({callback:"alertErrorMsg",disptch:true,data:{title:"",message:"获取系统信息失败！"}})}}function connectWS(_t,showHome){if(getStorgeString("wslock")!="true"&&(ws==null||ws.readyState!=1)){setStorgeString("wslock","true");var i=parseInt(wsIndex%_s.ext_api.length);var data=additionParms({"token":_t,lang:"zh_CN",debug:debug});var params=parseParam(data);ws=new WebSocket(_s.ext_api[i]+"wsEndpoint?"+params);tryFreq++;ws.onopen=function(e){switchStatus(2);setIconNormal();if(showHome){disptchMessage({callback:"backHome",disptch:true});showHome=false}};ws.onmessage=function(e){if(e&&e.data){var data=event.data;if(data=="NOT_LOGIN"){logout()}else{if(data=="FORCE_LOGOUT"){switchStatus(7);clearEXT()}else{if(data=="PING"){}else{var jsonData=$.parseJSON(data);if(jsonData.err==0){disptchMessage(jsonData.data)}else{if(jsonData.data.callback=="initEXT"){if(jsonData.err==2){clearEXT();alert(jsonData.data.message)}else{switchStatus(8,jsonData.data.message);setIconMessage()}}else{disptchMessage({callback:"alertErrorMsg",disptch:true,data:{title:"",message:jsonData.data.message}})}}}}}}};ws.onclose=function(e){setStorgeString("wslock","false");setIconOff();var _t=getStorgeString("_t");if((loginStatus.status==1||loginStatus.status==2)&&_t!=null){switchStatus(1);usr=null;PAC_Setting.setPAC();PAC_Setting._ns=null;setTimeout(function(){wsIndex++;needReadRootFile(true)},1000)}else{if(loginStatus.status==7){clearEXT(true)}else{switchStatus(0);clearEXT(true)}}};ws.onerror=function(e){}}}function clearEXT(onClose){usr=null;extConfig=null;PAC_Setting.setPAC();PAC_Setting.clear();clearOther();if(!onClose){if(ws!=null&&ws.readyState==1){ws.close()}}}function logout(){switchStatus(0);clearEXT()}function clearOther(){removeStorge("_t");removeStorge("lastAccessSec");removeStorge("nids")}function initEXT(data){extConfig=data.config;showNotices(data.notices);if(data.needUpdate){switchStatus(5)}else{loadDomainsData();compareUser(data,true);disptchMessage({callback:"refreshPage",disptch:true})}}function refreshUser(data,replication){if(replication){sendWSMessage({callback:"compareUser",action:"refreshUser",disptch:false,other:true})}else{sendWSMessage({callback:"compareUser",action:"refreshUser",disptch:false})}}function compareUser(data,first){var newUser=data.user;if(usr==null||newUser.userEmail!=usr.userEmail||usr.expireTime!=newUser.expireTime||usr.extCheckIn!=newUser.extCheckIn||(usr.expireTime>usr.now&&newUser.now>=newUser.expireTime)||(usr.extCheckIn+extConfig.freeMins*60000>usr.now&&newUser.extCheckIn+extConfig.freeMins*60000<=newUser.now)){if(first){loadNodes(false)
}else{refreshNS(false)}}usr=data.user;range=usr.now-new Date().getTime();usr.freeMins=computeFreeTime();disptchMessage({callback:"showUserInfo",disptch:true});if(!data.other){if(data.action=="refreshUser"){disptchMessage({callback:"alertInfoMsg",disptch:true,data:{title:"",message:"刷新成功！"}})}else{if(data.action=="checkin"){disptchMessage({callback:"alertInfoMsg",disptch:true,data:{title:"",message:"签到成功！"}})}else{if(data.action=="exchange"){disptchMessage({callback:"alertInfoMsg",disptch:true,data:{title:"",message:"兑换成功！"}})}}}}if(data.action=="checkin"||data.callback=="initEXT"){if(usr.freeMins>0&&extConfig.openPay){setTimeout(function(){refreshUser(null,true)},usr.freeMins*60000)}var leftVIP=usr.expireTime-getNow();if(leftVIP>0&&leftVIP<86400000){setTimeout(function(){refreshUser(null,true)},leftVIP)}}}function loadNodes(showMessage){sendWSMessage({callback:"showNodes",action:"loadNodes",disptch:false,other:showMessage})}function refreshDomains(){sendWSMessage({callback:"showDomains",action:"loadAllDomains",disptch:false})}function showDomains(data){if(data.sysDomains){PAC_Setting.setSDS(data.sysDomains)}if(data.userDomains){PAC_Setting.setUDS(data.userDomains)}PAC_Setting.convertDS();PAC_Setting.resetting();disptchMessage({callback:"setDomainData",disptch:true});disptchMessage({callback:"showCurrentDomain",disptch:true});disptchMessage({callback:"alertInfoMsg",disptch:true,data:{title:"",message:"刷新成功！"}})}function showNodes(data){if(data.nodes){PAC_Setting._ns=data.nodes;PAC_Setting.resetting();disptchMessage({callback:"refreshNode",disptch:true});if(data.other==true){disptchMessage({callback:"alertInfoMsg",disptch:true,data:{title:"",message:"刷新成功！"}})}startPing()}}function loadDomainsData(){var lastLoadSDSec=getStorgeString("lastLoadSDSec");var lastLoadUDSec=getStorgeString("lastLoadUDSec");var _SD=getStorgeString("_SD");var _UD=getStorgeString("_UD");var now=new Date().getTime()/1000;var needLoadSD=false;var needLoadUD=false;if(lastLoadUDSec==null||now-parseInt(lastLoadUDSec)>28800||_UD==null){needLoadUD=true}else{PAC_Setting._uds=$.parseJSON(_UD)}if(lastLoadSDSec==null||now-parseInt(lastLoadSDSec)>259200||_SD==null){needLoadSD=true}else{PAC_Setting._sds=$.parseJSON(_SD)}if(needLoadUD&&needLoadSD){sendWSMessage({callback:"loadNDSCallback",action:"loadAllDomains",disptch:false})}else{if(needLoadUD){sendWSMessage({callback:"loadNDSCallback",action:"loadUserDomains",disptch:false})}if(needLoadSD){sendWSMessage({callback:"loadNDSCallback",action:"loadSysDomains",disptch:false})}}}function loadNDSCallback(data){var now=new Date().getTime()/1000;if(data.sysDomains){PAC_Setting.setSDS(data.sysDomains);setStorgeString("lastLoadSDSec",now)}if(data.userDomains){PAC_Setting.setUDS(data.userDomains);setStorgeString("lastLoadUDSec",now)}PAC_Setting.convertDS();PAC_Setting.resetting();disptchMessage({callback:"loadPagePage",disptch:true})}function sendWSMessage(data,success,error){if(ws!=null&&ws.readyState==1){var str=JSON.stringify(data);ws.send(str);if(success){success()}}else{if(error){error()}}}var PAC_Setting={defaultModel:"NModel",enableSysDomains:"true",currentNode:null,pac:"",_ns:null,proxy:null,init:function(){if(chrome.experimental!==undefined&&chrome.experimental.proxy!==undefined){this.proxy=chrome.experimental.proxy}else{if(chrome.proxy!==undefined){this.proxy=chrome.proxy}else{alert("Need proxy api support, please update your Chrome");return}}this.setPAC()},_convert:null,_blankList:null,setPAC:function(pac){this.pac=pac;if(!pac||pac==null||$.trim(pac)==""){this.proxy.settings.clear({scope:"regular"},function(){})}else{var pacConfig={mode:"pac_script",pacScript:{data:pac}};this.proxy.settings.set({value:pacConfig},function(){})}},getPAC:function(){return this.pac},getFirstNode:function(){if(this._ns==null){return null}else{for(var i=0;i<this._ns.length;i++){if(this._ns[i]){if(this._ns[i].info!=""){return this._ns[i]}}}}return null},changeNodeModel:function(model){if(this.getNodeModel()!=model){setStorgeString("autoNode",model);this.resetting()}},getNodeModel:function(){var autoNode=getStorgeString("autoNode");if(autoNode==null){setStorgeString("autoNode","true");autoNode="true"}return autoNode},getBestNode:function(){if(this._ns==null){return null}else{var tmp=null;for(var i=0;i<this._ns.length;i++){if(this._ns[i]){if(this._ns[i].info!=""){if(tmp==null){tmp=this._ns[i]}else{if(typeof(this._ns[i].ping)!="undefined"&&typeof(tmp.ping)!="undefined"){tmp=this._ns[i].ping>=tmp.ping?tmp:this._ns[i]}else{if(typeof(this._ns[i].ping)!="undefined"){tmp=this._ns[i]}}}}}}return tmp}},getSelectNode:function(){var nodeModel=this.getNodeModel();if(nodeModel=="true"){return getWeigthBestNode(this._ns,0)}else{var nid=getStorgeString("nid");if(nid==null){return this.getFirstNode()}else{if(this._ns==null){return null}else{nid=parseInt(nid);for(var i=0;i<this._ns.length;i++){if(this._ns[i]&&this._ns[i].id==nid){if(this._ns[i].info==""){return this.getFirstNode()}else{return this._ns[i]}}}}return this.getFirstNode()}}},getSelectNodeById:function(nid){if(nid==null){return null
}else{if(this._ns==null){return null}else{for(var i=0;i<this._ns.length;i++){if(this._ns[i]&&this._ns[i].id==nid){return this._ns[i]}}}return null}},changeNode:function(obj){if(obj==null){}else{var oldNid=getStorgeString("nid");if(oldNid!=null){oldNid=parseInt(oldNid);if(oldNid!=obj.id){setStorgeString("nid",obj.id)}}else{setStorgeString("nid",obj.id)}}updateNode(obj)},generatePAC:function(model,node){if(model=="CModel"||node==null){return null}else{var info=XXTEA.decryptFromBase64(node.info,usr.inviteCode);var versionCode=extConfig.ver?extConfig.ver:parseInt(chrome.runtime.getManifest().version);if(model=="AModel"){if(this._blackList==null){this.convertDS()}var str=this._blackList==null?"{}":JSON.stringify(this._blackList);return"function FindProxyForURL(url,host){var D='DIRECT'; var info ='"+info+"'; var c = "+versionCode+"; var s='';var codes = info.split('|');for(i=0;i<codes.length;i++){s+=String.fromCharCode(parseInt(codes[i]) - c);}host=host.toLowerCase();var node="+str+";var hostParts = host.split('.');for(var d=hostParts.length-1;d>=0;d--){var part=hostParts[d];node=node[part];if(node == undefined||node==1){break;}} if(node==1){return D;}return s;}"}else{if(this._convert==null){this.convertDS()}if(this._convert==null){return null}else{var str=JSON.stringify(this._convert);var black=this._blackList==null?"{}":JSON.stringify(this._blackList);var sb="function FindProxyForURL(url,host){var D='DIRECT';var info='"+info+"';var c="+versionCode+";var s='';var codes = info.split('|');for(i=0;i<codes.length;i++){s+=String.fromCharCode(parseInt(codes[i]) - c);}"+"host=host.toLowerCase();var node="+black+";var hostParts = host.split('.');for(var d=hostParts.length-1;d>=0;d--){var part=hostParts[d];node=node[part];if(node == undefined||node==1){break;}} if(node==1){return D;}"+"node="+str+";for(var d=hostParts.length-1;d>=0;d--){var part=hostParts[d];node=node[part];if(node == undefined||node==1){break;}} if(node==1){return s;}return D;}";return sb}}}},setUDS:function(ud){if(ud){setStorgeString("_UD",JSON.stringify(ud))}},setSDS:function(sd){if(sd){setStorgeString("_SD",JSON.stringify(sd))}},convertDS:function(){var sd=getStorgeString("_SD");var ud=getStorgeString("_UD");if(sd==null&&ud==null){this._convert=null}else{var status=this.getEnableStatus();sd=$.parseJSON(sd);this._blackList={};var whiteList={};for(var i in sd){var array=sd[i].domain.split(".");var val=array.pop();if(sd[i].type==2){this._blackList[val]=covList(this._blackList[val],array)}else{if(sd[i].type==1||typeof(sd[i].type)=="undefined"){whiteList[val]=covList(whiteList[val],array)}}}if(sd&&status=="true"){this._convert=whiteList}else{this._convert={}}if(ud){ud=$.parseJSON(ud);this._convert=this._convert==null?{}:this._convert;for(var i in ud){var array=ud[i].domain.split(".");var val=array.pop();this._convert[val]=covList(this._convert[val],array)}}}},resetting:function(){var model=this.getModel();this.currentNode=this.getSelectNode();this.changeNode(this.currentNode);var pac=this.generatePAC(model,this.currentNode);this.setPAC(pac)},clear:function(){stopPing();this._ns=null;removeStorge("_SD");removeStorge("_UD");removeStorge("model");removeStorge("nid");removeStorge("enableSD");removeStorge("lastLoadSDSec");removeStorge("lastLoadUDSec");removeStorge("autoNode")},getModel:function(){var model=getStorgeString("model");if(model!=null){return model}else{setStorgeString("model",this.defaultModel);return this.defaultModel}},changeModel:function(model){var oldModel=this.getModel();if(oldModel!=model){setStorgeString("model",model);this.resetting()}},getEnableStatus:function(){var status=getStorgeString("enableSD");if(status!=null){return status}else{return"true"}},changeEnable:function(status){var oldStatus=this.getEnableStatus();if(oldStatus!=status){setStorgeString("enableSD",status);this.convertDS();this.resetting()}},addDomain:function(domain){var ud=getStorgeString("_UD");if(ud==null){ud="[]"}ud=$.parseJSON(ud);ud.push(domain);this.setUDS(ud);this.convertDS();this.resetting()},updateDomain:function(domain){var ud=getStorgeString("_UD");if(ud==null){ud="[]"}ud=$.parseJSON(ud);for(var i=0;i<ud.length;i++){if(ud[i].id==domain.id){ud[i].domain=domain.domain;break}}this.setUDS(ud);this.convertDS();this.resetting()},addDomains:function(domains){var ud=getStorgeString("_UD");if(ud==null){ud="[]"}ud=$.parseJSON(ud);ud=ud.concat(domains);this.setUDS(ud);this.convertDS();this.resetting()},deleteDomain:function(id){var ud=getStorgeString("_UD");if(ud==null){ud="[]"}ud=$.parseJSON(ud);for(var i=0;i<ud.length;i++){if(ud[i].id==id){ud.splice(i,1);break}}this.setUDS(ud);this.convertDS();this.resetting()}};function refreshNS(showMessage){sendWSMessage({callback:"showNodes",action:"refreshns",disptch:false,other:showMessage})}function updateNode(obj){var data={action:"updateNode"};if(obj!=null){data.nodeId=parseInt(obj.id)}sendWSMessage(data)}function addDomain(domain,tabId){domain=$.trim(domain.toLowerCase());if(queryUserDomainList(domain)!=null){disptchMessage({callback:"alertErrorMsg",disptch:true,data:{title:"",message:"域名已在个人列表！"}})
}else{var data={action:"addDomain",callback:"addDomainBack",disptch:false,domain:domain,tabId:tabId};sendWSMessage(data)}}function addDomains(domains,tabId){var data={action:"addDomains",callback:"addDomainsBack",disptch:false,domains:domains.join(","),tabId:tabId};sendWSMessage(data)}function addDomainsBack(data,replication){if(replication){PAC_Setting.addDomains(data.data)}else{PAC_Setting.addDomains(data.domains);disptchMessage({callback:"alertInfoMsg",disptch:true,data:{title:"",message:"添加成功！"}});disptchMessage({callback:"showCurrentDomain",disptch:true});disptchMessage({callback:"setDomainData",disptch:true});if(data.tabId){chrome.tabs.reload(data.tabId);window.sessionStorage.removeItem(data.tabId+"")}}}function addDomainBack(data,replication){if(replication){PAC_Setting.addDomain(data.data)}else{PAC_Setting.addDomain(data.domain);disptchMessage({callback:"alertInfoMsg",disptch:true,data:{title:"",message:"添加成功！"}});disptchMessage({callback:"showCurrentDomain",disptch:true});disptchMessage({callback:"setDomainData",disptch:true});if(data.tabId){chrome.tabs.reload(data.tabId)}}}function updateDomain(data){data.action="updateDomain";data.callback="updateDomainBack";data.disptch=false;sendWSMessage(data)}function updateDomainBack(data,replication){if(replication){PAC_Setting.updateDomain(data.data)}else{PAC_Setting.updateDomain(data.domain);disptchMessage({callback:"alertInfoMsg",disptch:true,data:{title:"",message:"更新成功！"}});disptchMessage({callback:"showCurrentDomain",disptch:true});disptchMessage({callback:"setDomainData",disptch:true})}}function deleteDomain(id){var data={id:id,action:"deleteDomain",callback:"deleteDomainBack",disptch:false};sendWSMessage(data)}function deleteDomainBack(data,replication){if(replication){PAC_Setting.deleteDomain(data.data)}else{PAC_Setting.deleteDomain(data.id);disptchMessage({callback:"alertInfoMsg",disptch:true,data:{title:"",message:"删除成功！"}});disptchMessage({callback:"showCurrentDomain",disptch:true});disptchMessage({callback:"setDomainData",disptch:true})}}function queryUserDomainList(domain){var ud=getStorgeString("_UD");if(ud!=null){ud=$.parseJSON(ud);for(var i=0;i<ud.length;i++){if(domain==ud[i].domain){return ud[i].id}}}return null}function simpleQueryUserDomain(test){var array=[];var ud=getStorgeString("_UD");if(ud!=null){ud=$.parseJSON(ud);for(var i=0;i<ud.length;i++){if(ud[i].domain.indexOf(test)!=-1){array.push(ud[i])}}}return array}function isInDomainList(domain){if(PAC_Setting._convert){var node=PAC_Setting._convert;var parts=domain.toLowerCase().split(".");for(var i=parts.length-1;i>=0;i--){var part=parts[i];node=node[part];if(node==undefined||node==1){break}}if(node==1){return true}}return false}function showNotices(notices){tips=[];if(notices.length!=0){var nids=getStorgeJson("nids");if(nids==null){nids=[]}for(i=0;i<notices.length;i++){if(nids.indexOf(notices[i].id)==-1&&notices[i].type==1){showTmpNotice(notices[i]);nids.push(notices[i].id)}if(notices[i].type==2){tips.push(notices[i])}}setStorgeString("nids",JSON.stringify(nids))}else{setStorgeString("nids","[]")}}function showTmpNotice(notice){var opt={type:"basic",title:notice.title,message:notice.content,iconUrl:"/assets/images/windmill-normal-128.png"};chrome.notifications.create(opt)}function showTempNotice(data){var notice=data.notice;var opt={type:"basic",title:notice.title,message:notice.content,iconUrl:"/assets/images/windmill-normal-128.png"};chrome.notifications.create(opt)}function showOneNotice(notice){var notification=new Notification(notice.title,{body:notice.content,icon:"/assets/images/windmill-normal-128.png"})}function switchStatus(status,message){loginStatus.status=status;loginStatus.message=message;disptchMessage({callback:"showPage",disptch:true})}function requestApi(data,callback){if(typeof(_s.web_api)=="string"){startRequest(_s.web_api,data,callback)}else{pingWebApi(0,data,callback)}}function startRequest(baseUrl,data,callback){$.ajax({url:baseUrl+data.action,data:additionParms(data),dataType:"json",type:"POST",success:function(result){callback(result)},error:function(e){callback({err:99})}})}function pingWebApi(i,data,callback){if(i>=_s.web_api.length){callback({err:99})}else{$.ajax({url:_s.web_api[i]+"/favicon.ico?"+new Date().getTime(),type:"GET",success:function(){startRequest(_s.web_api[i],data,callback)},error:function(e){pingWebApi(++i,data,callback)}})}}function additionParms(data){data["from"]="extension";data["version"]=chrome.runtime.getManifest().version;data["debug"]=debug;return data}function readRootFromLocal(){var rs=getStorgeString("_r");if(rs!=null){parseRootFile(rs)}}function getStorgeString(key){return window.localStorage.getItem(key)}function removeStorge(key){return window.localStorage.removeItem(key)}function getStorgeJson(key){return $.parseJSON(window.localStorage.getItem(key))}function setStorgeString(key,value){window.localStorage.setItem(key,value)}function parseParam(param){var paramStr="";$.each(param,function(i){var k=i+"="+encodeURIComponent(param[i]==null?"null":param[i]);
paramStr+="&"+k});return paramStr.substr(1)}function disptchMessage(jsonData){if(jsonData.disptch==true){chrome.runtime.sendMessage(jsonData)}else{var callback;try{callback=eval(jsonData.callback);if(typeof callback==="function"){new callback(jsonData)}}catch(exception){console.log(exception)}}}function covList(arg0,arg1){if(arg1.length>0){if(arg0==1){return 1}if(typeof arg0=="undefined"){arg0={}}var av=arg1.pop();arg0[av]=covList(arg0[av],arg1);return arg0}else{return 1}}function getNow(){return new Date().getTime()+range}function computeFreeTime(){if(usr!=null){var now=getNow();var checkIn=usr.extCheckIn;var ms=checkIn+extConfig.freeMins*60000-now;if(ms>0&&(now>usr.expireTime)){return parseInt(ms/60000)}else{return 0}}else{return 0}}function checkin(){sendWSMessage({callback:"compareUser",action:"checkin",disptch:false})}function exchange(days){sendWSMessage({callback:"compareUser",action:"exchange",disptch:false,exchangeDays:days})}function openHomePage(){if(_s!=null){chrome.tabs.create({url:_s.web_site})}else{disptchMessage({callback:"alertErrorMsg",disptch:true,data:{title:"",message:"获取系统信息失败！"}})}}function openService(){chrome.tabs.create({url:"https://tawk.to/chat/5db81f8f154bf74666b68296/default"})}function openHelpPage(){if(_s!=null){chrome.tabs.create({url:_s.web_site+"/help.html"})}else{disptchMessage({callback:"alertErrorMsg",disptch:true,data:{title:"",message:"获取系统信息失败！"}})}}function openResendActiveEmailPage(){if(_s!=null){chrome.tabs.create({url:_s.web_site+"/resentEmail.jsp?action=activeEmail"})}else{disptchMessage({callback:"alertErrorMsg",disptch:true,data:{title:"",message:"获取系统信息失败！"}})}}function openResetPasswordEmailPage(){if(_s!=null){chrome.tabs.create({url:_s.web_site+"/resentEmail.jsp?action=resetEmail"})}else{disptchMessage({callback:"alertErrorMsg",disptch:true,data:{title:"",message:"获取系统信息失败！"}})}}function openPersonalPage(delayAction){var _t=getStorgeString("_t");if(_s!=null&&_t!=null){var data={};data.token=_t;data.locale="zh_CN";if(delayAction){data.delayAction=delayAction}chrome.tabs.create({url:_s.web_site+"api/homePage?"+parseParam(data)})}else{disptchMessage({callback:"alertErrorMsg",disptch:true,data:{title:"",message:"获取系统信息失败！"}})}}function isValidLocation(location){if(extConfig!=null&&extConfig.homeLinks){if(extConfig.homeLinks.indexOf(location)>-1){return true}}return false}function encodePAC(request,replication){var data={node:PAC_Setting.getSelectNode(),model:PAC_Setting.getModel(),pac:PAC_Setting.getPAC(),versionCode:extConfig.ver?extConfig.ver:parseInt(chrome.runtime.getManifest().version)};if(request.callback){request.data=XXTEA.encryptToBase64(JSON.stringify(data),extId);chrome.tabs.sendMessage(request.senderId,request)}}chrome.extension.onMessage.addListener(function(request,sender,sendResponse){if(request.action=="replication"){request.senderId=sender.tab.id;var callback;try{callback=eval(request.call);if(typeof callback==="function"){new callback(request,true)}}catch(exception){console.log(exception)}}});function setIconOff(){chrome.browserAction.setIcon({path:"/assets/images/windmill-error-24.png"})}function setIconWarn(tabId,text){setTimeout(function(){chrome.browserAction.setBadgeText({text:text+"",tabId:tabId});chrome.browserAction.setBadgeBackgroundColor({color:"#2196f3"})},100)}function setIconMessage(){setTimeout(function(){chrome.browserAction.setBadgeText({text:"!"});chrome.browserAction.setBadgeBackgroundColor({color:"#2196f3"})},100)}function setIconUpdate(){setTimeout(function(){chrome.browserAction.setBadgeText({text:"U"});chrome.browserAction.setBadgeBackgroundColor({color:"#2196f3"})},100)}function removeIconUpdate(){setTimeout(function(){chrome.browserAction.setBadgeText({text:""});chrome.browserAction.setBadgeBackgroundColor({color:"#2196f3"})},100)}function removeIconWarn(tabId){chrome.browserAction.setBadgeText({text:"",tabId:tabId});chrome.browserAction.setBadgeBackgroundColor({color:[0,0,0,0]})}function setIconNormal(){chrome.browserAction.setIcon({path:"/assets/images/windmill-normal-24.png"})}function stopPing(){clearInterval(pingInterval)}function startPing(){stopPing();pingHttpNodes();pingInterval=setInterval(requestPingNodes,300000)}function requestPingNodes(){refreshNS(false)}function pingHttpNodes(){if(PAC_Setting._ns!=null){pingHttpNode(0)}}function pingHttpNode(i){if(PAC_Setting._ns!=null&&i>=PAC_Setting._ns.length){if(PAC_Setting.getNodeModel()=="true"){PAC_Setting.resetting();disptchMessage({callback:"setSelectNode",disptch:true});disptchMessage({callback:"setNodeData",disptch:true})}disptchMessage({callback:"refreshPing",disptch:true});return}if(PAC_Setting._ns!=null){var tmp=PAC_Setting._ns[i];if(tmp.info!=""){tmp["ping"]=-1;tmp["start"]=new Date().getTime();if(tmp.ipInfo!=null&&tmp.ipInfo!=""){var url="http://"+tmp.ipInfo+"/";$.ajax(url+"?"+new Date().getTime(),{type:"get",success:function(data){tmp["ping"]=new Date().getTime()-tmp["start"];pingHttpNode(++i)},error:function(error){if(error&&error.status==408){tmp["ping"]=10000
}else{tmp["ping"]=new Date().getTime()-tmp["start"]}pingHttpNode(++i)}})}else{pingHttpNode(++i)}}else{tmp["ping"]=-1;pingHttpNode(++i)}}}(function startExt(){try{chrome.privacy.network.webRTCMultipleRoutesEnabled.set({"value":false});chrome.privacy.network.webRTCNonProxiedUdpEnabled.set({"value":false});chrome.privacy.network.webRTCIPHandlingPolicy.set({value:"disable_non_proxied_udp"})}catch(e){console.log(e)}initWebRequest();switchStatus(3);PAC_Setting.init();setStorgeString("wslock","false");needReadRootFile();setIconOff()})();function checkReturnHost(url){if(url){var host=getURLHost(url);if(isHostIP(host)){return host}else{return getFirstDomain(host)}}else{return""}}function getURLHost(url){url=url.toLowerCase();var regex=/.*\:\/\/([^\/]*).*/;if(url.indexOf("://")==-1){url="http://"+url}var match=url.match(regex);if(typeof match!="undefined"&&null!=match){host=match[1]}return host.split(":")[0]}function getFirstDomain(host){var parts=host.split(".");if(parts.length>=3){parts.shift();return parts.join(".")}return host}function isHostIP(host){var re=/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/;if(re.test(host)){if(RegExp.$1<256&&RegExp.$2<256&&RegExp.$3<256&&RegExp.$4<256){return true}}return false}chrome.tabs.onRemoved.addListener(function(tabId,removeInfo){window.sessionStorage.removeItem(tabId+"")});chrome.tabs.onActivated.addListener(function(obj){if(obj.tabId>0){noticeAction(obj.tabId)}});function initWebRequest(){chrome.webRequest.onBeforeRequest.addListener(function(obj){refreshSessionStorage();if(obj.tabId!=-1&&obj.url.indexOf("chrome-extension://")!=0){var host=checkReturnHost(obj.url);var jsonData=window.sessionStorage.getItem(""+obj.tabId);if(jsonData&&jsonData.url==obj.url){jsonData.timestamp=obj.timeStamp;if(jsonData.list.length>0){noticeAction(obj.tabId)}}else{noticeAction(obj.tabId);jsonData={tabId:obj.tabId,host:host,timestamp:obj.timeStamp,list:[],url:obj.url}}window.sessionStorage.setItem(obj.tabId+"",JSON.stringify(jsonData))}},{urls:["<all_urls>"],types:["main_frame"]});try{chrome.webRequest.onErrorOccurred.addListener(function(obj){if(isInErrors(obj.error)){var host=checkReturnHost(obj.url);if(host&&host!=""){var data=window.sessionStorage.getItem(""+obj.tabId);if(data){var jsonData=$.parseJSON(data);if(jsonData&&jsonData!=null){if(!isInDomainList(host)&&!isInList(host,jsonData.list)&&obj.timeStamp>jsonData.timestamp&&PAC_Setting.getModel()==PAC_Setting.defaultModel&&loginStatus.status==2){jsonData.list.push(host);if(usr){var unknowHost=XXTEA.encryptToBase64(host,usr.userEmail);sendWSMessage({action:"addUnknow",data:unknowHost})}}}if(jsonData.list.length>0){noticeAction(obj.tabId)}data=JSON.stringify(jsonData);window.sessionStorage.setItem(obj.tabId+"",data)}}}},{urls:["<all_urls>"],types:["main_frame","sub_frame","stylesheet","script","image","object","xmlhttprequest","other"]})}catch(e){console.log(e)}chrome.webRequest.onCompleted.addListener(function(obj){if(obj.tabId>0){noticeAction(obj.tabId)}},{urls:["<all_urls>"],types:["main_frame","xmlhttprequest"]});chrome.webRequest.onAuthRequired.addListener(function(details){if(!details.isProxy){return{}}if(extConfig.usr&&extConfig.pd){var auth={authCredentials:{username:extConfig.usr,password:extConfig.pd}};return auth}else{return{}}},{urls:["<all_urls>"]},["blocking"]);chrome.webRequest.onBeforeSendHeaders.addListener(function(details){var headers=details.requestHeaders;var value="";for(var i=0;i<headers.length;i++){if(headers[i].name.toLowerCase()=="user-agent"){value=headers[i].value+" chrome-extension"+(extConfig?extConfig.filter?extConfig.filter:"":"");headers.splice(i,1);break}}details.requestHeaders.push({name:"User-Agent",value:value});return{requestHeaders:details.requestHeaders}},{urls:["<all_urls>"]},["blocking","requestHeaders"])}function noticeAction(tabId){chrome.tabs.query({},function(tabs){for(var i in tabs){var tab=tabs[i];if(tab.id==tabId){var data=window.sessionStorage.getItem(tabId+"");if(data){var jsonData=$.parseJSON(data);if(tab.url==jsonData.url&&jsonData.list.length>0&&PAC_Setting.getModel()==PAC_Setting.defaultModel&&loginStatus.status==2){setIconWarn(tabId,jsonData.list.length);disptchMessage({callback:"showCurrentDomain",disptch:true})}else{removeIconWarn(tabId)}}else{removeIconWarn(tabId)}return}}window.sessionStorage.removeItem(tabId+"")})}function refreshSessionStorage(){var len=len=window.sessionStorage.length;for(var i=0;i<len;i++){var tabId=window.sessionStorage.key(i);var intId=parseInt(tabId);try{chrome.tabs.get(intId,function(tab){if(!tab||tab==null){window.sessionStorage.removeItem(tabId)}})}catch(e){window.sessionStorage.removeItem(tabId)}}}function getSessionObj(tabId){return window.sessionStorage.getItem(tabId+"")}function isInErrors(error){for(var i in errors){if(errors[i]==error){return true}}return false}function isInList(str,list){for(var i in list){if(list[i]==str){return true}}return false}Date.prototype.Format=function(fmt){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S":this.getMilliseconds()};
if(/(y+)/.test(fmt)){fmt=fmt.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var k in o){if(new RegExp("("+k+")").test(fmt)){fmt=fmt.replace(RegExp.$1,(RegExp.$1.length==1)?(o[k]):(("00"+o[k]).substr((""+o[k]).length)))}}return fmt};function computeVIPDate(){if(usr!=null){var expire=usr.expireTime;if(expire==0){return"无"}else{if(expire<getNow()){return"已到期"}else{var date=new Date();date.setTime(expire-getNow()+date.getTime());return date.Format("yyyy-MM-dd hh:mm:ss")}}}else{return"无"}}function computeFreeDate(){if(usr!=null){var checkIn=usr.extCheckIn;if(checkIn==0){if(usr.expireTime>getNow()){return"签到获取积分"}else{return"签到获取免费时间"}}else{if(usr.expireTime>getNow()){return"签到获取积分"}else{var ms=checkIn+extConfig.freeMins*60000;if(ms<getNow()){return"已到期"}else{var date=new Date();date.setTime(ms-getNow()+date.getTime());return date.Format("yyyy-MM-dd hh:mm:ss")}}}}else{return"签到获取积分"}}function getBestWeight(nodes,minWeight){if(nodes==null){return null}else{var tmp=null;for(var i=0;i<nodes.length;i++){if(nodes[i]&&nodes[i].info&&nodes[i].info!=""){if(tmp==null&&nodes[i].weight>minWeight){tmp=nodes[i]}else{if(nodes[i].weight>minWeight&&tmp.weight>nodes[i].weight){tmp=nodes[i]}}}}return tmp}}function getNodesByWeight(nodes,weight){if(nodes==null){return null}else{var list=[];for(var i=0;i<nodes.length;i++){if(nodes[i]&&nodes[i].info&&nodes[i].info!=""){if(weight==nodes[i].weight){list.push(nodes[i])}}}return list}}function getWeigthBestNode(nodes,minWeight){if(nodes==null){return null}else{var weightNode=getBestWeight(nodes,minWeight);if(weightNode==null){return getPingNode(nodes)}else{var wnodes=getNodesByWeight(nodes,weightNode.weight);if(wnodes!=null&&wnodes.length>0){var fullNodes=getFullNodes(wnodes,0);if(fullNodes!=null&&fullNodes.length>0){var bestNode=getPingNode(fullNodes);if(bestNode==null){return getPingNode(nodes)}else{return bestNode}}else{return getWeigthBestNode(nodes,weightNode.weight)}}else{return getWeigthBestNode(nodes,weightNode.weight)}}}}function getFullNodes(nodes,full){if(full>1){return null}else{var list=[];for(var i=0;i<nodes.length;i++){if(nodes[i].full==full){list.push(nodes[i])}}if(list.length==0){return getFullNodes(nodes,++full)}else{return list}}}function getPingNode(nodes){if(nodes==null){return null}else{var tmp=null;for(var i=0;i<nodes.length;i++){if(nodes[i]&&nodes[i].info&&nodes[i].info!=""){if(tmp==null){tmp=nodes[i]}else{if(typeof(nodes[i].ping)!="undefined"&&typeof(tmp.ping)!="undefined"){tmp=nodes[i].ping>=tmp.ping?tmp:nodes[i]}else{if(typeof(nodes[i].ping)!="undefined"){tmp=nodes[i]}}}}}return tmp}}var errors=["net::ERR_CONNECTION_TIMED_OUT","net::ERR_CONNECTION_FAILED","net::ERR_NAME_NOT_RESOLVED","net::ERR_CONNECTION_ABORTED","net::ERR_INTERNET_DISCONNECTED","net::ERR_ADDRESS_INVALID","net::ERR_ADDRESS_UNREACHABLE","net::ERR_NAME_RESOLUTION_FAILED","net::ERR_NETWORK_ACCESS_DENIED","net::ERR_TEMPORARILY_THROTTLED","net::ERR_INVALID_URL","net::ERR_CONNECTION_RESET","net::ERR_PROXY_CONNECTION_FAILED","net::ERR_CONNECTION_REFUSED"];