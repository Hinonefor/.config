'use strict';Registry.require("promise statistics helper xmlhttprequest uri convert tools".split(" "),()=>{const x=rea.FEATURES,h=Registry.get("promise");let E,F;const v=Registry.get("uri"),y=Registry.get("helper"),z=Registry.get("convert"),A=Registry.get("tools"),B=Registry.get("statistics");let G;const L=A.createQueue(1),I=f=>{const c=h();z.blob2str(f,(a,g)=>{g?c.reject(g):c.resolve(a)});return c.promise()},p=(f,c)=>(f=(f?f.split("/"):[]).concat(c?[c]:[]).join("/"))?("/"==f.substr(0,1)?"":"/")+
f:"",M=(f,c)=>{c=new c(f);Object.keys(f).forEach(a=>{const g=Object.getOwnPropertyDescriptor(f,a);if(g.get){const r={get:g.get,enumerable:!0};g.set&&(r.set=g.set);Object.defineProperty(c,a,r)}else c[a]=c[a]||f[a]});Object.keys(c).forEach(a=>{const g=Object.getOwnPropertyDescriptor(c,a);g.get||g.set||(f[a]=f[a]||c[a])});f.config=c.config=y.assign(f.config||{},c.config||{});return c},C=function(f){let c={type:f,extend:function(a){return c=M(c,a)},request:function(a){const c=()=>{const c=h(),e=d=>{console.log("rest service: request failed",
d);c.reject(d)},g="xml"===a.responseType,n="headers"===a.responseType;(g||n)&&delete a.responseType;F(a,{onload:function(d){if([200,201,204,207].includes(d.status)){if(g)if(a.anonymous||a.fetch){const b=new window.DOMParser;d.result=b.parseFromString(d.responseText,"text/xml")}else d.result=d.responseXML;else d.result=n?E.parseHeaders(d.responseHeaders):d.response;c.resolve(d)}else e(d)},onerror:e,ontimeout:e,onprogress:c.notify},{internal:!0});return c.promise()};return a.no_queue?c():L.add(c)},
error:function(a){let c=a.status;try{c=c+" | "+a.responseText}catch(r){}B.tC(f,"error","request: "+c)},wait:function(a){return function(){return a.apply(this,arguments).then(a=>a,a=>h.Breach(a?a.responseText||a.statusText:null))}}};return c},D=function(f){const c=f.type;let a=[],g=null,r;const e={config:{auth_prefix:"Bearer"},changes:(()=>{let a;return{listen:function(){a||(a=h(),e.watch&&e.watch.start());return a.promise()},notify:function(d){a.notify(d)}}})(),request:function(a){a.no_auth||(a.headers=
a.headers||{},a.headers.Authorization=e.config.auth_prefix+" "+e.credentials.access_token);return f.request(a)},oauth:(()=>{let a;const d={run:function(){if(r)return r;let b=h();const k=r=b.promise();a="!!"+c+"-"+y.createUUID();let m=e.credentials?e.credentials.refresh_token:null;const q=(a,d)=>{e.credentials=d;b.resolve();b=null;a&&a.close()};(()=>{if(!e.config.refresh_supported||!m)return h.Pledge();const a=h(),b=()=>{m=null;delete e.credentials.refresh_token};F({url:d.getRefreshUrl(m),fetch:!x.RUNTIME.SAFARI},
{onload:function(a){if(a=d.onUrl(a.finalUrl))a.error||!a.access_token?(B.tC(c,"error","auth refresh token: "+(a.error||"!access_token")),b()):q(null,a)},onerror:b,ondone:a.resolve});return a.promise()})().then(()=>{if(b){if(!e.config.refresh_supported)return h.Pledge();var a=h(),l=G({url:d.getRefreshUrl()});l.promise.progress(a=>{let k;b&&(k=d.onUrl(a.url))&&(k.error||!k.access_token?(B.tC(c,"error","auth refresh: "+(k.error||"!access_token")),e.config.refresh_supported=!1):q(l,k))}).always(a.resolve);
return a.promise()}}).then(()=>{if(b){var a=h(),l=G({url:d.getAuthUrl()});l.promise.progress(a=>{let k;b&&(k=d.onUrl(a.url))&&(k.error||!k.access_token?B.tC(c,"error","auth: "+(k.error||"!access_token")):q(l,k))}).always(a.resolve);return a.promise()}}).done(()=>{r=null;b&&b.reject("auth_failed")});return k},getAuthUrl:function(){return e.config.request_uri+"?"+v.hash2params({response_type:e.config.response_type,client_id:e.config.client_id,redirect_uri:e.config.redirect_uri,state:a,scope:e.config.scope})},
getRefreshUrl:function(d){return e.config.redirect_uri+"?"+v.hash2params({client_id:e.config.client_id,redirect_uri:e.config.redirect_uri,state:a,scope:e.config.scope,refresh_token:d})},onUrl:function(d){let b,c;if(d&&0===d.indexOf(e.config.redirect_uri)&&(c=v.parse(d))&&(b=v.params2hash(c))&&(b.access_token||b.error)&&b.state===a)return{uid:b.uid,access_token:b.access_token,refresh_token:b.refresh_token,error:b.error}}};return d})(),wait:function(c){return f.wait(function(){if(e.credentials.access_token)return c.apply(this,
arguments);{const d=arguments,b=h();a.push(function(){b.consume(c.apply(this,d))});e.oauth.run().done(()=>{a.forEach(a=>{a()});a=[]}).fail(a=>{b.reject(a)});return b.promise()}})}},w=x.HTML5.LOCALSTORAGE;Object.defineProperty(e,"credentials",{get:function(){if(null===g){B.tC(c,"init");if(w)try{const a=JSON.parse(w.getItem(e.config.storage_key));g={uid:a.uid,access_token:a.access_token,refresh_token:a.refresh_token}}catch(n){}g=g||{}}return g},set:function(a){if(w)try{w.setItem(e.config.storage_key,
JSON.stringify({uid:a.uid,access_token:a.access_token,refresh_token:a.refresh_token}))}catch(d){}g=a},enumerable:!0});return e},N=function(f){const c=f.type;let a=null;const g={config:{},changes:(()=>{let a;return{listen:function(){a||(a=h(),g.watch&&g.watch.start());return a.promise()},notify:function(c){a.notify(c)}}})(),request:function(a){if(!g.credentials.basic_auth)return h.Breach("Authentication failed");a.no_auth||(a.headers=a.headers||{},a.headers.Authorization="Basic "+g.credentials.basic_auth);
return f.request(a)},wait:function(a){return f.wait(function(){return a.apply(this,arguments)})}};Object.defineProperty(g,"credentials",{get:function(){null===a&&(B.tC(c,"init"),a={basic_auth:g.config.basic_auth});return a},set:function(c){a=c},enumerable:!0});return g},K=function(f){let c,a,g,r,e=null,w=null,n,d,b,k,m;const q=a=>{let d;a&&(d=a.firstChild.nextSibling?a.firstChild.nextSibling:a.firstChild);return d},u=a=>f.wait(function(){const d=arguments;return t.init().then(function(){return a.apply(this,
d)})}),l=(a,d)=>{let c,b;if((c=a.getElementsByTagNameNS("*",d)[0])&&(b=c.firstChild))return b.nodeValue},J=d=>{const b=[];d=d.getElementsByTagNameNS("*","response");for(let m=0;m<d.length;m++){var q=d[m],e=l(q,"href");e=e.replace(/\/$/,"");var k=q.getElementsByTagNameNS("*","propstat")[0].getElementsByTagNameNS("*","prop")[0];q=l(k,"getlastmodified");const O=l(k,"getetag"),u=l(k,"getcontentlength");k=k.getElementsByTagNameNS("*","resourcetype")[0].getElementsByTagNameNS("*","collection")[0];e=e.replace(new RegExp("^("+
[y.escapeForRegExpURL(a+c)+"/?",y.escapeForRegExpURL(g+c)+"/?"].join("|")+")"),"");k||(e={etag:O,name:e,modifiedTime:q?(new Date(q)).getTime():void 0,size:0<=u?u:void 0,removed:-1==u},b.push(e))}return b},H=(a,b)=>{b=b||{};b.set_current_list&&(n={});return t.request({method:"PROPFIND",url:a,headers:{"Content-Type":"text/xml; charset=UTF-8",Depth:void 0!==b.depth?b.depth:1},responseType:"xml"}).then(a=>{a=a.result;var c;if(null===a||!(c=q(a))||!c.childNodes)return h.Breach();a=J(c);b.set_current_list&&
((c=l(c,"td:cursor"))&&(d=c),a.forEach(a=>{n[a.name]=a}));return a})},P=(a,b)=>{const c={"Content-Type":"text/xml; charset=UTF-8",Depth:1,Timeout:90};b&&(c.Cursor=b);return t.request({method:"SUBSCRIBE",url:a,headers:c,responseType:"xml",no_queue:!0}).then(a=>{a=a.result;var b;if(null===a)return h.Pledge({changes:[],cursor:d});if(!(b=q(a))||!b.childNodes)return h.Breach();a=J(b);b=l(b,"td:cursor");return{changes:a,cursor:b}})};var t={config:{watch_interval:36E5},request:function(a){a.headers=a.headers||
{};a.headers["User-Agent"]="Tampermonkey";a.headers.Cookie="";return f.request.apply(this,arguments).then(a=>a,b=>{if(!b||[403,500].includes(b.status))return a.backoff=2*(a.backoff||1E3),A.sleep(a.backoff).then(()=>t.request(a));if(404==b.status)return h.Pledge(b);t.error(b);return h.Breach(b)})},init:function(){if(r)return r;c=p(t.config.root,t.config.path);a=t.config.url||"";"/"==a.slice(-1)&&(a=a.slice(0,-1));g=v.parse(a).pathname;"/"==g.slice(-1)&&(g=g.slice(0,-1));const b=h();r=b.promise();const d=
a+c;t.request({method:"OPTIONS",url:a,responseType:"headers"}).done(a=>{a=a.result;let b;a&&(b=a["access-control-allow-methods"])&&b.includes("EDITOR")&&(m=!0)}).always(()=>{H(d,{depth:0}).done(b.resolve).fail(()=>{const d=[];h.onebyone(c.split("/").filter(a=>a).map(b=>{d.push(b);const c=d.join("/");return()=>t.request({method:"MKCOL",url:a+"/"+c,headers:{"Content-Type":"text/xml; charset=UTF-8"},responseType:"xml"})})).done(b.resolve).fail(b.reject)})});return r},list:u(b=>H(a+c,{set_current_list:!0}).then(a=>
{const d={};return a.map(a=>{if(!b){if(d[a.name])return;d[a.name]=!0}return{name:a.name,size:a.size||0,id:a.id,etag:a.etag,md5:a.md5Checksum,modified:a.modifiedTime,precision:1E3,removed:a.removed}}).filter(a=>a)})),get:u(b=>t.request({method:"GET",url:a+p(c,b.name||b),headers:{"Content-Type":"text/xml; charset=UTF-8"},responseType:"arraybuffer"}).then(a=>new Blob([a.result]))),put:u((b,d,l)=>{const q=b.name||b;let k,m,u;b={"Content-Type":"application/octet-stream"};const g=null===w;l&&l.lastModified&&
(k=l.lastModified,u=(new Date(l.lastModified)).toISOString(),m=l.lastModified/1E3,w||g)&&(b["X-OC-Mtime"]=m);return t.request({method:"PUT",url:a+p(c,q),headers:b,data_type:"typified",data:{type:"raw",value:d},responseType:"headers"}).then(b=>{if((b=b.result)&&g){let a;w="accepted"==b["x-oc-mtime"]||b.date&&(a=(new Date(b.date)).getTime())&&(a==k||a==Math.floor(m))?!0:!1}if(!w&&!e&&u)return t.request({method:"PROPPATCH",url:a+p(c,q),headers:{"Content-Type":"text/xml; charset=UTF-8"},responseType:"xml",
data:['<?xml version="1.0"?><d:propertyupdate xmlns:d="DAV:"><d:set><d:prop>',"<d:getlastmodified>"+u+"</d:getlastmodified>","</d:prop></d:set></d:propertyupdate>"].join("")}).then(a=>{a=a.result;let b,d,c;a&&(b=a.childNodes[0])&&(d=b.getElementsByTagNameNS("*","status")[0])&&(c=d.firstChild.nodeValue)&&-1!=c.search(/HTTP\/[0-9\.]+ 403/)&&(console.warn("WebDAV: no way to set file modification date! This might cause redundant up and downloads."),e=!0)},()=>{console.warn("WebDAV: no way to set file modification date! This might cause redundant up and downloads.");
e=!0})})}),delete:u(b=>t.request({method:"DELETE",url:a+p(c,b.name||b),headers:{"Content-Type":"text/xml; charset=UTF-8"}})),watch:{start:function(){if(!b){b=!0;var l=null,q=()=>{k=null;if(b)if(!1===l){const b=n;H(a+c,{set_current_list:!0}).then(()=>{b&&(Object.keys(b).forEach(a=>{const d=n[a];a=b[a];d?a.modifiedTime!=d.modifiedTime&&f.changes.notify({time:d.modifiedTime,name:d.name}):f.changes.notify({time:Date.now(),name:a.name,removed:!0})}),Object.keys(n).forEach(a=>{b[a]||(a=n[a],f.changes.notify({time:a.modifiedTime,
name:a.name}))}))}).fail(a=>{console.warn("WebDAV: file changes check failed",a)}).always(()=>{k=window.setTimeout(q,t.config.watch_interval)})}else{let b=100;P(a+c,d).then(a=>{const c=a.changes;d=a.cursor;b=1;c.forEach(a=>{f.changes.notify({time:a.modifiedTime,name:a.name,removed:a.removed})})},()=>{if(null===l)l=!1;else return b*=2,A.sleep(b)}).always(q)}};u(()=>{if(!b)return h.Breach();q();return h.Pledge()})()}},stop:function(){b=!1;k&&(window.clearTimeout(k),k=null)}},getRemoteUrl:function(b){if(m)return a+
p(c,b)+"?method=editor#bypass=true"},getRemoteDomains:function(){return[v.parse(a).origin.replace(/^.*:\/\//,"")]}};return t};Registry.register("cloud","7c765150",{init:function(f,c,a){G=f;E=Registry.get("xmlhttprequest",c,a);F=E.run},drive:function(){let f,c;(f=x.HTML5.LOCALSTORAGE)&&(c=f.getItem("dropbox_poll_interval"))||(c=18E5);return(new C("drive")).extend(D).extend(function(a){let g,f;const e={config:{redirect_uri:"https://auth.tampermonkey.net/oauth.php",refresh_supported:!0,request_uri:"https://accounts.google.com/o/oauth2/v2/auth",
client_id:"408438522028-3cgn3t3jas3fak7isbnfod1q4h15g2fv.apps.googleusercontent.com",storage_key:"gd_config",scope:"https://www.googleapis.com/auth/drive.appdata",response_type:"token",watch_interval:c},request:function(c){return a.request.apply(this,arguments).then(a=>a,a=>{if(!a||[403,500].includes(a.status))return c.backoff=2*(c.backoff||1E3),A.sleep(c.backoff).then(()=>e.request(c));if([400,401].includes(a.status)){if(console.warn("Google Drive: authentication error",a),delete e.credentials.access_token,
!c.retry_auth)return c.retry_auth=!0,e.oauth.run().then(()=>e.request(c))}else if(404==a.status)return h.Pledge(a);e.error(a);return h.Breach(a)})},list:a.wait(a=>{let c=[];const d=h(),b=a=>"https://www.googleapis.com/drive/v3/files?"+v.hash2params({spaces:"appDataFolder",pageToken:a,orderBy:"modifiedTime desc",fields:"nextPageToken, files(id, size, name, modifiedTime, md5Checksum)",pageSize:500}),k=a=>e.request({method:"GET",url:a,headers:{"Content-Type":"application/json"}}).then(a=>{a=(a=a.result)?
JSON.parse(a):{files:[]};c=c.concat(a.files);if(a.nextPageToken)return k(b(a.nextPageToken));d.resolve(c)});k(b());return d.promise().then(b=>{const d={};return b.map(b=>{if(!a){if(d[b.name])return;d[b.name]=!0}return{name:b.name,size:b.size||0,id:b.id,md5:b.md5Checksum,modified:(new Date(b.modifiedTime)).getTime()}}).filter(a=>a)})}),get:a.wait(a=>e.request({method:"GET",url:"https://www.googleapis.com/drive/v3/files/"+(a.id||a)+"?"+v.hash2params({spaces:"appDataFolder",alt:"media"}),responseType:"arraybuffer"}).then(a=>
new Blob([a.result]))),put:a.wait((a,c,d)=>{const b=a.name||a,k=a.id,m=y.createUUID();return h.Pledge().then(()=>{if(c)return I(c)}).then(a=>{const c=d&&d.lastModified?(new Date(d.lastModified)).toISOString():void 0,l=[];l.push("--"+m);l.push("Content-Type: application/json");l.push("");l.push(JSON.stringify({name:b,parents:k?void 0:["appDataFolder"],modifiedTime:c}));l.push("--"+m);a&&(l.push("Content-Type: application/octet-stream"),l.push("Content-Transfer-Encoding: base64"),l.push(""),l.push(z.Base64.encode(a)),
l.push("--"+m+"--"));l.push("");return e.request({method:k||!a?"PATCH":"POST",url:"https://www.googleapis.com/"+(a?"upload/":"")+"drive/v3/files"+(k?"/"+k:"")+"?"+v.hash2params({uploadType:"multipart"}),headers:{"Content-Type":"multipart/related; boundary="+m},data:l.join("\r\n")})})}),delete:a.wait(a=>e.request({method:"DELETE",url:"https://www.googleapis.com/drive/v3/files/"+(a.id||a)+"?"+v.hash2params({spaces:"appDataFolder"}),headers:{"Content-Type":" application/json"}})),revoke:a.wait(()=>{const c=
e.credentials.access_token;return c?a.request({method:"GET",url:"https://accounts.google.com/o/oauth2/revoke?"+v.hash2params({token:c})}):h.Breach()}),compare:function(a,c){const d=h();let b;(b=a.md5)&&b==z.MD5(c,"utf-8")?d.resolve(!0):d.resolve(!1);return d.promise()},watch:{start:function(){if(!g){g=!0;var c,n=()=>{f=null;g&&e.request({method:"GET",url:"https://www.googleapis.com/drive/v3/changes/?"+v.hash2params({pageToken:c,spaces:"appDataFolder",pageSize:1E3,includeRemoved:!0}),headers:{"Content-Type":" application/json"}}).then(d=>
{d=d.result;if(!g)return h.Breach();const b=d?JSON.parse(d):{};if(!(c=b.newStartPageToken))return console.warn("Google Drive: watch token error",d),e.watch.stop();b.nextPageToken&&console.warn("Google Drive: too much changes",d);(b.changes||[]).forEach(b=>{let c,d;"file"===b.type&&(d=b.file)&&(c=Date.parse(b.time),isNaN(c)&&(c=Date.now()),a.changes.notify({id:d.id,time:c,name:d.name,removed:b.removed}))})}).fail(a=>{console.warn("Google Drive: file changes check failed",a)}).always(()=>{f=window.setTimeout(n,
e.config.watch_interval)})};a.wait(()=>g?e.request({method:"GET",url:"https://www.googleapis.com/drive/v3/changes/startPageToken",headers:{"Content-Type":" application/json"}}).then(a=>{a=a.result;if(!(c=(a?JSON.parse(a):{}).startPageToken))return console.warn("Google Drive: watch token error",a),e.watch.stop();n()}):h.Breach())()}},stop:function(){g=!1;f&&(window.clearTimeout(f),f=null)}}};return e})},dropbox:function(f){const c=f.path||"";let a,g;(a=x.HTML5.LOCALSTORAGE)&&(g=a.getItem("dropbox_poll_interval"))||
(g=18E5);return(new C("dropbox")).extend(D).extend(function(a){let e,f,n,d,b=!0;const k=a=>{let d=[];const l=h(),e=a=>m.request({method:"POST",url:"https://api.dropboxapi.com/2/files/list_folder"+(a?"/continue":""),headers:{"Content-Type":" application/json"},data:{path:a?void 0:p(c),cursor:a}}).then(a=>{a=(a=a.result)?JSON.parse(a):{entries:[]};d=d.concat(a.entries);if(a.has_more&&a.cursor)return e(a.cursor);l.resolve({list:d,cursor:a.cursor})}).fail(l.reject);b?(b=!1,m.put(".version",new Blob([rea.extension.manifest.version])).then(()=>
{e(a)}).fail(l.reject)):e(a);return l.promise()};var m={config:{redirect_uri:"https://auth.tampermonkey.net/oauth.php",request_uri:"https://www.dropbox.com/oauth2/authorize",client_id:"gq3auc9yym0e21y",storage_key:"db_config",response_type:"token",watch_interval:g},request:function(b){return a.request.apply(this,arguments).then(a=>a,a=>{if(!a||[500,429].includes(a.status))return b.backoff=2*(b.backoff||1E3),A.sleep(b.backoff).then(()=>m.request(b));if([401].includes(a.status)&&(console.warn("Dropbox: authentication error",
a),delete m.credentials.access_token,!b.retry_auth))return b.retry_auth=!0,m.oauth.run().then(()=>m.request(b));m.error(a);return h.Breach(a)})},list:a.wait(a=>k().then(b=>{const c={};d=b.cursor;return b.list.map(b=>{if(!a){if(c[b.name])return;c[b.name]=!0}return{name:b.name,size:b.size,dropbox_hash:b.content_hash,modified:(new Date(b.client_modified)).getTime(),precision:1E3}}).filter(a=>a)}).always(()=>{n&&d&&(n(),n=null)})),get:a.wait(a=>m.request({method:"POST",url:"https://content.dropboxapi.com/2/files/download",
headers:{"Dropbox-API-Arg":JSON.stringify({path:p(c,a.name||a)})},responseType:"arraybuffer"}).then(a=>new Blob([a.result]))),put:a.wait((a,b,d)=>{a=a.name||a;d=d&&d.lastModified?(new Date(d.lastModified)).toISOString().match(/[^:]*:[^:]*:[^:.a-zA_Z]*/)[0]+"Z":void 0;return m.request({method:"POST",url:"https://content.dropboxapi.com/2/files/upload",headers:{"Dropbox-API-Arg":JSON.stringify({path:p(c,a),client_modified:d,mode:"overwrite"}),"Content-Type":"application/octet-stream"},data_type:"typified",
data:{type:"raw",value:b}})}),delete:a.wait(a=>m.request({method:"POST",url:"https://api.dropboxapi.com/2/files/delete",headers:{"Content-Type":" application/json"},data:{path:p(c,a.name||a)}})),compare:function(a,b){const c=h();if(window.crypto&&window.ArrayBuffer){const d=z.str2arrbuf(b,"utf-8"),e=[],l=d.byteLength;let k=1;const f=()=>{if(0===--k){let b=new window.ArrayBuffer;e.forEach(a=>{{var c=b;const d=new Uint8Array(c.byteLength+a.byteLength);d.set(new Uint8Array(c),0);d.set(new Uint8Array(a),
c.byteLength);b=d.buffer}});window.crypto.subtle.digest("SHA-256",b).then(b=>{b=Array.from(new Uint8Array(b)).map(a=>("00"+a.toString(16)).slice(-2)).join("");c.resolve(b==a.dropbox_hash)})}};for(let a=0,b=0;b<l;b+=4194304,a++)(a=>{e.push(null);k++;window.crypto.subtle.digest("SHA-256",d.slice(b,b+Math.min(4194304,l-b))).then(b=>{e[a]=b;f()},()=>{console.warn("Dropbox: unable to calculate SHA-256 hashes");c.reject()})})(a);f()}else console.warn("Dropbox: unable to calculate SHA-256 hashes"),c.reject();
return c.promise()},watch:{start:function(){if(!e){e=!0;var b=0,c=()=>{f=null;b=0;if(e){if(!d)return console.warn("Dropbox: watch token error",d),m.watch.stop();m.request({method:"POST",url:"https://notify.dropboxapi.com/2/files/list_folder/longpoll",headers:{"Content-Type":" application/json"},no_auth:!0,no_queue:!0,data:{cursor:d,timeout:180}}).then(a=>{const c=a.result;if(!e)return h.Breach();a=c?JSON.parse(c):{};a.backoff&&(b=1E3*a.backoff);return a.changes?A.sleep(6E4).then(()=>k(d)).then(a=>
(d=a.cursor)?a.list:(console.warn("Dropbox: watch token error",c),m.watch.stop())):null}).then(b=>{b&&b.forEach(b=>{let c;const d=b[".tag"];["file","deleted"].includes(d)&&(c=Date.parse(b.server_modified),a.changes.notify({id:b.id,time:c,name:b.name,removed:"deleted"==d}))})}).fail(a=>{console.warn("Dropbox: file changes check failed",a)}).always(()=>{f=window.setTimeout(c,b+m.config.watch_interval)})}};a.wait(()=>{if(!e)return h.Breach();d?c():n=c;return h.Pledge()})()}},stop:function(){e=!1;f&&
(window.clearTimeout(f),f=null)}},getRemoteDomains:function(){return["dropbox.com","dropboxapi.com"]}};return m})},onedrive:function(f){const c=f.path||"";let a,g,r;(a=x.HTML5.LOCALSTORAGE)&&(g=a.getItem("onedrive_poll_interval"))||(g=18E5);return(new C("onedrive")).extend(D).extend(function(a){let e,f;const d=a=>{const d=h();let e=[];const k=f=>b.request({method:"GET",url:f||"https://api.onedrive.com/v1.0/drive/special/approot:"+p(c)+":/children",headers:{"Content-Type":" application/json"}}).then(b=>
{b=(b=b.result)?JSON.parse(b):{value:[]};e=e.concat(b.value.map(a=>({id:a.id,name:a.name,size:a.size,sha1:a.file&&a.file.hashes?a.file.hashes.sha1Hash:void 0,modified:(new Date((a.fileSystemInfo?a.fileSystemInfo.lastModifiedDateTime:null)||a.lastModifiedDateTime)).getTime()})));if(b["@odata.nextLink"])return k(b["@odata.nextLink"]);a.set_current_list&&(r=e);d.resolve(e)});k();return d.promise()};var b={config:{redirect_uri:"https://auth.tampermonkey.net/oauth.php",request_uri:"https://login.live.com/oauth20_authorize.srf",
client_id:"000000004C1A3122",storage_key:"od_config",response_type:"token",scope:"onedrive.appfolder",watch_interval:g},getRemoteDomains:function(){return["onedrive.live.com"]},request:function(c){return a.request.apply(this,arguments).then(a=>a,a=>{if(!a)return console.warn("OneDrive: timeout"),h.Breach("Timeout");if([401].includes(a.status)){if(console.warn("OneDrive: authentication error",a),delete b.credentials.access_token,!c.retry_auth)return c.retry_auth=!0,b.oauth.run().then(()=>b.request(c))}else if(404==
a.status)return h.Pledge(a);b.error(a);return h.Breach(a)})},list:a.wait(()=>d({set_current_list:!0})),get:a.wait(a=>b.request({method:"GET",url:"https://api.onedrive.com/v1.0/drive/special/approot:"+p(c,encodeURIComponent(a.name||a))+":/content",responseType:"arraybuffer"}).then(a=>new Blob([a.result]))),put:a.wait((a,d,e)=>{a=encodeURIComponent((a.name||a).replace(/[#%<>:"|\?\*\/\\]/g,"-"));return b.request({method:"PUT",url:"https://api.onedrive.com/v1.0/drive/special/approot:"+p(c,a)+":/content",
headers:{"Content-Type":"application/octet-stream"},data_type:"typified",data:{type:"raw",value:d}}).then(a=>{const c=e&&e.lastModified?(new Date(e.lastModified)).toISOString():void 0;if(!c)return a;a=JSON.parse(a.result);return b.request({method:"PATCH",url:"https://api.onedrive.com/v1.0/drive/items/"+a.id,headers:{"Content-Type":"application/json"},data:JSON.stringify({fileSystemInfo:{lastModifiedDateTime:c}})})})}),delete:a.wait(a=>b.request({method:"DELETE",url:"https://api.onedrive.com/v1.0/drive/special/approot:"+
p(c,encodeURIComponent(a.name||a))})),watch:{start:function(){if(!e){e=!0;var c=()=>{f=null;if(e){var g=r;d({set_current_list:!0}).then(()=>{if(g){var b={},c={};r.forEach(a=>{b[a.id]=a});g.forEach(a=>{c[a.id]=a});Object.keys(c).forEach(d=>{const e=b[d];d=c[d];e?d.modified!=e.modified&&a.changes.notify({time:e.modified,name:e.name}):a.changes.notify({time:Date.now(),name:d.name,removed:!0})});Object.keys(b).forEach(d=>{c[d]||(d=b[d],a.changes.notify({time:d.modified,name:d.name}))})}}).fail(a=>{console.warn("OneDrive: file changes check failed",
a)}).always(()=>{f=window.setTimeout(c,b.config.watch_interval)})}};b.wait(()=>{if(!e)return h.Breach();c();return h.Pledge()})()}},stop:function(){e=!1;f&&(window.clearTimeout(f),f=null)}}};return b})},yandex:function(f){let c,a;(c=x.HTML5.LOCALSTORAGE)&&(a=c.getItem("yandex_poll_interval"))||(a=18E5);return(new C("yandex")).extend(D).extend(K).extend(function(c){const g=c.request;c.request=a=>(()=>{a.headers["X-Requested-With"]="XMLHttpRequest";if(window.forge_sha256&&"PUT"==a.method&&a.data&&"raw"==
a.data.type&&a.data.value){const b=h();I(a.data.value).then(b=>{a.headers.Etag=z.MD5(b);a.headers.Sha256=window.forge_sha256(b)}).always(b.resolve);return b.promise()}return h.Pledge()})().then(()=>g(a).then(a=>a,b=>b&&[401].includes(b.status)&&(console.warn("Yandex: authentication error",b),delete n.credentials.access_token,!a.retry_auth)?(a.retry_auth=!0,n.oauth.run().then(()=>g(a))):b));const e=c.init;let p;c.init=()=>{if(p)return p;const a=h();p=a.promise();n.request({method:"GET",url:"https://cloud-api.yandex.net/v1/disk/"}).done(a=>
{a=(a=a.result)?JSON.parse(a):{};a.total_space&&a.used_space&&(a.used_space+5E7>a.total_space?console.warn("Yandex: low disk space warning, only "+(a.total_space-a.used_space)+" bytes available"):console.log("Yandex: "+(a.total_space-a.used_space)+" bytes on disk available!"))}).always(()=>{a.consume(e())});return p};var n={config:y.assign({root:"/Programs/Tampermonkey",url:"https://webdav.yandex.ru",redirect_uri:"https://auth.tampermonkey.net/oauth.php",refresh_supported:!0,request_uri:"https://oauth.yandex.com/authorize",
client_id:"a591fcd2ccd248f0baa84222898065f4",storage_key:"ya_config",response_type:"token",auth_prefix:"OAuth",watch_interval:a},f),getRemoteDomains:function(){return["disk.yandex.com"]},list:function(a){return c.list(a).then(a=>a.map(a=>{a.md5=a.etag;return a}))},compare:function(a,b){const c=h();let d;(d=a.md5)&&d==z.MD5(b,"utf-8")?c.resolve(!0):c.resolve(!1);return c.promise()}};return n})},webdav:function(f){let c,a;(c=x.HTML5.LOCALSTORAGE)&&(a=c.getItem("webdav_poll_interval"))||(a=18E5);return(new C("webdav")).extend(N).extend(K).extend(function(){return{config:y.assign({root:"Tampermonkey",
watch_interval:a},f)}})}})});
