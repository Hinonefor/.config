'use strict';(function(d){"object"==typeof exports&&"object"==typeof module?d(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],d):d(CodeMirror)})(function(d){function D(a){var b=a.query;"string"==typeof b?b=new RegExp(b.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),a.caseInsensitive?"gi":"g"):b.global||(b=new RegExp(a.text,a.caseInsensitive?"gi":"g"));
return{token:function(a){b.lastIndex=a.pos;var c=b.exec(a.string);if(c&&c.index==a.pos)return a.pos+=c[0].length||1,"searching";c?a.pos=c.index:a.skipToEnd()}}}function E(){this.overlay=this.posFrom=this.posTo=this.lastPattern=this.pattern=null}function h(a){return a.state.search||(a.state.search=new E)}function m(a,b,c){var g="";if(b){var e=b.caseInsensitive;g=b.query}return a.getSearchCursor(g,c,{caseFold:e,multiline:!0})}function F(a,b,c,g,e){return a.openDialog(b,g,{value:c,selectValueOnOpen:!0,
closeOnEnter:!1,onClose:function(){n(a)},onKeyDown:e,closeOnBlur:!1,bottom:!0})}function u(a,b,c,g,e){if(a.openDialog)return a.openDialog(b,function(a,b){d.e_stop(b);return e.apply(this,arguments)},{value:g,selectValueOnOpen:!0,closeOnBlur:!1,bottom:!0,closeOnEnter:!1});e(prompt(c,g))}function G(a,b,c,g,e,d){if(a.openConfirm)return a.openConfirm(b,g,{onKeyDown:d,onClose:e,closeOnBlur:!1});if(confirm(c))g[0]()}function l(a,b){a=$(a.display.wrapper);b=void 0!==b?b:a.find(".CodeMirror-search-field").val();
var c=a.find(".CodeMirror-search-re-field").is(":checked");a=!a.find(".CodeMirror-search-case-field").is(":checked");if(c)try{var d={query:new RegExp(b,a?"i":""),text:b,caseInsensitive:a,regex:c}}catch(e){}else d={query:b,text:b,caseInsensitive:a,regex:c};d&&d.query&&("string"==typeof d.query?""!=d.query:!d.query.test(""))||(d={query:/x^/,text:""});return d}function q(a,b,c){b.pattern=c;a.removeOverlay(b.overlay,c.caseInsensitive);b.overlay=D(c);a.addOverlay(b.overlay);a.showMatchesOnScrollbar&&(b.annotate&&
(b.annotate.clear(),b.annotate=null),b.annotate=a.showMatchesOnScrollbar(c.query,c.caseInsensitive),$(a.display.wrapper).find(".CodeMirror-search-field").toggleClass("no-result",0>=b.annotate.matches.length))}function y(a,b){return""+a.query==""+b.query&&a.regex==b.regex&&a.caseInsensitive==b.caseInsensitive}function w(a,b,c,g){var e,f=h(a);if(f.pattern&&(e=l(a))){if(y(f.pattern,e))return r(a,b)}else e=e||a.getSelection()||f.lastPattern||"";"string"==typeof e&&(e=l(a,e));e.query instanceof RegExp&&
"x^"==e.query.source&&(e=null);if(c&&a.openDialog){var v=null,z=function(b,c){b=l(a);d.e_stop(c);f.pattern&&y(f.pattern,b)||(q(a,f,b),f.posFrom=f.posTo=a.getCursor());v&&(v.style.opacity=1);r(a,c.shiftKey,function(b,c){var d;3>c.line&&document.querySelector&&(d=a.display.wrapper.querySelector(".CodeMirror-dialog"))&&d.getBoundingClientRect().bottom-4>a.cursorCoords(c,"window").top&&((v=d).style.opacity=.4)})};if(!f.pattern){p(a);var x=F(a,A(e),e?e.text:"",z,function(b,c){var e=d.keyName(b),g=a.getOption("extraKeys");
e=g&&g[e]||d.keyMap[a.getOption("keyMap")][e];g=l(a);if(!(g.query instanceof RegExp&&"x^"==g.query.source))if("findNext"==e||"findPrev"==e||"findPersistentNext"==e||"findPersistentPrev"==e)d.e_stop(b),q(a,h(a),g),a.execCommand(e);else if("find"==e||"findPersistent"==e)d.e_stop(b),z(c,b)})}g&&e&&(q(a,f,e),r(a,b))}else p(a),x=u(a,A(),d.I18N.getMessage("Search_for")+":",e,function(c){c&&!f.pattern&&a.operation(function(){q(a,f,l(a));f.posFrom=f.posTo=a.getCursor();r(a,b)})});x&&t(a,{close:function(){x();
f.dialog=null}});f.dialog&&!f.dialog.initialized&&(f.dialog.initialized=!0,c=$(a.display.wrapper),c.find(".CodeMirror-search-find-button").on("click",function(){d.commands.findNext(a)}),c.find(".CodeMirror-search-find-prev-button").on("click",function(){d.commands.findPrev(a)}),c.find(".CodeMirror-search-close-button").on("click",function(){f.dialog&&f.dialog.close&&f.dialog.close()}))}function r(a,b,c){a.operation(function(){var g=h(a),e=m(a,g.pattern,b?g.posFrom:g.posTo);if(!e.find(b)&&(e=m(a,g.pattern,
b?d.Pos(a.lastLine()):d.Pos(a.firstLine(),0)),!e.find(b)))return;a.setSelection(e.from(),e.to());a.scrollIntoView({from:e.from(),to:e.to()},20);g.posFrom=e.from();g.posTo=e.to();c&&c(e.from(),e.to())})}function n(a,b){return a.operation(function(){var c=h(a);if(!c.closing){if(c.dialog&&!b){c.closing=!0;c.dialog.close();c.closing=!1;var d=!0}c.lastPattern=c.pattern;if(!c.pattern)return d;c.pattern=null;a.removeOverlay(c.overlay);c.annotate&&(c.annotate.clear(),c.annotate=null);return!0}})}function B(a,
b,c){a.operation(function(){for(var d=m(a,b);d.findNext();)if("string"!=typeof query){var e=a.getRange(d.from(),d.to()).match(b.query);d.replace(c.replace(/\$(\d)/g,function(a,b){return e[b]}))}else d.replace(c)})}function C(a,b){if(!a.getOption("readOnly")){var c=a.getSelection()||h(a).lastPattern||"";"string"==typeof c&&(c=l(a,c));var g=h(a),e=(b?d.I18N.getMessage("Replace_all_with"):d.I18N.getMessage("Replace"))+":";p(a);var f=u(a,e+' <input type="text" style="width: 40em" class="CodeMirror-search-field" spellcheck="false"/> <input type="checkbox" style="width: auto" class="CodeMirror-search-re-field"/> <span style="color: #888" class="CodeMirror-search-hint">.*</span> <input type="checkbox" style="width: auto" class="CodeMirror-search-case-field"/> <span style="color: #888" class="CodeMirror-search-hint">Aa</span>',
e,c.text,function(c){if(c){var e=l(a);p(a);var f=u(a,'<span class="CodeMirror-search-label">'+d.I18N.getMessage("Replace_with")+':</span> <input type="text" style="width: 40em" class="CodeMirror-search-field" spellcheck="false"/>',d.I18N.getMessage("Replace_with")+":","",function(f){if(b)B(a,e,f);else{n(a);var k=m(a,e,a.getCursor("from")),h=function(){var b=k.from(),c;if(!(c=k.findNext())&&(k=m(a,e),!(c=k.findNext())||b&&k.from().line==b.line&&k.from().ch==b.ch))return;a.setSelection(k.from(),k.to());
a.showInCenter?a.showInCenter():a.scrollIntoView({from:k.from(),to:k.to()});window.setTimeout(function(){p(a);var b=G(a,'<span class="CodeMirror-search-label">'+d.I18N.getMessage("Replace_")+"</span><button>"+d.I18N.getMessage("Yes")+"</button><button>"+d.I18N.getMessage("No")+"</button><button>"+d.I18N.getMessage("Replace_All")+"</button><button>"+d.I18N.getMessage("Stop")+"</button>",d.I18N.getMessage("Replace_"),[function(){l(c)},h,function(){B(a,e,f)}],function(a){g.dialog=null},function(b){if("Esc"==
d.keyName(b))return d.e_stop(b),n(a)});b&&t(a,{close:function(){b();g.dialog=null}})},1)},l=function(a){k.replace("string"==typeof c?f:f.replace(/\$(\d)/g,function(b,c){return a[c]}));h()};h()}});f&&t(a,{close:function(){f();g.dialog=null}})}});f&&t(a,{close:function(){f();g.dialog=null}})}}var A=function(a){return'<span class="CodeMirror-search-label">'+d.I18N.getMessage("Search_for")+':</span> <input type="text" style="width: 40em" class="CodeMirror-search-field" spellcheck="false"/> <input type="checkbox" style="width: auto" class="CodeMirror-search-re-field" '+
(a&&a.regex?"checked":"")+' /> <span style="color: #888" class="CodeMirror-search-hint">.*</span> <input type="checkbox" style="width: auto" class="CodeMirror-search-case-field" '+(!a||a.caseInsensitive?"":"checked")+' /> <span style="color: #888" class="CodeMirror-search-hint">Aa</span><button class="CodeMirror-search-find-button">'+d.I18N.getMessage("Find_Next")+'</button><button class="CodeMirror-search-find-prev-button">'+d.I18N.getMessage("Find_Previous")+'</button><button class="CodeMirror-search-close-button">'+
d.I18N.getMessage("Close")+"</button>"},p=function(a){a=h(a);a.dialog&&(a.closing=!0,a.dialog.close(),a.closing=!1)},t=function(a,b){h(a).dialog=b};d.commands.find=d.commands.findPersistent=function(a){n(a,!0);w(a,!1,!0)};d.commands.findNext=d.commands.findPersistentNext=function(a){w(a,!1,!0,!0)};d.commands.findPrev=d.commands.findPersistentPrev=function(a){w(a,!0,!0,!0)};d.commands.clearSearch=n;d.commands.replace=C;d.commands.replaceAll=function(a){C(a,!0)}});
