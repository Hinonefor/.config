'use strict';var trup,init,sycl,cfgo,uris,dast,perm,blak,scbr,scma,exts,down;
Registry.require("promise statistics convert xmlhttprequest downloads tools storage uri compat parser layout helper syncinfo notify asker i18n".split(" "),()=>{const m=Registry.log,n=rea.FEATURES,na=(()=>{const d=[];let g=!0;const f=(d,f,b)=>{const a={title:d.join("\n\n")};f.path=rea.extension.getURL("images/icon"+(f.frag?"_"+f.frag:"")+".png");m.warn(d.join("\n"));rea.browserAction.setIcon({path:f.path});rea.browserAction.setTitle(a);f=(a,b,k)=>{a={name:"1",sub_menu_item:!0,pos:"left",items:[]};
a.items.push({name:d[0],image:"info"});1<d.length&&a.items.push({name:d[1]});k({items:[a],options:{enabled:!1}})};b||rea.extension.onMessage.addListener(f)};return{run:()=>{try{Registry.verify("7c765150").length&&(g=!1,f(["Tampermonkey detected that browser is caching some outdated code parts.","In order to avoid unexpected behavior TM will be kept paused until your browser was restarted."],{frag:"paused"}))}catch(h){g=!1,m.error(h.message)}if("chromeStorage"==n.DB.USE&&!n.DB.NO_WARNING){const d=
()=>{if(!u)return window.setTimeout(d,2E3);u.isWorking().fail(()=>{confirm("Tampermonkey detected that the extension storage is unreliable!\n\nUnfortunately this means that all your settings and userscripts are inaccessible at the moment.\n\nDo you want to visit the FAQ entry that explains how to recover from that?")&&rea.tabs.create({url:"https://www.tampermonkey.net/faq#Q206"},()=>{});f(["Tampermonkey detected that the extension storage is unreliable!"],{frag:"paused"},!0)})};window.setTimeout(d,
1E3)}return g},pause:f,setWarning:function(f,p,b){d.push({text:f,description:p,url:b})},getWarnings:function(){return d}}})();if(na.run()){var l=Registry.get("promise"),y=Registry.get("helper"),xa=Registry.get("tools"),N=Registry.get("statistics"),u=Registry.get("storage"),W=Registry.get("notify"),Z=Registry.get("asker"),ha=Registry.get("permission"),Q=Registry.get("layout"),z=Registry.get("uri"),d=Registry.get("i18n"),K=Registry.get("downloads"),L=xa.cache,I=Registry.get("convert");uris=z;down=K;
perm=ha;dast=u;var ya=y.createUUID(),ia={};m.debug("Starting background fred @"+ya);L.create("rundata").setOptions({timeout:5,check_interval:10,retimeout_on_get:!0}).init();L.create("regexp").setOptions({timeout:300,check_interval:120,retimeout_on_get:!0}).init();var Ca=()=>{const d=l();let w,f;const h=rea.extension.manifest.version,t=u.getSchemaVersion();let b=t;u.getVersion("0.0.0.0").then(a=>{f=a;w=D.versionCmp(h,f)==D.versionCmp.eNEWER;return u.isWiped()}).then(function(a){!w&&a&&(a=["Tampermonkey detected inconsistencies that indicate that your browser wiped the extension database!",
"You can continue to use Tampermonkey normally, but your settings and scripts might be lost. Click here to get more information.","https://www.tampermonkey.net/faq.php#Q207"],m.warn(a.join("\n")),na.setWarning.apply(this,a))}).always(()=>{let a=[],c=0;const e=()=>{if(c<a.length){const k=a[c].schema;a[c].cond(k)?a[c].fn().done(()=>{k&&(m.info("Converted database from",b,"to",k),b=k);c++;e()}).fail(()=>{d.reject()}):(c++,e())}},k=()=>{m.warn("Incognito mode detected. Database conversion can only be done in non-incognito mode! Stopping now...");
na.pause(["Tampermonkey needs to convert its database but this can't be done in incogonito mode!","Please open a non-incognito mode window and/or restart your browser."],{frag:"paused"})};a=[{cond:function(){return w&&!n.RUNTIME.FIREFOX&&!n.RUNTIME.EDGE&&"chromeStorage"==n.DB.USE&&!u.getValue(n.CONSTANTS.STORAGE.LEGACY_VERSION)&&D.versionCmp("3.5.3603",f)==D.versionCmp.eNEWER},fn:function(){const a=l();rea.extension.inIncognitoContext?(k(),a.reject()):(m.info("Update database..."),b="3.5.3603",u.migrate("sql",
"chromeStorage").done(()=>{m.info("Copied config for default usage of chrome storage");a.resolve()}).fail(()=>{a.resolve()}));return a.promise()}},{cond:function(){return w&&D.versionCmp("3.6.3650",b)==D.versionCmp.eNEWER&&D.versionCmp("3.5.3650",f)==D.versionCmp.eNEWER},fn:function(){const a=l();if(rea.extension.inIncognitoContext)k(),a.reject();else{b="3.6.3650";const c=[];[{o:"TM_config",n:n.CONSTANTS.STORAGE.CONFIG},{o:"TM_update_check",n:n.CONSTANTS.STORAGE.UPDATE},{o:"TM_version"},{o:"TM_unload_ts"}].forEach(a=>
{if(a.n){const b=u.getValue(a.o);void 0!==b&&c.push(u.setValue(a.n,b))}c.push(u.deleteValue(a.o))});let e=/@re$/;const k=[];u.listValues().forEach(a=>{-1!=a.search(e)&&(a=a.replace(e,""),k.push(a))});k.forEach(a=>{const b=u.getValue(a+"@st"),e=u.getValue(a),k=u.getValue(a+"@re"),q=u.getValue(a+"@source"),r=A.getUidByName(a)||y.createUUID();c.push(u.deleteValue(a+"@st"));c.push(u.deleteValue(a));c.push(u.deleteValue(a+"@re"));c.push(u.deleteValue(a+"@source"));e&&k&&q?(c.push(u.setValue(n.CONSTANTS.PREFIX.SCRIPT_UID+
r,a)),c.push(u.setValue(n.CONSTANTS.PREFIX.COND+r,k)),c.push(u.setValue(n.CONSTANTS.PREFIX.STORE+r,b)),c.push(u.setValue(n.CONSTANTS.PREFIX.SCRIPT+r,q)),c.push(u.setValue(n.CONSTANTS.PREFIX.META+r,e))):m.warn("invalid script entry",{source:q,meta:e,cond:k})});e=/@st$/;u.listValues().forEach(a=>{-1!=a.search(e)&&c.push(u.deleteValue(a))});l.when(c).done(()=>{m.info("Converted database from",f,"to",b);a.resolve()})}return a.promise()}},{schema:"3.7.0",cond:function(a){return D.versionCmp(a,b)==D.versionCmp.eNEWER},
fn:function(){const a=l();if(rea.extension.inIncognitoContext)k(),a.reject();else{const c=[],b=new RegExp("^"+n.CONSTANTS.PREFIX.META);u.listValues().forEach(a=>{if(-1!=a.search(b)){var e=u.getValue(a);e.options&&e.options.override&&!e.options.override.orig_run_at&&(e.options.override.orig_run_at=e.options.run_at||"document-idle",e.options.run_at=null,c.push(u.setValue(a,e)))}});l.when(c).done(()=>{a.resolve()})}return a.promise()}},{schema:"4526",cond:function(a){return w&&n.RUNTIME.SAFARI&&"chromeStorage"==
n.DB.USE&&D.versionCmp(a,b)==D.versionCmp.eNEWER},fn:function(){const a=l();if(rea.extension.inIncognitoContext)k(),a.reject();else{m.info("Update database...");const c=u.migrate("localStorage","chromeStorage").done(()=>{m.info("Copied config for default usage of setting storage")}).fail(()=>{a.resolve()});a.consume(c)}return a.promise()}},{schema:"4871",cond:function(a){return w&&D.versionCmp(a,b)==D.versionCmp.eNEWER},fn:function(){const a=l();let c,b;const e=u.getValue(n.CONSTANTS.STORAGE.CONFIG);
e&&e.scriptTemplate&&(b=g.getDefaults())&&(c=b.script_templates)&&c[0]&&c[0].value&&(c[0].value=e.scriptTemplate,delete e.scriptTemplate,u.setValue(n.CONSTANTS.STORAGE.CONFIG,e));a.resolve();return a.promise()}},{schema:"5465",cond:function(a){return D.versionCmp(a,b)==D.versionCmp.eNEWER},fn:function(){const a=l();if(rea.extension.inIncognitoContext)k(),a.reject();else{const c=u.getValue(n.CONSTANTS.STORAGE.CONFIG);c&&1==c.sync_version&&(c.sync_enabled=!1,u.setValue(n.CONSTANTS.STORAGE.CONFIG,c));
a.resolve()}return a.promise()}},{cond:function(){return w||D.versionCmp(b,t)==D.versionCmp.eNEWER},fn:function(){const a=l();u.setVersion(h,b).done(()=>{a.resolve()});return a.promise()}},{cond:function(){return w},fn:function(){m.info("First run of version "+h+"!");ja.scheduleNotification(f,"0.0.0.0"==f);return l.Pledge()}},{cond:function(){return!0},fn:function(){const a=l();d.resolve();window.setTimeout(a.resolve,n.MISC.TIMEOUT);return a.promise()}}];e()});return d.promise()},aa=(()=>({get:function(d,
w){const f=(0==d)+"#"+w;var p=L.items.rundata.getj(f);if(p)p=p.oldret;else{p=[];const h=[],b=[],a={};if(w){const c=x.determineScriptsToRun(w,!0);for(let e=0;e<c.length;e++){const k=c[e];x.isContexter(k)||0!=d&&(!0===k.options.noframes||null===k.options.noframes&&!0===k.options.override.orig_noframes)||(k.evilness&&k.evilness>=Math.min(J.SEVERITY_MAX,g.values.script_blacklist_severity)?b.push(k):k.enabled?(a[k.uuid]=w,p.push(k)):h.push(k))}}p={runners:p,disabled:h,evilness:b,script_map:a};w&&L.items.rundata.setj(f,
{frameId:d,oldret:p})}return p},answer:function(d,w){d=y.select(d,d=>d);const f=[{m:"native",t:[K.staticVars.DEFAULT,K.staticVars.NATIVE]},{m:"disabled",t:[K.staticVars.OFF]},{m:"browser",t:[K.staticVars.CHROME]}].filter(d=>{if(d.t.includes(g.values.downloads_mode))return!0}).map(d=>d.m)[0]||"disabled",p=rea.extension.inIncognitoContext;w=!p&&"off"!=g.values.external_connect&&x.validUrl(w,za.externally_connectable_reg);return{scripts:d,contexters:oa.getContexterCount(),raw:{},external_connect:w,inIncognitoContext:p,
isFirstPartyIsolation:T.fpi,downloadMode:f,enforce_strict_mode:"on"==g.values.runtime_strict_mode,statistics:N.isActive("api"),measure_scripts:g.values.debug,logLevel:g.values.logLevel,version:rea.extension.manifest.version}},getContexters:function(d,g){const f=[];g=x.determineScriptsToRun(g);for(let p=0;p<g.length;p++){const h=g[p];h.enabled&&(0==d||!0!==h.options.noframes&&(null!==h.options.noframes||!0!==h.options.override.orig_noframes))&&x.isContexter(h)&&f.push(h)}return f}}))(),C=(()=>{const d=
{};let w=1;const f=w++,h=w++,t=w++,b=w++,a=w++,c=w++,e=w++,k=()=>{const a={frames:{0:{state:f}},tabs:{reset_ts:Date.now()},scripts:{},urls:{},maps:{},contexts:{onUnload:{}},stats:{running:0,disabled:0},extra:{}};Object.defineProperties(a.urls,{length:{value:0,enumerable:!1,writable:!0,configurable:!0}});return a},B={updateStats:function(a,c,b,e){d[a].stats.running+=b;d[a].stats.disabled+=e;d[a].contexts.onUnload[c]=d[a].contexts.onUnload[c]||[];d[a].contexts.onUnload[c].push(()=>{d[a].stats.running-=
b;d[a].stats.disabled-=e});d[a].tabs.ts=Date.now()},updateMaps:function(a,c,b){let e=1;const k=(c,b)=>{const k=1===e;void 0===d[a].maps[b]&&k&&(d[a].maps[b]={count:0,all_time:0,urls:[]});k&&(d[a].maps[b].urls.push(c),d[a].maps[b].all_time++);d[a].maps[b].count+=e};y.each(b,k);d[a].contexts.onUnload[c]=d[a].contexts.onUnload[c]||[];d[a].contexts.onUnload[c].push(()=>{d[a]&&(e=-1,y.each(b,k))})},updateUrls:function(a,c,b){const e=e=>{1===e&&(void 0===d[a].urls[b]?d[a].urls[b]={frameId:c,count:0}:0===
c&&(d[a].urls[b].frameId=c));d[a].urls[b].count+=e;d[a].urls.length=-1};e(1);d[a].contexts.onUnload[c]=d[a].contexts.onUnload[c]||[];d[a].contexts.onUnload[c].push(()=>{d[a]&&e(-1)})},determine:function(a,c,b){let e;X.isAllowed(b)?e=aa.get(c,b):(m.log("This URL is filtered by the security settings:",b,"-> Do nothing!"),C.set.forbidden(a,c),e={runners:[],disabled:[],evilness:[],script_map:{}});d[a].scripts[b]=e;e.runners.forEach(b=>{b.webRequest&&ka.scripts.set(a,c,b.uuid,b.webRequest)});return e.runners.length},
run:function(a,c,b,e,d){a=[];for(c=0;c<e.length;c++)a.push(Aa.bundle({url:b},e[c]));let k;l.when(a).always(a=>{d?d(a):k=a});return k}},q={},r={},E={},S={},v={listeners:{once:{whenReady:function(a,c){if(!d[a]||d[a].frames[0].state<t)v.listeners.once.onReady(a,c);else c()},onReady:function(a,c){var b=v.listeners.add.onCommited(d=>{d===a&&(v.listeners.remove.onCommited(b),v.listeners.remove.onCompleted(e),c())}),e=v.listeners.add.onCompleted(d=>{d===a&&(v.listeners.remove.onCommited(b),v.listeners.remove.onCompleted(e),
c())})}},add:{onReset:function(a){const c=y.createUUID();q[c]=a;return c},onCommited:function(a){const c=y.createUUID();r[c]=a;return c},onCompleted:function(a){const c=y.createUUID();E[c]=a;return c},onRemoved:function(a){const c=y.createUUID();S[c]=a;return c}},remove:(()=>({onReset:function(a){delete q[a]},onCommited:function(a){delete r[a]},onCompleted:function(a){delete E[a]},onRemoved:function(a){delete S[a]}}))()},events:{reset:function(a,c){let b;n.RUNTIME.FAST_EXEC_SUPPORT&&(b=d[a])&&Object.keys(b.frames).forEach(c=>
{v.events.clean(a,c)});b=d[a]=k();b.frames[0].state=f;y.each(q,b=>{b&&b(a,c)})},response:function(a,c,b){if(g.values.enabled){var e=d[a]=d[a]||k(),q=e.frames[c]=e.frames[c]||{},r=q.state||f;0===c&&(e.tabs.response_ts=Date.now());b=z.woHash(b);r<h&&(B.determine(a,c,b),q.state=h);return(a=e.scripts[b])?a.runners.length:0}},commited:function(a,c,b){if(g.values.enabled){var e=z.parse(b);if("http:"===e.protocol||"https:"===e.protocol||"file:"===e.protocol){e=d[a]=d[a]||k();e=e.frames[c]=e.frames[c]||{};
var q=e.state||f;q>=t||(e.state=t,q<h&&(b=z.woHash(b),B.determine(a,c,b)),y.each(r,c=>{c&&c(a)}))}}},loading:function(a,c,e){if(g.values.enabled){var q=z.parse(e);if(("http:"===q.protocol||"https:"===q.protocol||"file:"===q.protocol)&&0===c&&"file:"===q.protocol){q=d[a]=d[a]||k();q.frames[c]=q.frames[c]||{};const r=q.frames[c].state||f;r>=b||(q.frames[c].state=b,r<h&&(e=z.woHash(e),B.determine(a,c,e)))}}},run:function(c,b,e,q,r){if(g.values.enabled){var f=0===b||n.RUNTIME.FAST_EXEC_SUPPORT?b:e,H=
d[c]=d[c]||k();H.frames[f]=H.frames[f]||{};var h=z.woHash(q),p=H.scripts[h];if(!p&&(m.log("tv: lazy init @ events.run("+c+", "+b+", "+e+", "+q+")"),B.determine(c,b,h),p=H.scripts[h],!p)){m.warn("tv: no script run info for tab "+c+" @ "+h,m.D?H.scripts:"");return}e=H.frames[f].state;H.frames[f].state=a;e!=a&&(B.updateMaps(c,f,p.script_map),B.updateUrls(c,f,h),B.updateStats(c,f,p.runners.length,p.disabled.length));return B.run(c,b,h,p.runners,r?a=>{v.events.clean(c,f,q);r(a)}:null)}},clean:function(a,
c,b){if(g.values.enabled){var e,k;if(e=d[a])b&&(b=z.woHash(b),delete e.scripts[b]),(k=C.get.objurl(a,c))&&URL.revokeObjectURL(k)}},complete:function(b,e,q){q=z.parse(q);if(g.values.enabled&&("http:"===q.protocol||"https:"===q.protocol||"file:"===q.protocol)){if(0===e){const r=d[b]=d[b]||k();r.frames[e]=r.frames[e]||{};const v=r.frames[e].state||f;r.frames[e].state=c;if(!C.get.empty(b)&&C.get.stats(b).running){if(v<a){m.warn("tv: no script run info!");return}"file:"===q.protocol?window.setTimeout(()=>
{rea.tabs.sendMessage(b,{method:"onLoad",frameId:e},()=>{})},500):rea.tabs.sendMessage(b,{method:"onLoad",frameId:e},()=>{})}}y.each(E,a=>{a&&a(b)})}},unload:function(a,c,b){b=0===c||n.RUNTIME.FAST_EXEC_SUPPORT?c:b;n.RUNTIME.FAST_EXEC_SUPPORT&&v.events.clean(a,c);a=d[a]=d[a]||k();a.frames[b]=a.frames[b]||{};a.frames[b].state=e;if(a.contexts.onUnload[b]){for(c=0;c<a.contexts.onUnload[b].length;c++)a.contexts.onUnload[b][c]();a.contexts.onUnload[b]=[]}delete a.frames[b]},remove:function(a){let c;n.RUNTIME.FAST_EXEC_SUPPORT&&
(c=d[a])&&Object.keys(c.frames).forEach(c=>{v.events.clean(a,c)});delete d[a];y.each(S,c=>{c&&c(a)})}},set:{extra:function(a,c,b,e){a=d[a]=d[a]||k();null===c?a.extra[b]=e:(a.extra[b]=a.extra[b]||{},a.extra[b][c]=e)},objurl:function(a,c,b){v.set.extra(a,c,"objurl",b)},blocker:function(a){v.set.extra(a,null,"blocker",!0)},forbidden:function(a,c){0===c&&v.set.extra(a,null,"forbidden",!0)},requests:function(a,c,b,e){a=d[a]=d[a]||k();c=a.frames[c]=a.frames[c]||{};(c.requests=c.requests||{})[b]=e}},get:{extra:function(a,
c,b,e,k){void 0===e&&(e=null);a=(d[a]?d[a].extra:{})[b];null!==c&&a&&k&&delete a[c];return a||e},empty:function(a){let c=!0;if(d[a]&&0!=d[a].urls.length){if(-1==d[a].urls.length)return d[a].urls.length=0,y.each(d[a].urls,(c,b)=>{"length"!==b&&0<c.count&&d[a].urls.length++}),v.get.empty(a);c=!1}return c},urls:function(a,c){let b;return c?(b=d[a].maps[c])?b.urls:[]:(b=d[a])?b.urls:{}},history:function(a){return d[a].maps},stats:function(a,c){const b={};d[a]&&(b.running=d[a].stats.running,b.disabled=
d[a].stats.disabled,c&&(b.unique=0,Object.keys(d[a].maps).forEach(c=>{0<d[a].maps[c].count&&b.unique++})));return b},tabs:function(){const a={};y.each(d,(c,b)=>{a[b]={ts:c.response_ts}});return a},objurl:function(a,c){return v.get.extra(a,c,"objurl",null,!0)},blocker:function(a){return v.get.extra(a,null,"blocker")},forbidden:function(a){return v.get.extra(a,null,"forbidden")},requests:function(a,c){return d[a]&&d[a].frames[c]?d[a].frames[c].requests:null}}};return v})(),pa=(()=>{const d={};return{get:function(p,
f){d[p]||(d[p]={});d[p][f]||(d[p][f]={});return d[p][f]},getAll:function(p){const f={};Object.keys(d).forEach(h=>{f[h]={};f[h]=d[h][p]});return f},set:function(p,f,h){d[p]||(d[p]={});const g={};h&&Object.keys(h).forEach(b=>{g[b]=h[b]});d[p][f]=g},cleanTab:function(p){delete d[p]}}})(),qa=(()=>({isScriptUrl:function(d,g){if(!d||-1!=d.search(/#bypass=true/)||-1!=d.search(n.REQUESTS.GET_INTERNAL_PAGE_REGEXP())||!["https:","http:","file:","ftp:"].some(f=>d.startsWith(f)))return!1;g=g?d:d.split(/[\?#$]/)[0];
const f=-1!=g.search(/[^/]{1}\.user\.(js#|js\?|js$)/)||-1!=g.search(/[^/]{1}\.tamper\.(js#|js\?|js$)/);return f?!(-1!=g.search(/^htt[ps]{1,2}:\/\/code\.google\.com/)||-1!=g.search(/^htt[ps]{1,2}:\/\/(github|gitlab)\.com/)&&!x.determineOriginOfUrl(g)||-1!=g.search(/^htt[ps]{1,2}:\/\/bitbucket\.org/)&&!x.determineOriginOfUrl(g)):f}}))(),X=(()=>({init:function(){const d=()=>{L.items.regexp.remove("PageFilter")};g.addChangeListener("forbiddenPages",d);g.addChangeListener("page_whitelist",d);g.addChangeListener("page_filter_mode",
d)},isAllowed:function(d){let p=!1,f=!1;var h=M.getSyncRemoteDomains().map(a=>"*://"+a+"/*");h=g.values.forbiddenPages.concat(h);var t=0<h.length;const b=0<g.values.page_whitelist.length;switch(g.values.page_filter_mode){case "black":f=t;break;case "off":break;case "white":p=b;break;default:p=b,f=t}(t=L.items.regexp.get("PageFilter"))||(t=x.regexify({inc:p?g.values.page_whitelist:void 0,exc:f?h:void 0}),L.items.regexp.set("PageFilter",t));return!f&&!p||x.validUrl(d,t)}}))(),J=(()=>{const p=(d,h)=>
{if(h.length)return(d="/"==h.substr(0,1)?x.matchUrl(d,x.convertToRegExp(h)):-1!=d.search(h))&&m.log('black: entry "'+h+'" matched'),d},w={SEVERITY_MAX:10,SEVERITY_MANUALLY_DEFINED:11,SEVERITY_FOISTED_SCRIPT:12,init:function(){const d=l(),h=()=>{"server"===g.values.script_blacklist_type&&window.setTimeout(w.checkUpdate,2E4)};h();g.addChangeListener("script_blacklist_type",h);d.resolve();return d.promise()},getWarningsFor:function(f){const h=[];f&&y.each(g.values.script_blacklist_server,g=>{if(g){var b;
y.each(g.rules,a=>{b|=p(f,a);return 1!=b});if(b)if(g.reasons){const a=Object.keys(g.reasons);let c,b;void 0!==(c=d.getBestLocale(a))&&(b=a[c]);h.push(g.reasons[b||"en"])}else g.reason&&h.push(g.reason)}});return h},getEvilnessOf:function(d){if("off"===g.values.script_blacklist_type)return!1;if(!d)return 0;let f=!1,t=0;y.each(g.values.require_blacklist,b=>{f|=p(d,b);return 1!=f});f?t=w.SEVERITY_MANUALLY_DEFINED:"server"===g.values.script_blacklist_type&&y.each(g.values.script_blacklist_server,b=>{if(b&&
(y.each(b.rules,a=>{f|=p(d,a);return 1!=f}),f))return t=b.severity,!1});return Number(t)},checkUpdate:function(d){const f=l();let p=ba.getConfig(),b;if(d||6048E5<Date.now()-p.black.last){const a=(a,b)=>{const c=l();ca.internal({method:"GET",url:a,nocache:b,retries:n.XMLHTTPREQUEST.RETRIES,overrideMimeType:"text/plain; charset=x-user-defined"},{ondone:function(a){c.resolve(a)}});return c.promise()};a("https://blacklist.tampermonkey.net/get.php?version=get").then(c=>{if(4==c.readyState&&200==c.status){try{b=
JSON.parse(c.responseText).version}catch(e){m.warn("black: unable to parse version response! "+c.responseText)}m.info("black: local version: "+p.black.version+" remote: "+b);if(b>p.black.version||d)return a("https://blacklist.tampermonkey.net/get.php",!0)}}).then(a=>{if(a&&4==a.readyState&&200==a.status)try{const c=JSON.parse(a.responseText);c&&c.blacklist&&1==c.version&&(g.values.script_blacklist_server=c.blacklist);m.info("black: updated blacklist to ",c)}catch(e){m.warn("black: blacklist update failed! ",
a.responseText)}}).always(()=>{p=ba.getConfig();p.black.last=Date.now();p.black.version=b||p.black.version;ba.setConfig(p);f.resolve()})}else f.resolve();return f.promise()}};return w})();blak=J;var M=(()=>{let p=0;const w=[],f={to:null,force:null,t:0},h={},t=xa.createQueue(1),b={},a=a=>t.add(()=>{m.log("sync: import",a.uuid,a.name,a.url);const c={imported:g.values.sync_type},b={};for(const c in E.SYNCED)!0===E.SYNCED[c]&&(b[c]=a.options[c]);const e={uuid:a.uuid,ask:!1,internal:!0,sync:c,force_meta:{lastModified:a.lastModified,
fileURL:a.url},force_options:b},d={silent_fail:!0};return(()=>F.caps.syncsSource?F.getSource(a.uuid).then(a=>x.installFromSource(a,e,d)):x.installFromUrl(a.url,e,d))().then(()=>{L.items.rundata.removeAll()})}),c=(a,c)=>t.add(()=>{if(!F.caps.syncsSource){let c;if(!a.url||!(c=z.parse(a.url))||!c.protocol.match(/https?:/))return m.log("sync: skip export due to missing URL",a.name,a.url),l.Pledge(!1)}m.log("sync: export",a.name,a.url);return F.setMeta(a,{lastModified:a.lastModified}).then(()=>{if(F.setSource&&
c)return F.setSource(a.uuid,c)}).then(()=>!0)}),e=a=>{var c=a.downloadURL?a.downloadURL.split("#")[0]:null;const b=a.fileURL?a.fileURL.split("#")[0]:null,e=y.select([b,c],a=>{if(!a||"file:"!==z.parse(a).protocol)return a})[0];c={uuid:a.uuid,name:a.name,options:{},durl:c,furl:b,url:e,lastModified:a.lastModified||a.lastUpdated};for(const b in E.SYNCED)!0===E.SYNCED[b]&&null!==a.options[b]&&(c.options[b]=a.options[b]);return c},k=()=>{const a=[];A.getUidList().forEach(c=>{c=A.getByUid(c);if(c.script&&
c.cond){const b=e(c.script);b.lastModified||Registry.isDevVersion("test")?c.script.evilness&&c.script.evilness>=Math.min(J.SEVERITY_MAX,g.values.script_blacklist_severity)?m.warn("sync: ignore evil script",c.script):a.push(b):m.warn("sync: script without updated/modified timestamps found",c.script)}});return a},B=e=>{if(E.enabled)if(0<p)e&&E.addSyncDoneCallback(a=>{a&&E.sync(50,e)});else{p++;var q=null,r=null,f=0,B=0,S=!0,t=a=>{if(a)for(let c=0;c<r.length;c++)if(r[c].uuid==a)return r[c];return null},
n=a=>{if(!a)return null;for(let c=0;c<q.length;c++)if(q[c].uuid==a)return q[c]},u=(a,c,b)=>b?Math.floor(a/b)*b>Math.floor(c/b)*b:a>c,y=(a,c,b)=>b?Math.floor(a/b)*b<Math.floor(c/b)*b:a<c,Da=(a,c,b)=>b?Math.floor(a/b)*b!=Math.floor(c/b)*b:a!=c;O.all("status",{key:"sync_status",class:"information",title:d.getMessage("Script_Sync"),text:d.getMessage("Sync_is_running"),timeout:9E5});return l.Pledge().then(()=>{q=k();return F.list().done(a=>{r=a}).fail(()=>{m.warn("sync: unable to get remotelist!")})}).then(()=>
{const c=r.map(c=>{let e;const d=n(c.uuid);let k,q;if(d){if(!c.lastModified&&g.values.sync_type==F.types.eCHROMESYNC)for(const a in E.SYNCED)if(!0===E.SYNCED[a]&&d.options[a]!=c.options[a]){m.log("sync: importable change detected!",c.name,"key:",a,c);k=!0;break}c.lastModified&&y(d.lastModified,c.lastModified,c.precision)&&(q=c.lastModified,k=!0,m.log("sync: importable change detected!",c.name,"local ts:",new Date(d.lastModified),"remote ts:",new Date(c.lastModified),c))}else(e=b[c.uuid])&&c.lastModified&&
y(e.lastModified,c.lastModified,c.precision)&&(q=c.lastModified,k=!0,m.log("sync: changed cache entry detected!",c.name,"local ts:",new Date(e.lastModified),"remote ts:",new Date(c.lastModified),c));if(!d&&!e||k)return()=>l.Pledge().then(()=>F.caps.specialMeta?F.getMeta(c.uuid):l.Pledge(c)).then(c=>{if(c){var r;if(d)if(c.options.removed)f++,m.log("sync: remove local script",c.uuid,c.name,c.url),x.doRemove(d.uuid,!1);else{if(k)return Da(q,c.lastModified,c.precision)&&(c.lastModified&&m.warn("sync: list and meta data lastModified differ, this will cause extra traffic!",
"file ts:",new Date(q),"meta ts:",new Date(c.lastModified),c),c.lastModified=q),f++,m.log("sync: update local script",c.uuid,c.name,c.url),l.Pledge().then(()=>{if(F.caps.syncsSource){const a=l();F.getSource(c.uuid,null).then(a=>a?x.doSave({uuid:c.uuid,src:a,ask:!1,internal:!0,save:!0}):l.Breach()).fail(()=>{m.warn("sync: getting source of",c.uuid,"failed",c)}).always(a.resolve);return a.promise()}}).then(()=>{const a=A.getByUid(d.uuid);for(r in E.SYNCED)!0===E.SYNCED[r]&&(a.script.options[r]=c.options[r]);
a.script.lastModified=c.lastModified;return x.doModify(a.script.uuid,a.script,!1)})}else if(d||c.options.removed)!e&&c.options.removed&&(b[c.uuid]=c);else{const b=l();if(c.url&&h[c.url]||c.uuid&&h[c.uuid])m.warn("sync: skip previously failed import",c);else return a(c).done(a=>{a?f++:(m.warn("sync: unable to import",c),h[c.url]=!0,h[c.uuid]=!0)}).fail(()=>{m.warn("sync: unable to load",c);h[c.url]=!0;h[c.uuid]=!0}).always(b.resolve),b.promise()}}})}).filter(a=>a);return l.onebyone(c)}).then(()=>{f&&
(x.reorderScripts(),O.all("status",{key:"sync",class:"information",title:d.getMessage("Script_Sync"),text:d.getMessage("0count0_changes_imported",f),timeout:1E4}));q=k();return l.Pledge()}).then(()=>{const a=[];for(let b=0;b<q.length;b++)a.push((()=>{const a=q[b];let e;if(!F.caps.syncsSource&&!a.url)return l.Pledge();const d=t(a.uuid);if(d){if(!d.lastModified||u(a.lastModified,d.lastModified,d.precision)){var k=!0;m.log("sync: exportable change detected!",a.name,"remote ts:",new Date(d.lastModified),
"local ts:",new Date(a.lastModified),a)}}else m.log("sync: export because remotely missing!",a.name,"local ts:",new Date(a.lastModified),a);return!d||k||F.caps.syncsSource&&!d.source?(F.caps.syncsSource&&(k=A.getByUid(a.uuid),k.script&&k.cond&&(e=k.script.textContent)),c(a,e).then(a=>{a&&B++})):l.Pledge()})());return l.when(a)}).fail(()=>{S=!1}).done(()=>{S=!0}).always(()=>{m.log("sync: finished");if(0==--p){O.all("status",{key:"sync_status",class:"information",title:d.getMessage("Script_Sync"),text:d.getMessage("Sync_finished"),
timeout:15E3});B&&O.all("status",{key:"sync",class:"information",title:d.getMessage("Script_Sync"),text:d.getMessage("0count0_changes_exported",B),timeout:5E3});for(var a=S;w.length;)w.shift()(a)}})}},q=()=>{E.enabled&&E.sync(500,!0)};let r=null;var E={enabled:!1,SYNCED:{comment:!0},configChangeListener:function(){r||(r=window.setTimeout(()=>{r=null;E.init().done(()=>{E.enabled&&E.sync(3E3)})},3E3))},init:function(){const a=l();E.enabled=!1;(()=>{if(g.values.sync_enabled&&g.values.sync_type){let a;
g.values.sync_type==F.types.eWEBDAV&&(a={url:g.values.cloud_url,basic_auth:I.Base64.encode(g.values.cloud_user+":"+g.values.cloud_pass)});return F.init(g.values.sync_type,a).done(a=>{E.enabled=a;E.enabled?F.addChangeListener(q):m.warn("sync: init failed!")}).fail(()=>{m.warn("sync: init failed!")})}return l.Pledge()})().always(()=>{a.resolve(E.enabled)});return a.promise()},finalize:function(){},reset:function(){return E.enabled?F.reset():l.Breach()},addSyncDoneCallback:function(a){w.push(a)},sync:function(a,
c){const b=Date.now();a=a||500;c=f.force||c;f.to?(window.clearTimeout(f.to),f.ts<b+a&&(a=f.ts-b,1>a&&(a=1))):m.log("sync: schedule sync for run in "+a+" ms");f.force=c;f.ts=b+a;f.to=window.setTimeout(()=>{B(f.force);f.to=null;f.force=null},a)},scriptAddedCb:function(a,b){E.enabled&&(a=e(b),c(a,b.textContent))},scriptChangedCb:function(){E.enabled&&E.sync(6E4)},scriptRemovedCb:function(a,c){E.enabled&&(a=e(c),m.log("sync: remove",a.name,a.url),F.remove(a))},getSyncRemoteUrl:function(a){if(E.enabled)return F.getRemoteUrl(a)},
getSyncRemoteDomains:function(){return F.getRemoteDomains()||[]}};return E})();sycl=M;var Ea=()=>{g.addChangeListener(["sync_enabled","sync_type","cloud_url","cloud_user","cloud_pass"],M.configChangeListener);g.addChangeListener("logLevel",()=>{m.set(g.values.logLevel)});g.addChangeListener("i18n",()=>{d.setLocale(g.values.i18n)});g.addChangeListener("incognito_mode",()=>{Ba()});g.addChangeListener("statistics_enabled",()=>{N.setEnabled(g.values.statistics_enabled,!0)});g.addChangeListener(["require_blacklist",
"script_blacklist_server","script_blacklist_type"],x.blackCheckAll);g.addChangeListener(["downloads_extension_whitelist","downloads_mode"],K.config_changed_listener);g.addChangeListener("webrequest_modHeaders",(d,g,f,h)=>{h.done(window.setTimeout(Y.reset,1))});g.addChangeListener(["appearance_badge_color","appearance_badge_text_color"],R.init)},g=(()=>{const d={},g={enabled:!0,configMode:0,debug:!1,logLevel:0,showFixedSrc:!1,webrequest_modHeaders:"yes",webrequest_fixCSP:"yes",webrequest_fixContentCSP:"no",
notification_showUpdate:"changelog",notification_silentScriptUpdate:!0,script_templates:[{name:"ECMAScript 5",value:"// ==UserScript==\n// @name         New Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  try to take over the world!\n// @author       You\n// @match        <$URL$>\n// @grant        none\n// ==/UserScript==\n\n(function() {\n    'use strict';\n\n    // Your code here...\n})();"},{name:"ECMAScript 6",value:'// ==UserScript==\n// @name         New ES6-Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  shows how to use babel compiler\n// @author       You\n// @require      https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.18.2/babel.js\n// @require      https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/6.16.0/polyfill.js\n// @match        <$URL$>\n// ==/UserScript==\n\nvar inline_src = (<><![CDATA[\n\n    // Your code here...\n\n]]\x3e</>).toString();\nvar c = Babel.transform(inline_src, { presets: [ "es2015", "es2016" ] });\neval(c.code);'},
{name:"CoffeeScript",value:"// ==UserScript==\n// @name         New Coffee-Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  shows how to use coffeescript compiler\n// @author       You\n// @require      http://coffeescript.org/browser-compiler/coffeescript.js\n// @match        <$URL$>\n// ==/UserScript==\n\nvar inline_src = (<><![CDATA[\n\n    // Your code here\n\n]]\x3e</>).toString();\nvar compiled = this.CoffeeScript.compile(inline_src);\neval(compiled);"}],
scriptUpdateCheckPeriod:864E5,scriptUpdateHideNotificationAfter:15E3,scriptUpdateCheckDisabled:!1,scriptUrlDetection:"auto",script_file_access:n.RUNTIME.FIREFOX?"off":"externals",runtime_strict_mode:"byscript",runtime_inject_mode:"default",autoReload:!1,appearance_badges:"running",appearance_badge_color:"gcal"===rea.runtime.short_id?"#444":"#ee3131",appearance_badge_text_color:"#ffffff",editor_enabled:!0,editor_fontSize:100,editor_theme:"default",editor_keyMap:"windows",editor_indentUnit:4,editor_indentWithTabs:"spaces",
editor_tabMode:"indent",editor_electricChars:!0,editor_autoSave:!1,editor_easySave:!0,editor_autoLint:!0,editor_autoLintMaxLen:3E5,editor_lineWrapping:!1,editor_highlightTrailingWhitespace:!0,editor_trimTrailingSpacesFromModifiedLines:!0,editor_linter_config:null,favicon_service:"google",i18n:null,action_menu_columns:1,action_menu_scripts_hide_disabled:!1,action_menu_scripts_sort:"auto",incognito_mode:"temporary",layout:"default",layout_user_css:"",sync_enabled:!1,sync_type:2,statistics_enabled:!n.RUNTIME.FIREFOX&&
!n.RUNTIME.SAFARI||"firb"==rea.runtime.short_id?!0:null,downloads_mode:"default",downloads_extension_whitelist:"/^[^\\.]*$/ /\\.mp[34]$/ .wav /\\.(avi|mkv|flv|divx|mpe?g|webm)$/ /\\.(ico|gif|png|jpe?g)/ /\\.(srt|sub|idx)$/ .txt .iso .zip /\\.r(ar|[0-9]{2,2})$/".split(" "),external_update_interval:6048E5,external_connect:"all",require_timeout:2E4,require_blacklist:["/^https?:\\/\\/example.com(:[0-9]{1,5})?\\/.*/"],require_sri_mode:"supported",script_blacklist_server:[],script_blacklist_type:"server",
script_blacklist_severity:4,connect_mode:"ask",page_filter_mode:"black",page_whitelist:["/https?:\\/\\/greasyfork\\.org\\/.*/","http://xkcd.com/970/"],forbiddenPages:"*example.org/* *paypal.tld/* *stripe.com/* https://*deutsche-bank-24.tld/* https://*bankofamerica.tld/* /^.*:\\/\\/apis\\.google\\.com\\/((?!render)([^\\/]+)\\/)+([^\\/]+)?$/ *://www.facebook.com/plugins/* *://platform.twitter.com/widgets/*".split(" ")},f={cloud_url:null,cloud_user:null,cloud_pass:null},h=a=>{let c;return void 0!==(c=
u.getValue(n.CONSTANTS.STORAGE.CONFIG,{})[a])?c:"function"==typeof(c=g[a])?c():c},t=(a,c)=>{const b=u.getValue(n.CONSTANTS.STORAGE.CONFIG,{}),e=h(a);b[a]=c;const k=u.setValue(n.CONSTANTS.STORAGE.CONFIG,b);d[a]&&JSON.stringify(e)!=JSON.stringify(c)&&d[a].forEach(b=>{try{b(a,e,c,k)}catch(H){m.warn("config: changeListener error",H)}});return k};let b,a;if(n.HTML5.LOCALSTORAGE&&(a=n.HTML5.LOCALSTORAGE.getItem(n.CONSTANTS.STORAGE.SESSION)))try{b=JSON.parse(I.Base64.decode(a))}catch(B){}b=b||{};const c=
a=>{let c;return void 0!==(c=b[a])?c:f[a]},e=(a,e)=>{const k=c(a);void 0===e?delete b[a]:b[a]=e;n.HTML5.LOCALSTORAGE&&n.HTML5.LOCALSTORAGE.setItem(n.CONSTANTS.STORAGE.SESSION,I.Base64.encode(JSON.stringify(b)));d[a]&&JSON.stringify(k)!=JSON.stringify(e)&&d[a].forEach(c=>{try{c(a,k,e)}catch(S){m.warn("config: changeListener error",S)}});return l.Pledge()},k={init:function(){const a=l();k.values={};Object.defineProperty(k,"snapshot",{get:function(){return y.assign({},k.values)},enumerable:!0});Object.keys(g).forEach(a=>
{Object.defineProperty(k.values,a,{get:function(){return h(a)},set:function(c){t(a,c)},enumerable:!0})});Object.keys(f).forEach(a=>{Object.defineProperty(k.values,a,{get:function(){return c(a)},set:function(c){e(a,c)},enumerable:!0})});k.initialized=!0;(c=>{Object.keys(c).forEach(a=>{const b=c[a];window.setTimeout(()=>{x.doSave({url:null,src:b,ask:!1,replace:!0,internal:!0})},1)});a.resolve()})([]);return a.promise()},getValue:function(a){return f.hasOwnProperty(a)?c(a):h(a)},setValue:function(a,
c){return f.hasOwnProperty(a)?e(a,c):t(a,c)},getDefaults:function(){return g},addChangeListener:function(a,c){Array.isArray(a)||(a=[a]);a.forEach(a=>{d[a]||(d[a]=[]);d[a].push(c)})}};return k})(),ca=(()=>{let g,w,f=[],h,t,b;const a=()=>l.sleep(1).then(()=>rea.permissions.supported?ha.has(n.PERMISSIONS.ALL_URLS).then(a=>a,()=>!0):!0).always(a=>{(w=a)?O.removeAll("runtime_host_permissions"):O.all("status",{key:"runtime_host_permissions",class:"warning",text:d.getMessage("Limited_runtime_host_permissions_might_break_some_Tampermonkey_features_"),
timeout:31536E6});h=null}),c=(c,k,B)=>{const e={details:c,callbacks:k,internal:B};f.push(e);l.Pledge().then(()=>{if(void 0===w)return b||(ha.addListener(c=>{m.info("pcx: detected permission change",c);w=void 0;h=a()}),b=!0),h||(h=a()),h}).then(()=>t).then(()=>{const a=f;f=[];if(w)return a;{const c=[],b=a.map(a=>{const b=z.woPath(a.details.url)+"/*";return ha.hasOrigin(b).then(a=>{a||c.push(b)})});return t=l.sidebyside(b).then(()=>c.length?(m.info("pcx: need to ask for some permissions",c),ha.askOrigin(c,
d.getMessage("Cross_Origin_Request_Permission"),d.getMessage("Click_here_to_allow_TM_to_access_the_following_hosts_0host_list0",c.join("\n"))).then(()=>{t=null;return a})):a).always(()=>{t=null})}}).always(a=>{a.forEach(a=>{a.aborted||(a.xhr=g(a.details,a.callbacks,a.internal?{internal:!0}:void 0))})});return{abort:function(){let a;if(e.xhr)return e.xhr.abort();f&&-1!=(a=f.indexOf(e))?f.splice(a,1):e.aborted=!0}}};return{init:function(){g=U.run},internal:function(a,b){return c(a,b,!0)},external:function(a,
b){return c(a,b)}}})(),ra=()=>{const d=l();rea.tabs.getSelected(null,g=>{d.resolve(g)});return d.promise()},la=(()=>{const d={},w=a=>{if(z.isIpOrHostname(a))return null;const c=a.split(".");if(3>c.length)return a;a=z.isSecondLevelDomain(c.slice(-2).join("."))?-3:-2;return c.slice(a).join(".")},f=a=>a&&a.includes("*"),h=a=>{const c=l();X.isAllowed(a)?c.resolve({allowed:!0}):c.resolve({allowed:!1});return c.promise()},t=(a,c)=>{const b=a=>a?a.map(a=>{if(a.match(/^'?self'?$/))a=z.parse(c.url).hostname||
null;else if("'none'"==a)a="none";else if(!["none","localhost","*"].includes(a)&&!z.isIpOrHostname(a)&&(0===a.indexOf(".")||1===(a.match(/\./g)||[]).length&&z.isSecondLevelDomain(a)))return null;return a}):[];return{connects:a.options.override.merge_connects&&"paranoid"!=g.values.connect_mode?b(a.connects):[],userconnects:b(a.options.override.use_connects),blockers:b(a.options.override.use_blockers)}},b=(a,c,b)=>{const e=l(),k=()=>{e.resolve({permitted:!0})},q=a=>{e.resolve({permitted:!1,reason:a})},
r=()=>{e.resolve({unknown:!0})};let h;const B=(a,c)=>{let b=null;const e=z.isIpOrHostname(a);c.every(c=>{if(c.a)for(let d=0;d<c.a.length;d++)if(c.a[d]&&(e||z.isIpOrHostname(c.a[d])?c.a[d]===a:-1!=a.search(new RegExp("(^|.+\\.)"+y.escapeForRegExp(c.a[d])+"$"))))return b=c.blocker?q:k,!1;return!0});return b};if("off"==g.values.connect_mode)k();else if((h=z.parse(b))&&h.hostname)if((b=B(h.hostname,[{a:d[a.uuid]}]))||(b=f(d[a.uuid])?k:null))b();else if(0===c.connects.length&&0===c.userconnects.length&&
0===c.blockers.length)"casual"==g.values.connect_mode?k():"strict"==g.values.connect_mode?q("No @connects given, but strict mode enabled"):r();else if(c.connects.includes("none"))q("None value found");else{if("casual"!=g.values.connect_mode||f(c.blockers)||!(b=f(c.connects)?k:null))(b=f(c.userconnects)?k:null)||(b=B(h.hostname,[{a:c.blockers,blocker:!0},{a:c.connects},{a:c.userconnects}])||r);b()}else q("URL can not be parsed");return e.promise()},a=()=>{const a=a=>{for(let c=0;c<e.length;c++)if(e[c].tabId===
a)return e.splice(c,1)[0];return e.pop()};let b;ra().then(e=>{for(;!c&&(b=a(e.id));)b.fn()})};var c,e=[];const k=(b,k,h,B,g)=>{let q;const r=l(),v=()=>{r.resolve({approved:!0})},p=()=>{r.resolve({forbidden:!0})};m.log('cor: "'+b.name+'" is asking for permission to access',B,k);if((q=z.parse(B))&&q.hostname){const r=w(q.hostname),H=k.tab?k.tab.id:null;c=!0;ra().then(a=>Z.askForConnect({src_url:k.url,hostname:q.hostname,domain:r,all_domains:f(h.connects),tabid:H,active:H===a.id,timeout:g,url:B,settings_url:rea.extension.getURL("options.html")+
"#nav="+b.uuid+"+settings",connect_url:"https://www.tampermonkey.net/documentation.php#_connect",script:{name:b.name,uuid:b.uuid,icon:b.icon64||b.icon||Q.images.origin("unknown")}})).done(a=>{let c;const e=a.whole_domain?r:q.hostname;a.allow?a.once?(m.log('cor: allowing "'+b.name+'" to access',e,"once"),v()):a.temporary?(m.log('cor: allowing "'+b.name+'" to access',e,"temporarily"),void 0===d[b.uuid]&&(d[b.uuid]=[]),d[b.uuid].includes(e)||d[b.uuid].push(e),v()):(c=v,a.all_domains?(m.log('cor: allowing "'+
b.name+'" to access all domains always'),b.options.override.use_connects.push("*")):(m.log('cor: allowing "'+b.name+'" to access',e,"always"),b.options.override.use_connects.push(e),c=v)):a.once||a.aborted?(m.log('cor: denying "'+b.name+'" to access',e,"once"),p()):(b.options.override.use_blockers||(b.options.override.use_blockers=[]),c=p,a.all_domains?(m.log('cor: denying "'+b.name+'" to access any domains (additional) domain'),b.options.override.use_blockers.push("*")):(m.log('cor: denying "'+b.name+
'" to access',e,"always"),b.options.override.use_blockers.push(e)));c&&x.doModify(b.uuid,b,!1).always(c)}).fail(p).always(()=>{c=!1;e.length&&window.setTimeout(a,1)})}else p();return r.promise()},B=(a,d,p,w)=>{const q=t(a,d);return h(p).then(c=>{if(!0!==c.allowed)return l.Breach("URL is blacklisted");let e,k;return(e=z.parse(p))&&e.origin&&(k=z.parse(d.url))&&k.origin&&e.origin===k.origin?l.Pledge({permitted:!0}):b(a,q,p)}).then(b=>{if(!1===b.permitted)return l.Breach("URL is not permitted"+(b.reason?
": "+b.reason:""));if(!0===b.permitted)return l.Pledge();if(0===q.connects.length||f(q.connects)){if(["ask","paranoid"].includes(g.values.connect_mode)){if(f(q.blockers))return l.Breach("URL was permanently blocked by the user");if(c){m.log('cor: queuing access permission check from "'+a.name+'" to',p,d);const c=l();e.push({tabId:d.tab?d.tab.id:null,fn:function(){c.consume(B.apply(this,[a,d,p,w]))}});return c.promise()}return k(a,d,q,p,w).then(a=>!0===a.approved?l.Pledge():l.Breach("Request was blocked by the user"))}return l.Breach()}return l.Breach("URL is not a part of the @connect list")})};
return{getSessionConnects:function(a){return d[a]||[]},setSessionConnects:function(a,c){d[a]=c||[]},purgeAppeals:function(a){e=e.filter(c=>c.tabId!==a)},exec:function(a,c,b,e){let d,k,f,q,r=a.url;const h=[],g=Math.max(Math.min(a.timeout||0,6E4),2E4),p=()=>{let a;for(;!f&&!q&&(a=h.shift());)a()},t=(c,b)=>{const d='Refused to connect to "'+(b||a.url)+'": '+(c||"Blocked by @connect CORS check"),k=U.makeErrorResponse(d);["onerror","ondone"].forEach(a=>{if(e[a])e[a]({response:k,exception:d})})};if(!(b&&
b.url&&b.tab&&a.url&&c&&(k=A.getByUid(c))&&k.script&&k.cond))return t();B(k.script,b,a.url,g).done(()=>{const c={};Object.keys(e).forEach(a=>{c[a]=(v,...H)=>{f||(q?h.push(function(){c[a].apply(this,[v,...H])}):(()=>v&&v.finalUrl&&r!==v.finalUrl?(q=!0,B(k.script,b,v.finalUrl,g).fail(()=>{f||(d&&d.abort(),f=!0,t("Request was redirected to a not whitelisted URL",v.finalUrl),m.warn("cor: request to",r,"was redirect to a not whitelisted URL",v.finalUrl))}).always(()=>{r=v.finalUrl;q=!1;h.length&&window.setTimeout(p,
1)})):{always:function(a){a()}})().always(()=>{if(!f)e[a]({response:v})}))}});d=ca.external(a,c)}).fail(a=>{t(a);m.warn("cor: access to",r,"was denied")});return{abort:function(){f=!0;d&&d.abort()}}}}})(),ta=(()=>{const d=a=>{const c=[];a=new DataView(a);for(let b=0;b<a.byteLength;b+=4){const e=("00000000"+a.getUint32(b).toString(16)).slice(-8);c.push(e)}return c.join("")},g={md5:function(a,c){return l.Pledge(I.MD5(a,c))},sha256:function(a){return l.Pledge(forge_sha256(a))}},f={};["SHA-1","SHA-384",
"SHA-512"].forEach(a=>{const c=a.toLowerCase().replace("-","");f[c]=()=>{const c=(c,b)=>{const e=l();window.crypto.subtle.digest(a,I.str2arrbuf(c,b)).then(a=>{e.resolve(d(a))},()=>{e.reject()});return e.promise()};try{return c("").then(a=>{if(a&&a.substr(0,4).toLowerCase().match(/[0-9a-f]{4,4}/))return c})}catch(k){return l.Breach()}}});const h=a=>Object.keys(g).includes(a),t=a=>function(...c){if(!1!==b){const e=l();b.push(function(){e.consume(a.apply(this,c))});return e.promise()}return a.apply(this,
c)};var b=[];return{init:function(){m.D&&Object.keys(g).forEach(a=>{m.log("sri:",a,"is supported")});return l.sidebyside(Object.keys(f).map(a=>f[a]().done(c=>{m.log("sri:",a,"is supported");g[a]=c}).fail(()=>{m.log("sri:",a,"is unsupported")}))).always(()=>{b.forEach(a=>{a()});b=!1})},isSupported:t(a=>l.Pledge(h(a))),getHash:t((a,c)=>{const b=l();"string"===typeof a&&(a=z.parse(a));if(a&&a.hash){let e;a=a.hash.replace(/^#/,"").split(/,|;/g);for(let c=0;c<a.length;c++){if(!(e=a[c].match(/([^=|:|-]+)[=|:|-](.+)/))||
3!=e.length||!h(e[1]))continue;let b=e[2];if(!/^[0-9a-fA-F]+$/.exec(b)){var k=decodeURIComponent(b);try{var f=d(I.str2arrbuf(I.Base64.decode(k)))}catch(S){f=null}b=f||b}k={type:e[1],value:b}}b.resolve(k||(c?k:{type:"unsupported",value:""}))}else b.resolve();return b.promise()}),check:t((a,c,b)=>c&&a&&h(a.type)?g[a.type](c,b).then((c,b)=>((b=c===a.value)?l.Pledge:l.Breach)(b||{type:a.type,value:c})):l.Breach())}})(),P=(()=>{const d={key:function(a,c){return n.CONSTANTS.PREFIX.EXTERNAL+y.select([a,
c?I.MD5(c):null],a=>a).join(":")},list:function(a){const c=new RegExp("^"+a);return y.select(u.listValues(),a=>-1!=a.search(c))},set:function(a,c,b,k){a=d.key(a,c);const e={};y.each(b,(a,c)=>{"content"==c&&(c="base",a=I.encodeS(a));e[c]=a});u.setValue(a,{ts:Date.now(),url:c,resource:e,modified:k})},get:function(a,c){a=d.key(a,c);a=u.getValue(a);let b;if(a&&a.resource){const c={};y.each(a.resource,(a,b)=>{"base"==b&&(b="content",a=I.decodeS(a));c[b]=a});b={ts:a.ts,url:a.url,data:c,modified:a.modified}}return b},
clean:function(a,c){a=d.key(a,c);u.deleteValue(a)},cleanAll:function(a,c){let b;const k=d.list(d.key(a));if(c){const e={};y.each(c,c=>{c=d.key(a,c);e[c]=!0});b=[];y.each(k,a=>{e[a]||b.push(a)})}else b=k;b.forEach(a=>{u.deleteValue(a)})}},w=(a,c)=>{const b=l(),d=e=>{const d={content:""};if(4!=e.readyState||200!=e.status&&0!=e.status||e.error)b.reject(d);else{let k,f;const q=U.parseHeaders(e.responseHeaders)["content-type"];q&&q.match("(image/|text/)([.-a-zA-Z0-9]+)")&&(k=q);k||(a.match(".*.(ico|jpg|jpeg)+($|\\?|#).*")?
k="image/x-icon":(f=a.match(".*.(gif|png)+($|\\?|#).*"))?k="image/"+f[1]:-1!=a.search(".*.(js)+($|\\?|#).*")?k="text/javascript":(f=a.match(".*.(css|html|xml)+($|\\?|#).*"))?k="text/"+f[1]:y.isLocalImage(a)&&(k="image/x-icon"));d.meta=k;d.content=I.arrbuf2str(e.response,c.encoding)||"";b.resolve(d)}},f=()=>{b.reject({})};var q=z.parse(a);["file:"].concat(n.REQUESTS.INTERNAL_PAGE_PROTOCOLS).includes(q.protocol)?"file:"!=q.protocol||n.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS&&["externals","all"].includes(g.values.script_file_access)?
rea.file.get(a,a=>{d({readyState:4,status:0,response:a})},a=>{b.reject({})}):(m.warn("externals:","Access to this local file is forbidden!","Loading the following @resource failed:",a,"-> more info:","https://www.tampermonkey.net/faq.php#Q204"),b.reject({})):(q={method:"GET",url:a,retries:n.XMLHTTPREQUEST.RETRIES,nocache:!1,responseType:"arraybuffer"},q.timeout=g.values.require_timeout,ca.internal(q,{onload:d,onerror:f,ontimeout:f}));return b.promise()},f=y.getDebouncer(9E3),h=(a,c,b,k)=>{const e=
l(),f={sync:!1};w(c,{encoding:k.encoding}).done(h=>{b&&(h.sri=b);const q=b=>{const e=z.parse(c);e.protocol&&!["file:"].concat(n.REQUESTS.INTERNAL_PAGE_PROTOCOLS).includes(e.protocol)&&d.set(a,c,b)};b&&["supported","given"].includes(g.values.require_sri_mode)?ta.check(b,h.content,k.encoding).done(()=>{f.resource=h;q(f.resource);e.resolve(f)}).fail(a=>{f.resource={forbidden:!0,sri:{mode:g.values.require_sri_mode,type:b.type,value:"invalid"},determined:a,content:""};q(f.resource);e.reject(f)}):(f.resource=
h,q(f.resource),e.resolve(f))}).fail(b=>{m.log("externals: get.failed",a,c,b);f.resource={failed:!0,content:""};e.reject(f)});return e.promise()},t=(a,c,b)=>{const e=l(),B=z.parse(c),q={sync:b.sync};let r;c?J.getEvilnessOf(c)>=g.values.script_blacklist_severity?(q.resource={blacklisted:!0,content:""},e.reject(q)):ta.getHash(B,"supported"==g.values.require_sri_mode).done(k=>{if("enforce"!=g.values.require_sri_mode||k)if("file:"!==B.protocol&&(r=d.get(a,c))){const B=d.key(a,c),v=Date.now();0<g.values.external_update_interval&&
v-r.ts>g.values.external_update_interval&&!f.is(B)&&(1<g.values.external_update_interval&&f.add(B),r.modified?m.log("externals: resource is not updated due to user modifications",c,(new Date(r.ts)).toISOString(),(new Date(v)).toISOString()):(m.log("externals: resource needs update",c,(new Date(r.ts)).toISOString(),(new Date(v)).toISOString()),window.setTimeout(()=>{h(a,c,k,b)},3E3)));q.resource=r.data;q.resource.forbidden||q.resource.blacklisted?e.reject(q):e.resolve(q)}else e.consume(h(a,c,k,b));
else q.resource={forbidden:!0,sri:{mode:g.values.require_sri_mode},content:""},e.reject(q)}):(q.resource={forbidden:!0,content:""},e.reject(q));return e.promise()},b={setElement:function(a,c,b,k){return d.set(a,c,b,k)},getElement:function(a,c){return d.get(a,c)},cleanElement:function(a,c){return d.clean(a,c)},dropAll:function(a){d.cleanAll(a);return l.Pledge()},dropAllBut:function(a,c){d.cleanAll(a,c);return l.Pledge()},loadResources:function(a,c){const e=l();b.getResources(a,c).always(()=>{e.resolve()});
return e.promise()},loadRequires:function(a,c){const e=l();b.getRequires(a,c).always(()=>{e.resolve()});return e.promise()},getResources:function(a,c){const b={elements:[]},d=l(),f=[],h={sync:!0};c.forEach(c=>{var e=c.url||z.sanitize(c.unsafe_url,c.abs_url);const d={name:c.name,url:e};e=t(a,e,h);const k=l();e.done(a=>{a=a.resource;d.content=a.content;d.meta=a.meta||"application"}).fail(a=>{a.resource&&a.resource.forbidden?a.resource.sri?m.warn("externals: can't load @resource",c.name,"from URL",c.unsafe_url,
"due to a SRI error"):m.warn("externals: can't load @resource",c.name,"from forbidden URL",c.unsafe_url):a.resource&&a.resource.blacklisted?m.warn("externals: can't load @resource",c.name,"from blacklisted URL",c.unsafe_url):(m.warn("externals: can't load @resource",c.name,"from URL",c.unsafe_url),d.failed=!0);d.content=null}).always(a=>{h.sync&=a.sync;b.elements.push(d);k.resolve()});f.push(k)});l.when(f).always(()=>{b.sync=h.sync;d.resolve(b)});return d.promise()},getRequires:function(a,c){const b=
{elements:[]},d=l(),f=[],h={encoding:"UTF-8",sync:!0};y.each(c,(c,e)=>{var d=c.url||z.sanitize(c.unsafe_url,c.abs_url);const k={};d=t(a,d,h);const q=l();d.done(a=>{k.textContent=a.resource.content||""}).fail(a=>{a=a.resource&&a.resource.forbidden?a.resource.sri?"couldn't load @require from URL "+c.unsafe_url+" due to a SRI error":"couldn't load @require from forbidden URL "+c.unsafe_url:a.resource&&a.resource.blacklisted?"couldn't load @require from blacklisted URL "+c.unsafe_url:"couldn't load @require from URL "+
c.unsafe_url;k.textContent='console.warn("Tampermonkey: " + decodeURIComponent("'+encodeURIComponent(a)+'"));\n';m.warn("externals: "+a)}).always(a=>{h.sync&=a.sync;b.elements[e]=k;q.resolve()});f.push(q)});l.when(f).always(()=>{b.sync=h.sync;b.elements=b.elements.filter(a=>a);d.resolve(b)});return d.promise()}};return b})();exts=P;var Aa=(()=>{const d=(d,h,p)=>{const b=l(),a=[];p.forEach(c=>{c=c.textContent||"";c=ma.mkCompat(c,d.options.compatopts_for_requires?d:null,"off"!=g.values.runtime_strict_mode);
a.push(c)});p="\n"+a.join("\n")+"\n";const c=A.getStorageByUid(d.uuid);h=ma.mkCompat(h,d,"off"!=g.values.runtime_strict_mode);if(g.values.debug){h=h.split("\n");var e=!1;for(let a=0;a<h.length;a++){var k=h[a];if(!k.match(/^\s*$|^\s*\/\/\s*|^\s*\/\*.*\*\/\s*$|^\s*["']+use strict["']+;*\s*$/))if(k.match(/^\s*\/\*/)&&(e=!0),e)if(k.match(/\*\/\s*$/))e=!1;else{if(-1!=(k=k.search(/\*\//))){h[a]=y.insert(h[a],k+2,0,"debugger;");break}}else{h[a]="debugger;"+h[a];break}}h=h.join("\n")}e=encodeURIComponent(d.name)+
".user.js";e=n.RUNTIME.FIREFOX?rea.extension.getURL("userscripts/")+e+"?"+z.hash2params({id:d.uuid}):rea.extension.getURL("userscript.html")+"?"+z.hash2params({name:e,id:d.uuid});b.resolve({header:d.header,code:h,requires:p,storage:c,script:d,source_url:e});return b.promise()},w={};return{bundle:function(f,h){let g,b,a=!0;if(g=w[h.uuid])return g;const c={},e="includes matches requires resources excludes connects textContent".split(" ");Object.keys(h).forEach(a=>{e.includes(a)||("options"==a?(c[a]=
JSON.parse(JSON.stringify(h[a])),c[a].run_at=c[a].run_at||h.options.override.orig_run_at||"document-idle"):c[a]=h[a])});g=P.getResources(c.uuid,h.resources).then(b=>{a&&!b.sync&&(m.log("ri: uncached @external detected -> fast script start disabled"),a=b.sync);c.resources=b.elements;return P.getRequires(c.uuid,h.requires)}).then(b=>{a&&!b.sync&&(m.log("ri: uncached @external detected -> fast script start disabled"),a=b.sync);b=b.elements;m.log("run script "+c.name+" @ "+f.url);return d(c,h.textContent,
b)}).always(()=>{b=!0;delete w[c.uuid]});b||(w[c.uuid]=g);return g}}})(),O=(()=>{const d={},g={},f=(b,a)=>{let c;const e=a.key||"general",d=a.timeout||3E5,f=window.setTimeout(()=>{delete b[e]},d);(c=b[e])&&window.clearTimeout(c.to);b[e]={ts:Date.now()+d,options:a,to:f}},h=b=>{const a=Date.now();return Object.keys(b).map(c=>{var e=b[c];c=y.copy(e.options,{});if(e=Math.max(0,e.ts-a))return c.timeout=e,c}).filter(a=>a)},t={all:function(b,a){t.actionPage(b,a);t.optionsPage(b,a)},removeAll:function(b){delete d[b];
delete g[b]},actionPage:function(b,a){const c=rea.extension.getViews({type:"popup"});c&&c.length&&rea.extension.sendMessage({method:b,options:a},()=>{});a&&f(d,a)},optionsPage:function(b,a){const c=rea.extension.getViews({type:"tab"});c&&c.length&&rea.extension.sendMessage({method:b,options:a},()=>{});a&&f(g,a)},actionStatus:function(){return h(g)},optionsStatus:function(){return h(d)}};return t})(),ba=(()=>({getConfig:function(){const d={version:0,last:0},g={scripts:0};let f=u.getValue(n.CONSTANTS.STORAGE.UPDATE,
g);"object"!==typeof f&&(f=g);f||(f=g);void 0==f.black&&(f.black=d);void 0==f.scripts&&(f.scripts=0);return f},setConfig:function(d){d&&u.setValue(n.CONSTANTS.STORAGE.UPDATE,d)}}))(),da=(()=>{const p=(h,p)=>{let b=0,a=0,c=0;const e=d.getMessage("Script_Update"),k=d.getMessage("Check_for_userscripts_updates")+"...";h&&W.show(e,k,Q.images.brand("tampermonkey"),{timeout:1E4});const B=A.getUidList().map(e=>{var k,h,q;let v,B,t;return(()=>{v=A.getByUid(e);if(!v.script||!v.cond)return m.warn("update: inconsistent script entry",
e,v),l.Breach();const a=!g.values.scriptUpdateCheckDisabled&&!v.script.enabled&&!p||!v.script.options.check_for_updates;if(p&&v.script.uuid!==p||a||!(t=x.determineSourceURL(v.script))||v.script.evilness&&v.script.evilness>=Math.min(J.SEVERITY_MAX,g.values.script_blacklist_severity))return l.Breach();let c;if((c=x.determineOrigin(v.script))&&c.updates_allowed&&!c.updates_allowed(t))return l.Breach();b++;m.info("update: check for script updates @",e);return l.Pledge()})().then(()=>{const a=x.determineMetaURL(v.script);
if(!a)return l.Pledge();if("none"==a)return m.debug("update: ignore non-updatable script",v.script.name),l.Breach();const c=l();ca.internal({method:"GET",retries:n.XMLHTTPREQUEST.RETRIES,timeout:1E3*n.SCRIPT_DOWNLOAD.TIMEOUT,revalidate:!0,headers:{Accept:"text/x-userscript-meta, */*"},url:a},{ondone:function(b){4==b.readyState&&200==b.status?B=D.processMetaHeader(b.responseText):m.warn("update: unable to find meta data @ "+a+" req.status = "+b.status);c.resolve()}});return c.promise()}).then(()=>
{const a=!!B,c=a&&!!B.version,b=c&&(!v.script.version||D.versionCmp(B.version,v.script.version)==D.versionCmp.eNEWER);return a&&c&&!b?l.Breach():l.Pledge()}).then(()=>{let a;if(a=z.parse(t)){if(a.protocol.match(/(https?|file):/))return f.getScriptFromURL(t).fail(()=>{m.warn("update: failed",v.script.name,t)});m.warn("update: can't download URL",v.script.name,t)}else m.warn("update: can't parse URL",v.script.name,t)}).then(c=>{{var b=v.script.uuid;const a=D.createScriptFromSrc(c);if(!a.name||""==a.name||
void 0===a.version||a.options.compat_uW_gmonkey)b=D.versionCmp.eERROR;else{var e;b=(e=A.getMetaByUid(b))?e.system?null:a.version==e.version?D.versionCmp.eEQUAL:D.versionCmp(a.version,e.version):D.versionCmp.eNEWER}}return b==D.versionCmp.eNEWER?(a++,k=v.script.name,h=t,q=c,l.Pledge()):l.Breach()}).then(()=>{if(g.values.notification_silentScriptUpdate)return l.Pledge();{const a=d.getMessage("There_is_an_update_for_0name0_avaiable_",k)+"\n"+d.getMessage("Click_here_to_install_it_"),c=d.getMessage("Just_another_service_provided_by_your_friendly_script_updater_")+
":",b=l();W.show(c,a,Q.images.brand("tampermonkey"),{timeout:g.values.scriptUpdateHideNotificationAfter},b.resolve);return b.promise()}}).then(a=>{const b=e||v.script.uuid;return void 0===a||a.clicked?x.doSave({url:h,uuid:b,replace:!b,src:q,ask:!g.values.notification_silentScriptUpdate}).done(a=>{a&&a.installed&&c++}):l.Breach()})});b&&O.all("status",{key:"script_update",class:"information",title:e,text:k,timeout:1E4});return l.sidebyside(B).then(()=>{B.length&&0==a&&(m.debug("No update found"),h&&
W.show("Narf!",d.getMessage("No_update_found__sry_"),Q.images.brand("tampermonkey"),{timeout:1E4}),O.all("status",{key:"script_update",class:"information",text:d.getMessage("No_update_found__sry_"),timeout:1E4}));return{found:a,installed:c}})};let w=null;var f={check:function(f,t,b){if(!f&&0>=g.values.scriptUpdateCheckPeriod)return l.Breach();let a=ba.getConfig();if(!f&&Date.now()-a.scripts<Math.max(g.values.scriptUpdateCheckPeriod,36E5))return l.Breach();let c,e;return l.Pledge().then(()=>{const a=
()=>{e=null;const a=d.getMessage("Script_Update"),c=d.getMessage("Waiting_for_sync_to_finish")+"...";e=W.show(a,c,Q.images.brand("tampermonkey"),{timeout:6E4})};if(M.enabled){const b=l();M.addSyncDoneCallback(b.resolve);M.sync(50,!1);t&&(c=window.setTimeout(a,500));return b.promise()}}).then(()=>{if(!f){var a=l(),c=()=>{rea.idle.queryState(n.MISC.IDLE_TIMEOUT,a=>{"active"==a?window.setTimeout(c,1E3*Math.round(n.MISC.IDLE_TIMEOUT/2)):b()})},b=()=>{let b;rea.windows.getAll({},e=>{e.forEach(a=>{"fullscreen"===
a.state&&(b=!0)});b?window.setTimeout(c,1E3*n.MISC.IDLE_TIMEOUT):a.resolve()})};c();return a.promise()}}).then(()=>{const d=l();c&&(window.clearTimeout(c),c=null);e&&e.cancel();p(t,b).done(a=>{d.resolve(a.installed)}).fail(()=>{d.resolve(null)});a=ba.getConfig();a.scripts=Date.now();ba.setConfig(a);return d.promise()})},getScriptFromURL:function(d){const f=l();["file:"].concat(n.REQUESTS.INTERNAL_PAGE_PROTOCOLS).includes(z.parse(d).protocol)?rea.file.get(d,b=>{f.resolve(I.arrbuf2str(b,"UTF-8"))},
b=>{f.reject({error:!0,responseText:b})}):ca.internal({method:"GET",retries:n.XMLHTTPREQUEST.RETRIES,timeout:1E3*n.SCRIPT_DOWNLOAD.TIMEOUT,revalidate:!0,headers:{Accept:"text/x-userscript, */*"},url:d},{onload:function(b){4!=b.readyState||200!=b.status&&0!=b.status||b.error?f.reject({error:!0,responseText:b.responseText}):f.resolve(b.responseText)},onerror:function(b){f.reject({error:!0,responseText:b.responseText})},ontimeout:function(){f.reject({timeout:!0,responseText:""})}});return f.promise()},
init:function(){const d=()=>{w&&(window.clearTimeout(w),w=null);0<g.values.scriptUpdateCheckPeriod&&(w=window.setTimeout(()=>{w=null;f.check();d()},36E5))};d();g.addChangeListener("scriptUpdateCheckPeriod",d)}};return f})();trup=da;var x=(()=>{const p=b=>{b.sort((a,c)=>a.position-c.position);return b},w=b=>{void 0===b.ask&&(b.ask=!0);if(void 0===b.url||null==b.url)b.url="";""===b.force_url&&(b.force_url=null);let a=D.createScriptFromSrc(b.src),c=null;const e={heading:null,errors:[],info:[],warnings:[],
flags:{}},k=l(),f=Date.now(),h=b.save&&!b.ask&&g.values.editor_easySave;let r=b.uuid,p;if(a.name&&void 0!=a.version)var w=l.Pledge();else e.errors.push(d.getMessage("Invalid_UserScript__Sry_")+"\n\n"),b.name&&e.errors.push(d.getMessage("Script_name_0name0",b.name)+"\n\n"),b.url&&e.errors.push(d.getMessage("Downloaded_from_0url0",b.url)),m.warn("scriptman: invalid userscript",e,a),w=l.Breach();w.then(()=>{b.replace&&!r&&(r=A.getUidsByName(a.name,a.namespace)[0]);if(r)c=A.getMetaByUid(r);else if(a.uuid)r=
a.uuid;else if(b.replace)r=y.createUUID();else return m.warn("scriptman: neither UUID, @uuid nor replace option set"),l.Breach();if(""!==r.replace(/[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}/,""))return m.warn("scriptman: invalid UUID",r),l.Breach();if(!b.clean&&!b.defaultscript&&c&&c.system)return l.Breach()}).then(()=>{if(b.clean&&b.name&&b.name!=a.name||-1!=a.name.search("\n"))return e.errors.push(d.getMessage("Invalid_UserScript_name__Sry_")),l.Breach()}).then(()=>{if(a.options.compat_uW_gmonkey)return e.errors.push(d.getMessage("This_script_uses_uW_gm_api_")),
l.Breach()}).then(()=>{if(c){c.name!=a.name&&(e.flags.renamed=!0);b.internal||c.evilness!=J.SEVERITY_FOISTED_SCRIPT||(e.warnings.push(d.getMessage("This_is_a_possibly_foisted_script_and_a_modification_will_enable_it_")),e.flags.forceAsk=!0);if(c.lastModified&&void 0!==b.lastModTime&&c.lastModified!==b.lastModTime){let a=d.getMessage("some_secs");try{const b=Math.max(1,Math.floor((f-c.lastModified)/1E3));isNaN(b)||(a=b)}catch(H){}e.warnings.push(d.getMessage("CONFLICT__This_script_was_modified_0t0_seconds_ago_",
a));e.flags.forceAsk=!0}a.version==c.version&&(b.save?e.flags.modification=!0:e.flags.reset=!0);b.clean&&(e.flags.factory=!0);p=!b.internal}else e.flags.first_install=!0,p=!b.internal||b.save;a.includes.length||a.matches.length||h||b.internal||e.warnings.push(d.getMessage("This_script_does_not_provide_any__include_information_"));e.flags.sync=!!b.sync;e.flags.internal=b.internal;e.flags.ask=b.ask;e.flags.save=b.save;e.flags.whitewash=b.whitewash}).then(()=>{a.uuid=r;a.system=b.defaultscript;a.evilness=
x.getEvilness(a);a.position=x.determineLastPosition()+1;a.lastModified=f;if(b.force_meta){let c;if(c=b.force_meta.fileURL)a.fileURL=c;if(c=b.force_meta.lastModified)a.lastModified=c}e.flags.factory||e.flags.reset?c&&(a.lastModified=c.lastModified):(b.force_url&&(a.updateURL=null,a.downloadURL=b.force_url),c&&(a.options.override=y.copy(c.options.override,{}),a.options.comment=c.options.comment,a.options.check_for_updates=c.options.check_for_updates));["includes","excludes","matches","connects"].forEach(c=>
{a.options.override["orig_"+c]=a[c]});a.options.override.orig_noframes=a.options.noframes;a.options.override.orig_run_at=a.options.run_at||"document-idle";a.options.noframes=null;a.options.run_at=null}).then(()=>{if(c&&(a.fileURL=c.fileURL,a.position=c.position,c.sync&&(a.sync=c.sync),!e.flags.factory&&!e.flags.reset)){a.enabled=c.enabled;a.options.noframes=c.options.noframes;a.options.run_at=c.options.run_at;a.options.awareOfChrome||(a.options.compat_forvarin=c.options.compat_forvarin);b.save&&!b.force_url&&
(a.downloadURL=c.downloadURL||a.downloadURL);var k=t.determineMetaURL(c),f=t.determineMetaURL(a);k=k?z.woHash(k):k;f=f?z.woHash(f):f;k==f||h||b.internal||e.warnings.push(d.getMessage("The_update_url_has_changed_from_0oldurl0_to__0newurl0",[k,f]));b.save||(f=c.options.override.orig_matches||c.matches,k=c.options.override.orig_excludes||c.excludes,y.adiff(c.options.override.orig_includes||c.includes,a.includes,"notinfirst").length+y.adiff(f,a.matches,"notinfirst").length+y.adiff(a.excludes,k,"notinfirst").length&&
e.warnings.push(d.getMessage("At_least_one_of_the_include_match_or_exclude_statements_was_changed_")),y.adiff(c.connects||[],a.connects||[],"notinfirst").length&&e.warnings.push(d.getMessage("At_least_one_new_connect_statement_was_added_")))}}).then(()=>{if(c&&!e.flags.factory&&a.version==c.version&&(b.defaultscript||b.noreinstall))return l.Breach()}).then(()=>{c?(e.flags.factory||e.flags.reset?(e.flags.reset?(e.heading=d.getMessage("You_are_about_to_reinstall_a_UserScript_"),e.flags.reinstall=!0):
(e.heading=d.getMessage("You_are_about_to_install_a_UserScript_"),e.flags.install=!0),b.internal||e.warnings.splice(0,0,d.getMessage("All_script_settings_will_be_reset_"))):e.flags.modification?e.heading=d.getMessage("You_are_about_to_modify_a_UserScript_"):D.versionCmp(a.version,c.version)==D.versionCmp.eOLDER?(e.heading=d.getMessage("You_are_about_to_downgrade_a_UserScript"),e.flags.downgrade=!0,h||b.internal||e.warnings.splice(0,0,d.getMessage("The_downgraded_script_might_have_problems_to_read_its_stored_data_"))):
(e.heading=d.getMessage("You_are_about_to_update_a_UserScript_"),e.flags.update=!0),e.info.push({label:d.getMessage("Installed_Version_"),value:"v"+c.version})):(e.heading=d.getMessage("You_are_about_to_install_a_UserScript_"),h||b.internal||(e.info.splice(0,0,d.getMessage("Malicious_scripts_can_violate_your_privacy_")),J.getWarningsFor(t.determineSourceURL(a)).forEach(a=>{e.warnings.splice(0,0,a)})),e.flags.install=!0);e.flags.whitewash?e.action=d.getMessage("Enable"):e.flags.install?e.action=d.getMessage("Install"):
e.flags.reinstall?e.action=d.getMessage("Reinstall"):e.flags.modification?e.action=d.getMessage("Modify"):e.flags.downgrade?e.action=d.getMessage("Downgrade"):e.flags.update&&(e.action=d.getMessage("Update"))}).then(()=>{b.url&&(a.fileURL=b.url);b.sync&&(a.sync=b.sync);b.force_options&&y.copy(b.force_options,a.options,(new D.Script).options,!0);b.force_settings&&y.copy(b.force_settings,a,["enabled","position"]);a=x.mergeCludes(a)}).then(()=>{var c=!1;for(const b in a.options)if(-1!=b.search("compat_")&&
!0===a.options[b]){c=!0;break}c&&e.info.push({label:d.getMessage("Note"),value:d.getMessage("A_recheck_of_the_GreaseMonkey_FF_compatibility_options_may_be_required_in_order_to_run_this_script_")});let k,f;(k=t.determineOrigin(a))&&(f=k.convert)&&(c=f(a),c.warning&&(b.internal?e.info.push(c.warning):e.warnings.push(c.warning)),a=c.script)}).then(()=>{["requires","resources"].forEach(c=>{a[c]=y.map(a[c],c=>{c.unsafe_url=c.url;c.abs_url=a.fileURL?a.fileURL.split("/").slice(0,-1).join("/"):null;c.url=
null;return c})})}).done(()=>{k.resolve({script:a,oldscript:c,messages:e,trigger_sync:!!p,short_info:[{label:d.getMessage("Author"),prop:"author"},{label:d.getMessage("Description"),prop:"description"},{label:d.getMessage("Source"),prop:"fileURL"}]})}).fail(()=>{k.reject({messages:e})});return k.promise()},f=b=>{const a=l(),c=b.messages,e=b.script,d=b.trigger_sync,f=()=>{c.flags.modification||P.dropAll(e.uuid);a.notify();const b=t.doModify(e.uuid,e,d)||{};!c.flags.install&&!c.flags.update||c.flags.factory||
c.flags.reset||N.tS(e.name,e.fileURL,c.flags.install?"i":"u");(c.flags.first_install||c.flags.factory)&&A.setStorageByUid(e.uuid,{ts:Date.now()});return b},h={uuid:e.uuid,lastModified:void 0,installed:!0,renamed:c.flags.renamed};c.warnings.length||c.flags.ask?Z.install(b).done(c=>{c.ok&&f();h.installed=c.ok;h.aborted=c.aborted;a.resolve(h)}).fail(c=>{a.reject(c)}):window.setTimeout(()=>{f();a.resolve(h)},1);return a.promise()},h=y.getDebouncer(1E3);var t={determineSourceURL:function(b){return b?y.select([b.downloadURL,
b.fileURL],a=>{if(!a||"file:"!==z.parse(a).protocol)return a})[0]:null},determineMetaURL:function(b){if(!b)return null;let a;const c=x.determineOrigin(b);c&&c.meta_header?a=b.fileURL:!b.fileURL||c&&!c.meta_url||(a=b.fileURL.replace(".user.js",".meta.js"),b.fileURL==a&&(a=b.fileURL.replace(".tamper.js",".meta.js")),b.fileURL==a&&(a=null));return y.select([b.updateURL,b.downloadURL,a],a=>{if(!a||"file:"!==z.parse(a).protocol)return a})[0]},mergeCludes:function(b){let a,c;const e=b.options.override;
["includes","excludes","matches"].forEach(a=>{b[a]=e["merge_"+a]&&e["orig_"+a]?e["orig_"+a].slice():[]});if(e.use_includes)for(a=0;a<e.use_includes.length;a++)c=b.excludes.indexOf(e.use_includes[a]),0<=c&&b.excludes.splice(c,1),b.includes.push(e.use_includes[a]);if(e.use_matches)for(a=0;a<e.use_matches.length;a++)c=b.excludes.indexOf(e.use_matches[a]),0<=c&&b.excludes.splice(c,1),b.matches.push(e.use_matches[a]);if(e.use_excludes)for(a=0;a<e.use_excludes.length;a++)b.excludes.push(e.use_excludes[a]);
return b},doSave:function(b){return w(b).then(f)},doRemove:function(b,a){A.removeByUid(b,a);A.setStorageByUid(b,null);P.dropAll(b);return l.Pledge()},doModify:function(b,a,c){void 0===c&&(c=!0);A.setByUid(b,a,c);return c?P.loadResources(b,a.resources).then(()=>P.loadRequires(b,a.requires)).then(()=>{const c=[].concat(a.resources).concat(a.requires).map(a=>z.sanitize(a.unsafe_url,a.abs_url));return P.dropAllBut(b,c)}):l.Pledge()},exportToJson:function(b,a){const c=l();var e=x.determineScriptsToRun(null);
b&&(e=y.select(e,a=>b[a.uuid]));e=ua(e,{options_page:!0,externals:a.externals});a&&!a.storage||e.forEach(a=>{a.storage=A.getStorageByUid(a.uuid)});e={scripts:e};if(!a||a.global_settings)e.global_settings=u.getValue(n.CONSTANTS.STORAGE.CONFIG,{});c.resolve(e);return c.promise()},importFromJson:function(b){if(!b||!b.scripts||!b.scripts.length)return l.Breach();const a={},c=[],e={},d={requires:{},resources:{}};for(let k=0,f;f=b.scripts[k];k++)try{const b=l();"new-user-script"!=f.uuid&&(f.storage&&(e[f.uuid]=
f.storage),["resources","requires"].forEach(a=>{let c;if(c=f[a])d[a][f.uuid]=c}),w({uuid:f.uuid,name:f.name,src:f.source,force_settings:{enabled:f.enabled,position:f.position},force_options:f.options,force_meta:{lastModified:f.lastModified},replace:!0,url:f.file_url||f.update_url,ask:!1}).done(c=>{a[y.createUUID()]=c;b.resolve()}).fail(a=>{m.warn("import: Error @ script",f.name,a);b.resolve()}),c.push(b.promise()))}catch(E){m.warn("import: Error while importing script",f.name,E)}const h=(()=>{const a=
l();l.when(c).always(()=>{a.resolve()});return a.promise()})().then(()=>Z.import(a,b.global_settings)).then(c=>{const b=l(),k=[],h=[];if(c.ok)for(let b=0,g;g=c.import_ids[b];b++)(()=>{var c=g;if(a[c]){a[c].messages.warnings=[];const b=a[c].script.uuid;c=f(a[c]).progress(()=>{["resources","requires"].forEach(a=>{let c;(c=d[a][b])&&c.length&&c.forEach(a=>{P.setElement(b,a.url,{content:a.content||"",meta:a.mimetype||"text/javascript"},a.modified)})})}).done(()=>{let a;e[b]&&(a=A.setStorageByUid(b,{data:e[b].data||
{},ts:Date.now()}),h.push(a))});k.push(c)}})();l.when(k).always(()=>{x.reorderScripts();l.when(h).always(()=>{b.resolve(c)})});return b.promise()}).then(a=>b.global_settings&&a.global_settings?(a=u.setValue(n.CONSTANTS.STORAGE.CONFIG,b.global_settings).then(()=>{h.done(()=>{window.setTimeout(Y.reset,1)});return l.Pledge({global_settings:!0})}),u.setTemporary(!0),a):l.Pledge({}));return h},installFromUrl:function(b,a,c){const e=l();let k;const f={messages:{errors:[d.getMessage("Unable_to_load_script_from_url_0url0",
b)],warnings:[]}};a=a||{};c=c||{};const g=["url",b,JSON.stringify(a)].join("_");if(h.is(g))return m.debug("scriptman: de-bounced installFromUrl",b),l.Breach();h.add(g);if((k=z.parse(b))&&k.protocol.match(/(https?|file):/))"file:"!=k.protocol||n.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||m.warn("scriptman: Access to local files is forbidden! Loading the following script for installation may fail:",b,"-> more info:","https://www.tampermonkey.net/faq.php#Q204");else return m.warn("scriptman: can't install from ",
b),l.Breach(f);da.getScriptFromURL(b).then(d=>{const k={url:b,src:d,ask:!0,replace:!0};a&&y.each(a,(c,b)=>{k[b]=a[b]});e.consume(t.installFromSource(d,k,c))}).fail(a=>{a?("file:"!=k.protocol||n.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||f.messages.warnings.unshift(d.getMessage("Tampermonkey_has_no_file_access_permission_")),f.heading=d.getMessage("You_are_about_to_install_a_UserScript_"),c.silent_fail?e.reject(f):Z.installError(f).always(a=>{e.reject(a)})):e.reject()});return e.promise()},installFromSource:function(b,
a,c){const e=l(),k={src:b,ask:!0,replace:!0};a&&y.each(a,(c,b)=>{k[b]=a[b]});t.doSave(k).done(a=>{e.resolve(a.installed)}).fail(a=>{a?(a.heading=d.getMessage("You_are_about_to_install_a_UserScript_"),c.silent_fail?e.reject(a):Z.installError(a).always(a=>{e.reject(a)})):e.reject()});return e.promise()},determineLastPosition:function(){let b=0;A.getUidList().forEach(a=>{const c=A.getByUid(a);c.script&&c.cond?c.script.position&&c.script.position>b&&(b=c.script.position):m.warn("scriptman: inconsistent script entry",
a)});const a=new D.Script;a.position>b&&(b=a.position);return b},convertToRegExp:function(b,a){let c,e;try{a||"/"!=b.substr(0,1)?a?(e=z.getRegExpFromMatch(b),c=new RegExp(e)):(e=z.getRegExpFromInclude(b),c=new RegExp(e,"i")):(e=("^"==b.substr(1,1)?"":".*")+b.replace(/^\//g,"").replace(/\/$/g,"")+("$"==b.substr(-2,1)?"":".*"),e=e.replace(/(\.\*){1,}/g,".*"),c=new RegExp(e,"i"))}catch(k){return m.warn("scriptman: invalid regexp ",b),!1}return c},matchUrl:function(b,a){return""===b.replace(a,"")},regexify:function(b,
a){const c={},e={inc:"rinc",match:"rinc",exc:"rexc"};Object.keys(e).forEach(d=>{const k=b[d]&&b[d].length?b[d].map(a=>t.convertToRegExp(a,"match"===d)).filter(a=>!1!==a):null;if(k||a)c[e[d]]=(c[e[d]]||[]).concat(k||[])});return c},validUrl:function(b,a,c){let e=!1;if(a.rinc){if(a.rinc.every(a=>t.matchUrl(b,a)?(m.debug('scriptman: @include "'+a+'" matched'+(c?" ("+c+")":'"')),e=!0,!1):!0),!e)return e}else e=!0;a.rexc&&a.rexc.every(a=>t.matchUrl(b,a)?(m.debug('scriptman: @exclude "'+a+'" matched'+(c?
" ("+c+")":'"')),e=!1):!0);return e},getEvilness:function(b){let a=0;return b.fileURL&&(a=J.getEvilnessOf(b.fileURL))||b.downloadURL&&(a=J.getEvilnessOf(b.downloadURL))||b.updateURL&&(a=J.getEvilnessOf(b.updateURL))?(m.debug("scriptman: found blacklisted script",b),a):0},blackCheckAll:function(){A.getUidList().forEach(b=>{const a=A.getByUid(b);if(a.script&&a.cond){var c=x.getEvilness(a.script);if(c!==a.script.evilness){if(c||void 0!==a.script.evilness)m.debug("scriptman: write blacklist state of ",
a.script.name,c),c&&N.tS(a.script.name,c,"b");a.script.evilness=c;t.doModify(b,a.script,!1)}}})},reorderScripts:function(b,a){let c=t.determineScriptsToRun();if(b)for(var e=0;e<c.length;e++){const d=c[e];d.uuid==b&&(d.position=Number(a)+(d.position<a?.5:-.5))}c=p(c);b=1;for(a=0;a<c.length;a++)e=c[a],e.position=b++,t.doModify(e.uuid,e,!1)},getScriptHistoryForTab:function(b){if(C.get.empty(b.id))m.debug("bg: WARN: Tabs.get.urls["+b.id+"] is empty!");else return C.get.history(b.id);return{}},getUniqueScriptsForTab:function(b){const a=
{};C.get.empty(b.id)?m.debug("bg: WARN: Tabs.get.urls["+b.id+"] is empty!"):y.each(C.get.urls(b.id),(c,b)=>{X.isAllowed(b)&&(c=aa.get(c.frameId,b),[c.runners,c.disabled,c.evilness].forEach(c=>{c.forEach(c=>{a[c.uuid]={script:c}})}))});return a},scriptWillRun:function(b,a){if(a&&b){var c=L.items.regexp.get(b);if(!c){if(!(c=u.getValue(n.CONSTANTS.PREFIX.COND+b,null)))return;c=t.regexify(c,!0);L.items.regexp.set(b,c)}return!!t.validUrl(a,c,b)}},determineScriptsToRun:function(b,a){const c=[];m.log("scriptman: determineScriptsToRun @"+
b);A.getUidList().forEach(e=>{let f=!0;var h=0;b&&(h=Date.now(),f=t.scriptWillRun(e,b),h=Date.now()-h);const g=A.getByUid(e);g.script&&g.cond?(a&&1E3<h&&(m.warn("scriptman: checking "+g.script.name+"'s ("+e+") includes and excludes took "+h+"ms!"),O.all("status",{key:"slowdown",class:"warning",text:d.getMessage("Script_0name0_is_slowing_down_some_page_loads_",g.script.name),timeout:3E5})),f&&c.push(g.script)):m.warn("scriptman: inconsistent script entry",e,g)});return p(c)},isContexter:function(b){return b.options&&
("context-menu"===b.options.run_at||null===b.options.run_at&&"context-menu"===b.options.override.orig_run_at)},determineOrigin:function(b){return t.determineOriginOfUrl(b.fileURL||b.downloadURL||b.updateURL)},determineOriginOfUrl:function(b){if(b){var a=b.match(/https?:\/\/userscripts\.org\/scripts\/(source|version)\/([0-9]{1,9})\.user\.js/)||b.match(/https?:\/\/userscripts-mirror\.org\/scripts\/(source|version)\/([0-9]{1,9})\.user\.js/);if(a&&3==a.length)return{id:a[2],token:"uso",meta_url:!0,url:"http://userscripts-mirror.org/scripts/show/"+
a[2],issue_url:"http://contactbyweb.com/userscripts-mirror"};if((a=b.match(/https?:\/\/greasyfork\.org\/scripts\/([^/]+)\/code\/.*\.user\.js/))&&2==a.length)return b=a[1],{id:b,token:"gf",meta_url:!0,url:"https://greasyfork.org/scripts/"+b,issue_url:"https://greasyfork.org/scripts/"+b+"/feedback",updates_allowed:function(a){return!a.match(/https?:\/\/greasyfork\.org\/scripts\/([^/]+)\/code\/.*\.user\.js.*version=[0-9]+.*/)}};if((a=b.match(/https?:\/\/openuserjs\.org\/install\/([^/]+)+\/(.*)\.user\.js/))&&
3==a.length)return a.shift(),{id:a.join("/"),token:"ouj",meta_header:!0,url:"https://openuserjs.org/scripts/"+a[0]+"/"+a[1],issue_url:"https://openuserjs.org/scripts/"+a[0]+"/"+a[1]+"/issues"};if((a=b.match(/https?:\/\/monkeyguts\.com\/(codepages\/)?([0-9]{1,9})\.user\.js/))&&3==a.length)return b=a[2],{id:b,token:"mog",meta_url:!0,url:"https://monkeyguts.com/code.php?id="+b,issue_url:"https://monkeyguts.com/code.php?nav=rev&id="+b};if((a=b.match(/https?:\/\/raw\.githubusercontent\.com\/([^/]+)\/([^/]+)\/.*\.user\.js/)||
b.match(/https?:\/\/github\.com\/([^/]+)\/([^/]+)\/raw\/.*\.user\.js/)||b.match(/https?:\/\/github\.com\/([^/]+)\/([^/]+)\/releases\/download\/.*\.user\.js/))&&3==a.length)return a.shift(),b=a.join("/"),{id:b,token:"gh",url:"https://github.com/"+b,issue_url:"https://github.com/"+b+"/issues"};if((a=b.match(/https?:\/\/gitlab\.com\/([^/]+\/?[^/]*)\/([^/]+)\/raw\/.*\.user\.js/))&&3==a.length)return a.shift(),b=a.join("/"),{id:b,token:"gl",url:"https://gitlab.com/"+b,issue_url:"https://gitlab.com/"+b+
"/issues"};if((a=b.match(/https?:\/\/bitbucket\.org\/([^/]+)\/([^/]+)\/(?:raw|downloads)\/.*\.user\.js/))&&3==a.length)return a.shift(),b=a.join("/"),{id:b,token:"bb",url:"https://bitbucket.org/"+b,issue_url:"https://bitbucket.org/"+b+"/issues"};if((b=b.match(/https?:\/\/userstyles\.org\/styles\/userjs\/([^/]+)\/.*\.user\.js/))&&2==b.length)return b.shift(),{id:b[0],token:"usty",url:"https://userstyles.org/styles/"+b[0],issue_url:"https://forum.userstyles.org/post/discussion?Discussion/StyleID="+
b[0],convert:function(a){let c,b,f,h;const g=[{tag:"includes",re:/(?: \|\| \(new RegExp\("\^)([^$]+)(?:\$"\)\)\.test\(document\.location\.href\))/g,idx:1,value:function(a){return"/^"+a.replace(/\\\\(.)/g,"\\$1")+"$/"}},{tag:"includes",re:/(?: \|\| \(document\.location\.href\.indexOf\(")([^"]+)"(?:\) == 0\))/g,idx:1,value:function(a){return a+"*"}},{tag:"matches",re:/(?: \|\| \(document\.domain == ")([^"]+)"(?: \|\| document\.domain\.substring\(document\.domain\.indexOf\("[^"]+"\) \+ 1\) == "[^"]+"\))/g,
idx:1,value:function(a){return"*."+a}}],p=new RegExp("(?:if \\(false)("+g.map(a=>"(?:"+a.re.source+")").join("|")+")+","g");0===a.includes.length&&0===a.matches.length&&0===a.excludes.length&&a.options&&a.options.override&&a.options.override.orig_includes&&0===a.options.override.orig_includes.length&&a.options.override.orig_matches&&0===a.options.override.orig_matches.length&&(b=a.textContent.match(p))&&(b.forEach(c=>{g.forEach(b=>{for(;f=b.re.exec(c);)if(f.length>b.idx){const c=b.value(f[b.idx]);
a.options.override["orig_"+b.tag].push(c);a[b.tag].push(c);h=!0}})}),h&&(c=d.getMessage("Automatically_added_user_includes_for_compatibility_reasons_")));return{script:a,warning:c}}}}},clean:function(b){A.getUidList().forEach(a=>{const c=A.getByUid(a);if(!c.script||!c.cond){if(b)return m.warn("scriptman: inconsistent script entry",a,c);t.doRemove(a,!0)}})}};return t})();scma=x;var A=(()=>{let d=[];const l={init:function(){u.addDifferentOriginChangeListener(n.CONSTANTS.PREFIX.STORE,(d,h)=>{if(h&&h.hasOwnProperty("value")&&
h.origin){var f=d.replace(n.CONSTANTS.PREFIX.STORE,"");for(const b in h.value.data)h.value.data.hasOwnProperty(b)&&(()=>{const a=b,c=h.value.data[b];l.notifyStorageListeners({uuid:f},null,b=>{const e={data:{},ts:0};e.data[a]=c;e.ts=h.value.data.ts;const d={storage:e};void 0===e.data[a]&&(d.removed=a);b(d)})})()}})},getUidList:function(){const d=new RegExp("^"+n.CONSTANTS.PREFIX.SCRIPT_UID),h=[];u.listValues().forEach(f=>{-1!=f.search(d)&&h.push(f.replace(d,""))});return h},getUidsByName:function(d,
h){const f=[];l.getUidList().forEach(b=>{const a=l.getMetaByUid(b);!a||a.name!=d||h&&h!=a.namespace||f.push(b)});return f},getUidByName:function(d){return l.getUidsByName(d)[0]},getStorageByUid:function(d){d=u.getValue(n.CONSTANTS.PREFIX.STORE+d,{ts:0,data:{}});"undefined"===typeof d.ts&&(d.ts=0);"undefined"===typeof d.data&&(d.data={});return d},setStorageByUid:function(d,h){return h?u.setValue(n.CONSTANTS.PREFIX.STORE+d,h):u.deleteValue(n.CONSTANTS.PREFIX.STORE+d)},getMetaByUid:function(d){return u.getValue(n.CONSTANTS.PREFIX.META+
d,null)},getByUid:function(d,h){if(!d)return m.error("sb: no UUID set"),{};let f,b=u.getValue(n.CONSTANTS.PREFIX.META+d,null);if(b){const a=a=>{if(a)for(let c=0,b=null;b=a[c];c++)delete b.loaded,delete b.textContent,delete b.resURL,delete b.resText};a(b.requires);a(b.resources);b.uuid=d;b.grant=b.grant||[];b.options.override.use_connects||(b.connects=b.connects||[],b.options.override.merge_connects=!0,b.options.override.use_connects=[]);void 0===b.options.check_for_updates&&(b.options.check_for_updates=
!0);h&&(b=y.copy(b,{}));b.textContent=u.getValue(n.CONSTANTS.PREFIX.SCRIPT+d,b.textContent);b.textContent&&(f=b)}return{script:f,cond:u.getValue(n.CONSTANTS.PREFIX.COND+d,null)}},setByUid:function(d,h,g){const b={};if(!d)return m.error("sb: no UUID set",h),b;if(null===h.textContent||void 0===h.textContent)throw Error("No script code set!");const a=u.getValue(n.CONSTANTS.PREFIX.META+d),c=!a,e={},f=y.copy(h,{});f.textContent=null;e[n.CONSTANTS.PREFIX.META+d]=f;e[n.CONSTANTS.PREFIX.SCRIPT_UID+d]=h.name;
e[n.CONSTANTS.PREFIX.COND+d]={inc:h.includes,match:h.matches,exc:h.excludes};e[n.CONSTANTS.PREFIX.SCRIPT+d]=h.textContent;u.setValues(e);g&&(oa.onScriptsChanged(),c?M.scriptAddedCb(h.name,h):M.scriptChangedCb(h.name,h,a));L.items.rundata.removeAll();L.items.regexp.remove(d);return b},removeByUid:function(d,h){void 0===h&&(h=!0);const f=l.getByUid(d);u.deleteValue(n.CONSTANTS.PREFIX.SCRIPT_UID+d);u.deleteValue(n.CONSTANTS.PREFIX.COND+d);u.deleteValue(n.CONSTANTS.PREFIX.SCRIPT+d);u.deleteValue(n.CONSTANTS.PREFIX.META+
d);u.deleteValue(n.CONSTANTS.PREFIX.STORE+d);h&&(oa.onScriptsChanged(),f.script&&f.cond&&(M.scriptRemovedCb(f.script.name,f.script),g.values&&N.tS(f.script.name,null,"r")));L.items.rundata.removeAll();L.items.regexp.remove(d);return{}},addStorageListener:function(f,h,g,b,a){d.push({tabid:f,id:h,uuid:g,time:b,response:a})},removeStorageListeners:function(f,h){void 0===h&&(h=!0);const g=d;d=[];g.forEach(b=>{try{void 0!==f.tabid&&f.tabid!==b.tabid||void 0!==f.uuid&&f.uuid!==b.uuid||void 0!==f.id&&f.id!==
b.id?d.push(b):h&&b.response({})}catch(a){m.debug("sb: listener clear for script",f,"failed! Page reload?!")}})},notifyStorageListeners:function(f,h,g){f=f||{};h=h||{};d.forEach(b=>{try{void 0!==h.uuid&&b.uuid===h.uuid||void 0!==h.tabid&&b.tabid===h.tabid||void 0!==h.id&&b.id===h.id||void 0!==f.tabid&&f.tabid!==b.tabid||void 0!==f.uuid&&f.uuid!==b.uuid||void 0!==f.id&&f.id!==b.id||g&&g(b.response)}catch(a){m.warn("sb: listener notification for script",f,"failed! Page reload?!")}})}};return l})();
scbr=A;var sa=(()=>{const d=()=>{A.getUidList().forEach(d=>{const f=A.getByUid(d);f.script&&f.cond&&f.script.evilness!=J.SEVERITY_FOISTED_SCRIPT&&(m.warn("content security: found unfamiliar script",f.script.name),f.script.evilness=J.SEVERITY_FOISTED_SCRIPT,x.doModify(d,f.script,!1),N.tS(f.script.name,f.script.fileURL||f.script.downloadURL||f.script.updateURL,"f"))})};return{init:function(){return l.Pledge()},check:function(){return l.Pledge()},onInstalled:function(){n.DB.SECURE||d()},onUpdated:function(){}}})(),
za=(()=>{const p={ping:{allow:{insecure:!0},exec:function(a,c,b){b({pong:!0,instanceID:ya,config:{layout:g.values.layout,dark:rea.runtime.isDarkMode()}})}},newTab:{allow:{extpage:!0},exec:function(a,c,b){("options"==c.extpage||"options"==a.origin?l.Pledge(c.tab):ra()).then(c=>{rea.tabs.create({url:a.url,parent:c},a=>{b({tabId:a.id})})})}},tabs:{allow:{script:!0},exec:function(a,c,b){"get"==a.action?c.tab&&a.uuid?b({data:pa.get(c.tab.id,a.uuid)}):(m.warn("bg: unable to process request",c,a),b({data:null})):
"list"==a.action?a.uuid?b({data:pa.getAll(a.uuid)}):(m.warn("bg: unable to process request",c,a),b({data:null})):"set"==a.action?(c.tab&&a.uuid?pa.set(c.tab.id,a.uuid,a.tab):m.warn("bg: unable to process request",c,a),b({})):b({error:"unknown action"})}},focusTab:{allow:{script:!0},exec:function(a,c,b){(a=c&&c.tab?c.tab.id:null)?rea.tabs.update(a,{active:!0},()=>{const a=rea.runtime.lastError;b({error:a?a.message:void 0})}):b({error:"internal error"})}},closeTab:{allow:{script:!0},exec:function(a,
c,b){const d=c&&c.tab?c.tab.id:null;d?rea.tabs.query({windowType:"normal"},a=>{1>=a.length?(m.warn("bg:","refused to close last tab!"),b({error:"refused to close last tab!"})):rea.tabs.remove(d,()=>{const a=rea.runtime.lastError;b({error:a?a.message:void 0})})}):b({error:"internal error"})}},setOption:{allow:{extpage:!0},exec:function(a,c,b){const d="options"==c.extpage||"options"==a.origin;g.setValue(a.name,a.value).always(()=>{d?V.create("options.settings").done(a=>{b({items:a,options:g.snapshot})}).fail(a=>
{b({error:a,options:g.snapshot})}):b({})})}},reportAnIssue:{allow:{extpage:!0},exec:function(a,c,b){("options"==c.extpage||"options"==a.origin?l.Pledge(c.tab):ra()).then(c=>{let d,e,f,k;if(a.uuid&&(d=A.getByUid(a.uuid))&&d.script&&d.cond){e=x.determineOrigin(d.script);let b;if("hoster"==a.to&&e)f=e,k=[f.token,f.id].join(":");else if(b=d.script.supportURL||e.issue_url||e.url)f={issue_url:b},k=e?[a.to,e.token,e.id].join(":"):[a.to,f.url].join(":");f&&(N.tS(d.script.name,k,"m"),rea.tabs.create({url:f.abuse_url||
f.issue_url,active:!0,parent:c},()=>{}))}b({})})}},begEvent:{allow:{extpage:!0},exec:function(a,c,b){if("dialog"==a.action)ea.dialog.shown(a.extra);else if("clicked"==a.action){let c,b;a.extra&&(c=a.extra.amount,b=a.extra.currency);ea.clicked(a.type,c,b)}else if(ea.button[a.action])ea.button[a.action](a.type,a.extra);else m.warn("bg: Warning: unknown request ",a);b({})}},buttonPress:{allow:{extpage:!0},exec:function(a,c,b){c=()=>{b({})};if("reset_simple"==a.name)Y.reset(c);else if("reset_factory"==
a.name)Y.factoryReset(c);else if("reset_sync"==a.name)M.reset().always(c);else if("install_tests"==a.name)(c=va.framework.prepare(x,A,n.RUNTIME.BROWSER,n.RUNTIME.BROWSER_VERSION,c))&&m.error(c);else if("enabled"==a.name)g.setValue(a.name,!g.values[a.name]).always(()=>{b({})});else if("installFromUrl"==a.name)x.installFromUrl(a.data).always(()=>{b({})});else if("externals_delete"==a.name)P.cleanElement(a.scriptuid,a.safe_url),V.create("options.scripts").done(a=>{b({items:a,options:g.snapshot})}).fail(a=>
{b({error:a,options:g.snapshot})});else if("focus_tab"==a.name)p.focusTab.exec({},{tab:{id:a.tabid}},b);else if("run_script_updates"==a.name)if(a.scriptuid){let c;da.check(!0,!1,a.scriptuid).done(a=>{c=a}).always(()=>{b({scriptuid:a.scriptuid,updatable:c})})}else da.check(!0,!0),b({});else m.warn("bg: Warning: unknown button "+a.name),b({})}},loadTree:{allow:{extpage:!0},exec:function(a,c,b){V.create(a.referrer,{complete:a.complete,url:a.url,uuid:a.uuid,filter:a.filter,tabId:a.tabId}).done(c=>{c=
{items:c};const d=1==V.level(a.referrer)?{i18n:g.values.i18n,options:g.snapshot,xhr:U.getConfig(),version:rea.extension.manifest.version,begging:ea.needed()}:{};b(Object.assign(c,d))}).fail(a=>{b({error:a,options:g.snapshot})})}},modifyScriptOptions:{allow:{extpage:!0},exec:function(a,c,b){if(a.uuid){var e="options"==c.extpage||"options"==a.origin,f=void 0==a.reload||1==a.reload,h=!1,r=A.getByUid(a.uuid,!0),l=()=>{f?(void 0!==a.position&&x.reorderScripts(a.uuid,a.position),e?p.loadTree.exec({referrer:"options.scripts"},
c,b):rea.tabs.getSelected(null,c=>{V.create("actions").done(a=>{b({items:a,i18n:g.values.i18n,options:{enabled:g.values.enabled}})}).fail(()=>{b({i18n:g.values.i18n,options:{enabled:g.values.enabled}})});!c||0>c.id||a.uuid&&g.values.autoReload&&rea.tabs.sendMessage(c.id,{method:"reload",frameId:0},()=>{})})):b({})};if(r.script&&r.cond)if(a.whitewash&&r.script.evilness==J.SEVERITY_FOISTED_SCRIPT)f=!0,r.script&&r.cond?x.doSave({uuid:a.uuid,src:r.script.textContent,force_settings:{enabled:!0},whitewash:!0,
save:!0}).always(l):(m.error(d.getMessage("fatal_error")+" ("+a.uuid+")!!!"),l());else{let c=!1;const d=new D.Script;Object.keys(d.options).forEach(c=>{void 0!==a[c]&&(r.script.options[c]=a[c],h|=!0===M.SYNCED[c])});Object.keys(d.options.override).forEach(b=>{-1!=b.search("merge_")&&void 0!==a[b]&&(r.script.options.override[b]=a[b],c=!0)});["includes","excludes","matches"].forEach(b=>{void 0!==a[b]&&(c=!0,r.script.options.override["use_"+b]=a[b])});["connects","blockers"].forEach(c=>{void 0!==a[c]&&
(r.script.options.override["use_"+c]=a[c])});a.add_excludes&&(r.script.options.override.use_excludes=r.script.options.override.use_excludes.concat(a.add_excludes),c=!0);c&&(r.script=x.mergeCludes(r.script));a.temp_connects&&la.setSessionConnects(r.script.uuid,a.temp_connects);void 0!==a.enabled&&(r.script.enabled=a.enabled);h&&(r.script.lastModified=Date.now());void 0!==a.file_url&&(r.script.downloadURL=a.file_url);x.doModify(r.script.uuid,r.script,h).done(l).fail(()=>{b({})})}else b({})}else b({})}},
saveScript:{allow:{extpage:!0},exec:function(a,c,b){const e=void 0===a.reload||!!a.reload,f=a=>{e?V.create("options.scripts").done(c=>{a.items=c;a.options=g.snapshot;b(a)}).fail(a=>{b({error:a,options:g.snapshot})}):b({})};if(a.clean){m.debug("bg: clean userscript "+a.uuid);c=A.getByUid(a.uuid);const e=c=>{V.create("options.scripts").done(d=>{b({cleaned:c.installed,items:d,options:g.snapshot});c.installed&&A.notifyStorageListeners({uuid:a.uuid},null,c=>{c({storage:A.getStorageByUid(a.uuid)})})}).fail(a=>
{b({error:a,options:g.snapshot})})};c.script&&c.cond?x.doSave({name:a.name,uuid:a.uuid,src:c.script.textContent,clean:!0,ask:!1,internal:!0,save:!0}).always(a=>{e(a||{installed:!1})}):(m.error(d.getMessage("fatal_error")+" ("+a.uuid+")!!!"),e({installed:!1}))}else if(a.code){let c=b;e&&(c=a=>{x.reorderScripts();f(a)});a.new_script&&(a.uuid=y.createUUID());x.doSave({name:a.name,uuid:a.uuid,force_url:a.force_url,src:a.code,ask:!g.values.editor_easySave,lastModTime:a.lastModTime,save:!0}).always(a=>
{c(a||{installed:!1})})}else a.auto_save||(x.doRemove(a.uuid),x.reorderScripts()),f({})}},saveExternal:{allow:{extpage:!0},exec:function(a,c,b){P.setElement(a.uuid,a.url,{content:a.code||"",meta:a.mimetype||"text/javascript"},!0);V.create("options.scripts").done(a=>{b({success:!0,items:a,options:g.snapshot})}).fail(a=>{b({error:a,options:g.snapshot})})}},saveStorageKey:{allow:{extpage:!0},exec:function(a,c,b){h.saveStorageKey.exec(null,a,c,b)}},exportToJson:{allow:{extpage:!0},exec:function(a,c,b){x.exportToJson(a.ids,
a.options).done(a=>{b({json:a})}).fail(()=>{b({})})}},importFromJson:{allow:{extpage:!0},exec:function(a,c,b){const e=void 0===a.reload||!!a.reload;x.importFromJson(a.json).fail(a=>{b({error:a||d.getMessage("An_error_occured_during_import_")})}).done(a=>{const c={reload:a.global_settings};e&&!c.reload?V.create("options.scripts").done(a=>{c.items=a;c.options=g.snapshot;b(c)}).fail(a=>{b({error:a,options:g.snapshot})}):b(c)})}},download:{allow:{extpage:!0},exec:function(a,c,b){h.download.exec(null,
a,c,a=>{(a.error||a.load)&&b(a)})}},askCom:{allow:{extpage:!0},exec:function(a,c,b){Z.onMessage(a.data).always(a=>{a.i18n=g.values.i18n;a.options=g.snapshot;a.ext={version:rea.extension.manifest.version};b(a)})}},installScript:{allow:{extpage:!0},exec:function(a,c,b){if(c.tab){let c={};a=a.code?x.installFromSource(a.code,{},{silent_fail:!0}):x.installFromUrl(a.url,{},{silent_fail:!0});a.done(a=>{c={data:null,found:!0,installed:a}}).fail(a=>{c.err=a&&a.messages&&a.messages.errors?a.messages.errors[0]:
d.getMessage("Unable_to_parse_this_")}).always(()=>{b(c)})}else m.warn("bg: Error: unable to install script due to empty tabID!")}},execMenuCmd:{allow:{extpage:!0},exec:function(a,c,b){(a=fa.getById(a.id))?a.response({run:!0,menuId:a.id}):m.warn("bg: Error: unable to find MC id "+a.id);b({})}},unLoad:{allow:{script:!0},exec:function(a,c){a.topframe||a.id&&c.tab&&c.frameId&&C.events.unload(c.tab.id,c.frameId,a.id);return!1}},prepare:{allow:{script:!0},exec:function(a,c,b){if(c.tab){const d=void 0!==
c.frameId?c.frameId:a.topframe?0:null,e=z.woHash(a.url);a.cleanup?(C.events.clean(c.tab.id,d,e),R.setIcon(c.tab.id),R.setBadge(c.tab.id),b({})):C.events.run(c.tab.id,d,a.id,e,d=>{d=d?aa.answer(d,a.url):{fast:!0};b(d);R.setIcon(c.tab.id);R.setBadge(c.tab.id)})}else b({})}},notification:{allow:{script:!0,extpage:!0},exec:function(a,c,b){const d=a.image?a.image:Q.images.brand("tampermonkey");(()=>{const b=l();a.highlight&&c.tab?W.highlight(c.tab.id,b.resolve):b.resolve();return b.promise()})().then(()=>
{const c=l();a.text?W.show(a.title,a.text,d,{timeout:a.timeout,silent:a.silent},c.resolve):c.resolve();return c.promise()}).always(a=>{b({clicked:a&&a.clicked})})}},clipboard:{allow:{script:!0,extpage:!0},exec:function(a,c,b){rea.clipboard?rea.clipboard.set({mimetype:a.mimetype,content:a.content},()=>{b({success:!0})}):b({error:"unsupported"})}},determineScriptsToRun:{allow:{extpage:!0},exec:function(a,c,b){b({scripts:x.determineScriptsToRun(a.url).map(a=>a.uuid)})}},syntaxCheck:{allow:{script:!0,
extpage:!0},exec:function(a,c,b){(()=>{const a=l();Registry.require("hinter",()=>{a.resolve(Registry.get("hinter"))});return a.promise()})().then(c=>c.hint(a.code,g.values.editor_linter_config||void 0)).always(a=>{b({errors:a})})}},externalMessage:{allow:{insecure:!0},exec:function(a,c,d){{a=a.request;let k;if("off"!=g.values.external_connect&&(k=c.url)&&X.isAllowed(k)){var e,f=Object.keys(b.externally_connectable);for(let d=0;d<f.length;d++){var h=f[d];c=b.externally_connectable[h];if((e=x.regexify({match:[h]}))&&
x.validUrl(k,e)&&(c.includes("*")||c.includes(a.method))){var p=!0;break}}if(p)if("getVersion"==a.method)d({version:rea.extension.manifest.version,id:rea.runtime.short_id});else if("all"!=g.values.external_connect)m.warn("mh: calling external method "+a.method+" is not permitted to "+k+" by the user");else if("isInstalled"==a.method){let c,b,f,k;e=!1;p=a.script.name;(b=A.getUidsByName(p,a.script.namespace)[0])&&(c=A.getByUid(b))&&c.script&&(e=!0,k=c.script.enabled,f=c.script.version);d({name:p,installed:e,
enabled:k,version:f})}else m.warn("mh: unknown external method "+a.method);else m.warn("mh: calling external method "+a.method+" is not permitted to "+k)}}}},cookie:{allow:{script:!0},exec:function(a,c,b){const d="expirationDate domain httpOnly secure session name path sameSite value".split(" ").concat(["url"]),e=d.concat(["hostOnly"]),f=a.url||c.url||null,h=a.details.url?z.sanitize(a.details.url,f)||a.details.url:f;let g,p;T.fpi&&(g=z.parse(f).domain,p=c.tab?c.tab.cookieStoreId:void 0);if(n.DB.SECURE||
"dhdg"!=rea.runtime.short_id)if(h)if(X.isAllowed(z.woHash(h)))if(x.scriptWillRun(a.uuid,h))if("list"==a.action)T.getAll({url:h,domain:a.details.domain,name:a.details.name,path:a.details.path,firstPartyDomain:g?null:void 0,storeId:p}).done(a=>{a=a.map(a=>{const c={};e.forEach(b=>{c[b]=a[b]});return c});b({data:{cookies:a}})});else if("delete"==a.action)T.remove({url:h,name:a.details.name,firstPartyDomain:g,storeId:p}).done(()=>{b({data:{success:!0}})}).fail(a=>{b({data:{error:a}})});else if("set"==
a.action){const c={firstPartyDomain:g,storeId:p},e=a.details;d.forEach(a=>{void 0!==e[a]&&(["value","name"].includes(a)?c[a]=String(e[a]):c[a]=e[a])});c.url=c.url||h;T.set(c).done(()=>b({data:{success:!0}})).fail(a=>b({data:{error:a}}))}else b({data:{error:"unknown action"}});else b({data:{error:"the URL needs to be included by the scripts @include or @match tag"}});else b({data:{error:"the URL is filtered by the security settings"}});else b({data:{error:"invalid URL"}});else b({data:{error:"not supported"}})}},
api:{allow:{script:!0},exec:function(a,c,b){N.tA(a.name,a.type);b()}}},w=a=>{var c=rea.runtime.id;c=!n.REQUESTS.HAS_SENDER_ID&&a.tab||a.id===c;let b=null;var d=n.REQUESTS.INTERNAL_PAGE_PROTOCOLS[0];d=d?d+"//":null;var f=n.REQUESTS.GET_INTERNAL_PAGE_REGEXP();a=a.url?a.url:a.tab?a.tab.url:null;let h=c&&(!a||(d?0==a.search(d):!1));if(h||!d)a?(f=a.match(f))&&2==f.length&&(b=f[1]):b="*",!d&&b&&(h=!0);return{id_valid:c,url:a,page:b,extpage:h}},f=(a,c,b)=>{if(!G.late)return G.registerLateCallback(()=>{f(a,
c,b)}),!0;var d=p[a.method];if(!d)return m.warn("mh: unknown method "+a.method),!1;if(!d.allow||!d.exec)return m.warn("mh: invalid implementation of "+a.method),!1;var e=w(c);const h=e.extpage,g=e.page;e=e.id_valid;h?c.extpage=g:delete a.origin;const l="options"==g;let t=!0;if("background"==g||d.allow.insecure||d.allow.extpage&&h||d.allow.options&&l||d.allow.script&&e&&!h)return d=d.exec(a,c,a=>{t=!1;b(a)}),!1===t||!1===d?void 0:!0;!1===a.topframe&&(h||l)||m.warn("mh: this context doesn't have the permission to call \""+
a.method+'"');return!1};var h={xhr:{allow:{script:!0},exec:function(a,c,b,d){let e=!1;const f=n.RUNTIME.FIREFOX&&!c.details.anonymous&&(b.tab&&b.tab.incognito||T.fpi);let h,k;f&&(c.details.anonymous=!0,h=b.tab?b.tab.cookieStoreId:void 0,T.fpi&&b.url&&(k=z.parse(b.url).domain||""));const p=b=>{a.disconnect();const d=b.response;b=d?d.responseHeaders:null;f&&b&&(b=U.parseHeaders(b)["set-cookie"])&&b.split(",").forEach(a=>{if(a=U.parseCookie(a)){var {expires:b,httpOnly:e,name:f,path:g,sameSite:p,secure:q,
value:l}=a;T.set({expirationDate:b?b.getTime():void 0,httpOnly:e,name:f,path:g,sameSite:p,secure:q,storeId:h,url:d.finalUrl||c.details.url,value:l,firstPartyDomain:k})}})};c.details.convertBinary=!0;c.details.partialSize=c.details.partialSize||n.XMLHTTPREQUEST.PARTIAL_SIZE;const v={};Object.keys(c.callbacks).forEach(a=>{const b="ondone"===a;if(c.callbacks[a]||b||"onload"===a)v[a]=c=>{const e={data:c.response,exception:c.exception};e[a]=!0;d(e);b&&p(c)}});v.ondone||(v.ondone=p);let m;c.details.url=
z.sanitize(c.details.url,c.url||b.url||null)||c.details.url;n.RUNTIME.WEBREQUEST_XHR_SUPPORT&&"no"!=g.values.webrequest_modHeaders&&(c.details.headers=c.details.headers||{},c.details.headers.internal=c.uuid,n.REQUESTS.SENDS_ORIGIN&&!Object.keys(c.details.headers).map(a=>a.toLowerCase()).includes("origin")&&(c.details.headers.origin=null));(()=>(c.details.cookie||f)&&c.details.url?T.getAll({url:c.details.url,storeId:h,firstPartyDomain:k?null:void 0}).then(a=>{a=a.map(a=>a.name+"="+encodeURIComponent(a.value)).concat([c.details.cookie]).join(";");
delete c.details.cookie;c.details.headers=c.details.headers||{};c.details.headers.cookie=a}):l.Pledge())().then(()=>{if(!e){var a;if(c.details.url&&(a=z.parse(c.details.url).protocol)&&["file:"].concat(n.REQUESTS.INTERNAL_PAGE_PROTOCOLS).includes(a)){const b=a=>{const b='Refused to connect to "'+c.details.url+'": '+a,d=U.makeErrorResponse(b);["onerror","ondone"].forEach(a=>{if(v[a])v[a]({response:d,exception:b})})};if("file:"==a){let a,d;n.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS&&("all"==g.values.script_file_access?
a=!0:"externals"==g.values.script_file_access&&(d=A.getByUid(c.uuid))&&d.script&&d.cond&&[].concat(d.script.resources).concat(d.script.requires).map(a=>z.sanitize(a.unsafe_url,a.abs_url)).includes(c.details.url)&&(a=!0));if(!a)return b("Access to this local file is forbidden!")}rea.file.get(c.details.url,a=>{const c={response_data:I.arrbuf2str(a),readyState:4,responseHeaders:"",status:0,statusText:""};["onload","ondone"].forEach(a=>{if(v[a])v[a]({response:c})})},b)}else m=la.exec(c.details,c.uuid,
b||{},v)}});return()=>{e=!0;m&&m.abort()}}},download:{allow:{script:!0},exec:function(a,c,b,d){c=c.details;c.internal=null===a;let e=K.start(c,{onload:a=>{d&&d({load:!0,data:a})},onprogress:a=>{d&&d({progress:!0,data:a})},onerror:a=>{d&&d({error:!0,data:a})},ontimeout:a=>{d&&d({timeout:!0,data:a})},ondone:()=>{a&&a.disconnect();a=null}});a&&void 0!==e&&a.onMessage.addListener(a=>{a.cancel&&null!==e&&(K.cancel(e),e=null)});return()=>{d=a=null}}},webRequest:{allow:{script:!0},exec:function(a,c,b,d){a=
b.tab.id;b=b.frameId;(void 0!==a&&void 0!==b||!c.uuid)&&ka.scripts.set(a,b,c.uuid,c.rules,a=>{d(a)})}},addStorageListener:{allow:{script:!0},exec:function(a,c,b,d){if(b.tab)return A.addStorageListener(b.tab.id,c.id,c.uuid,Date.now(),d),()=>{A.removeStorageListeners({uuid:c.uuid,id:c.id},!1)};d({error:!0})}},saveStorageKey:{allow:{script:!0},exec:function(a,c,b,d){b.tab?c.uuid&&(a=A.getStorageByUid(c.uuid),a.data[c.key]=c.value,a.ts=c.ts,A.setStorageByUid(c.uuid,a),A.notifyStorageListeners({uuid:c.uuid},
{id:c.id},a=>{const b={data:{},ts:0};b.data[c.key]=c.value;b.ts=c.ts;const d={storage:b};void 0===b.data[c.key]&&(d.removed=c.key);a(d)})):m.warn("storage: unable to save storage due to empty tabID!");d({})}},openInTab:{allow:{script:!0},exec:function(a,c,b,d){const e=["active"],f={url:c.details.url};let h=null;if(c=c.details.options){for(let a=0;a<e.length;a++)void 0!==c[e[a]]&&(f[e[a]]=c[e[a]]);c.incognito?f.incognito=!0:(c.insert&&(f.index=b.tab.index+1),c.setParent&&(f.parent=b.tab))}rea.tabs.create(f,
b=>{b&&(h=b.id,a&&(ia[h]={onClose:function(){a&&d({closed:!0})}},d({success:!0,tabId:h})))});a.onMessage.addListener(a=>{if(null!==h)if(a.close)rea.tabs.remove(h,()=>{const a=rea.runtime.lastError;a?m.warn("tab.close",a.message):h=null});else if(void 0!==a.name){let b=0;const c=()=>{C.listeners.once.whenReady(h,()=>{rea.tabs.sendMessage(h,{method:"setForeignAttr",attr:"name",value:a.name},e=>{e?d({name:a.name}):5>b++?window.setTimeout(c,100*b):m.warn("foreignAttr: error setting attr")})})};c()}});
return()=>{null!==h&&delete ia[h];a=null}}},registerMenuCommand:{allow:{script:!0},exec:function(a,b,d,f){if(d.tab)return fa.add(d.tab.id,b.name,b.uuid,b.accessKey,b.menuId,f),O.actionPage("update"),()=>{fa.clearById(b.menuId);O.actionPage("update")};m.warn("Unable to register menu cmd due to empty tabID!");a.disconnect()}},tabWatch:{allow:{extpage:!0},exec:function(a,b,d,f){const c=wa.openAndWatch({url:b.url,index:(d.tab.index||0)+1,parent:d.tab},b=>{b?f({tab:b}):(c.cancel(),a.disconnect())});return()=>
{c.cancel()}}}};const t=(()=>{const a=(a,b)=>{const c=a.sender,d=h[b.method];if(!d)return m.warn("mh: unknown method "+b.method),!1;if(!d.allow||!d.exec)return m.warn("mh: invalid implementation of "+b.method),!1;var e=w(c);const f=e.extpage,g=e.page;e=e.id_valid;const p="options"==g;if("background"==g||d.allow.insecure||d.allow.extpage&&f||d.allow.options&&p||d.allow.script&&e&&!f)(b=d.exec(a,b,c,b=>{try{a.postMessage(b)}catch(H){m.debug("bg: Error sending port ("+a.name+") message",b)}}))&&a.onDisconnect.addListener(b);
else return!1===b.topframe&&(f||p)||m.warn("mh: this context doesn't have the permission to call \""+b.method+'"'),!1};return b=>{G.late?b.onMessage.addListener(c=>{void 0!==c.method&&a(b,c)}):G.registerLateCallback(()=>{t(b)})}})();var b={init:function(){b.externally_connectable_reg=x.regexify({match:Object.keys(b.externally_connectable)});rea.extension.onMessage.addListener(f);rea.extension.onConnect.addListener(t);rea.extension.onConnectExternal.addListener(a=>{a.disconnect()})},externally_connectable:{"*://www.tampermonkey.net/*":["getVersion"],
"https://greasyfork.org/*":["*"],"https://userstyles.org/*":["*"]}};return b})(),T=(()=>{const d=(d,f)=>{n.RUNTIME.FPI?void 0!==f&&(d.firstPartyDomain=d.firstPartyDomain||f):delete d.firstPartyDomain;return d};let g;const f={getAll:function(f){const h=l();rea.cookies.getAll(d(f,null),h.resolve);return h.promise()},remove:function(f){const h=l();rea.cookies.remove(d(f),b=>{b?h.resolve():(b=rea.runtime.lastError,h.reject(b?b.message:"unknown error"))});return h.promise()},set:function(f){const h=l();
rea.cookies.set(d(f),b=>{b?h.resolve():(b=rea.runtime.lastError,h.reject(b?b.message:"unknown error"))});return h.promise()}};Object.defineProperties(f,{fpi:{get:()=>g}});n.RUNTIME.FPI&&rea.cookies.remove({url:"https://www.tampermonkey.net",name:"doesnotexist"},()=>{rea.runtime.lastError&&(g=!0)});return f})(),fa=(()=>{let d=[];return{add:function(g,f,h,p,b,a){d.push({tabId:g,name:f,uuid:h,accessKey:p,id:b,response:a})},list:function(){return d},listByTabId:function(g){const f={};return d.filter(d=>
{const h=d.uuid+d.name;return d.tabId==g&&!f[h]&&(f[h]=!0)})},clearByTabId:function(g){d=d.filter(d=>d.tabId!=g)},getByTabId:function(g){return d.filter(d=>d.tabId==g)[0]},clearById:function(g){d=d.filter(d=>d.id!=g)},getById:function(g){return d.filter(d=>d.id==g)[0]}}})(),Fa=(()=>({create:function(){let p;let l,f,h,t,b,a;let c,e,k,B;var q=null;p={id:"general",name:d.getMessage("General"),sub_menu_item:!0,items:[]};p.items.push({name:d.getMessage("Config_Mode"),id:"configMode",level:0,option:!0,
select:[{name:d.getMessage("Novice"),value:0},{name:d.getMessage("Beginner"),value:50},{name:d.getMessage("Advanced"),value:100}],value:g.values.configMode,desc:d.getMessage("Changes_the_number_of_visible_config_options")});p.items.push({name:d.getMessage("Language"),id:"i18n",level:0,option:!0,reload:!0,warning:d.getMessage("A_reload_is_required"),select:[{name:"Browser Default",value:null}].concat(d.supported),value:g.values.i18n,validation:{image:"info",opacity:.9,msg:d.getMessage("Your_language_is_not_supported__Click_here_to_get_intructions_how_to_translate_TM_"),
url:"https://www.tampermonkey.net/faq.php#Q500"}});p.items.push({name:d.getMessage("Auto_reload_on_script_enabled"),level:20,id:"autoReload",option:!0,checkbox:!0,enabled:g.values.autoReload,desc:d.getMessage("Auto_reload_on_script_enabled_desc")});p.items.push({name:d.getMessage("Anonymous_statistics"),level:0,id:"statistics_enabled",option:!0,checkbox:!0,enabled:!!g.values.statistics_enabled,validation:{image:"info",opacity:.9,msg:d.getMessage("Allow_Tampermonkey_to_collect_anonymous_statistics_via_Google_Analytics"),
url:"https://www.tampermonkey.net/privacy.php#extension"}});p.items.push({name:d.getMessage("Debug_scripts"),level:100,id:"debug",option:!0,checkbox:!0,enabled:g.values.debug,desc:""});p.items.push({name:d.getMessage("Show_fixed_source"),level:100,id:"showFixedSrc",option:!0,checkbox:!0,enabled:g.values.showFixedSrc,desc:""});p.items.push({name:d.getMessage("LogLevel"),id:"logLevel",level:0,option:!0,select:[].concat(n.RUNTIME.SAFARI?[{name:d.getMessage("Verbose"),value:90}]:[]).concat([{name:d.getMessage("Debug"),
value:80},{name:d.getMessage("Info"),value:60},{name:d.getMessage("Warning"),value:30},{name:d.getMessage("Error"),value:0}]),value:g.values.logLevel,desc:""});e={id:"script_sync",name:d.getMessage("Script_Sync"),sub_menu_item:!0,level:50,need_save:!0,items:[]};e.items.push({name:d.getMessage("Enable_Script_Sync"),id:"sync_enabled",level:50,option:!0,checkbox:!0,enabled:g.values.sync_enabled,desc:d.getMessage("Synchronize_your_scripts_across_browsers_and_operation_systems")});var r=(()=>{const a=
[],b={reset_sync:!0,cloud_url:!1,cloud_user:!1,cloud_pass:!1};rea.storage.sync.supported&&a.push({name:d.getMessage("Browser_Sync"),value:F.types.eCHROMESYNC,enable:b});a.push({name:d.getMessage("Google_Drive"),value:F.types.eGDRIVE,enable:b});n.RUNTIME.CHROME&&37>n.RUNTIME.BROWSER_VERSION||n.RUNTIME.SAFARI&&8>n.RUNTIME.BROWSER_VERSION||n.RUNTIME.DOLPHIN?m.info("Script Sync: no Dropbox support due to missing SHA-256 capabilities"):a.push({name:d.getMessage("Dropbox"),value:F.types.eDROPBOX,enable:b});
a.push({name:d.getMessage("OneDrive"),value:F.types.eONEDRIVE,enable:b});n.RUNTIME.SAFARI||(a.push({name:d.getMessage("Yandex_Disk"),value:F.types.eYANDEX,enable:b}),a.push({name:d.getMessage("WebDAV"),value:F.types.eWEBDAV,enable:{reset_sync:!0,cloud_url:!0,cloud_user:!0,cloud_pass:!0}}));return a})();e.items.push({name:d.getMessage("Sync_Type"),id:"sync_type",enabler:!0,level:50,option:!0,select:r,value:g.values.sync_type});e.items.push({name:d.getMessage("URL"),id:"cloud_url",enabledBy:"sync_type",
level:50,option:!0,text:!0,width:2,value:g.values.cloud_url});e.items.push({name:d.getMessage("Login"),id:"cloud_user",enabledBy:"sync_type",level:50,option:!0,text:!0,width:2,value:g.values.cloud_user});e.items.push({name:d.getMessage("Password"),id:"cloud_pass",enabledBy:"sync_type",level:50,option:!0,text:!0,password:!0,width:2,value:g.values.cloud_pass});e.items.push({name:d.getMessage("Sync_Reset"),id:"reset_sync",enabledBy:"sync_type",level:80,button:!0,reload:!0,value:0,warning:d.getMessage("This_will_remove_all_remote_data_from_sync_Ok_")});
h={id:"ppearance",name:d.getMessage("Appearance"),sub_menu_item:!0,need_save:!0,items:[],warning:d.getMessage("A_reload_is_required"),reload:!0};h.items.push({name:d.getMessage("Layout"),id:"layout",level:0,option:!0,select:Q.getLayouts(),value:g.values.layout,desc:""});h.items.push({name:d.getMessage("Custom_CSS"),id:"layout_user_css",level:100,option:!0,input:!0,value:g.values.layout_user_css,desc:d.getMessage("You_can_add_your_custom_CSS_rules_here_")});q={};"off"==g.values.notification_showUpdate&&
(q={image:"critical",msg:d.getMessage("Are_you_sure_that_you_don_t_want_to_be_notified_of_updates_")});h.items.push({name:d.getMessage("Update_Notification"),id:"notification_showUpdate",level:50,option:!0,select:[{name:d.getMessage("Disabled"),value:"off"},{name:d.getMessage("Show_notification"),value:"notification"},{name:d.getMessage("Open_changelog"),value:"changelog"}],value:g.values.notification_showUpdate,validation:q});h.items.push({name:d.getMessage("Favicon_Service"),id:"favicon_service",
level:50,option:!0,select:[{name:d.getMessage("Google"),value:"google"},{name:d.getMessage("DuckDuckGo"),value:"duckduckgo"},{name:d.getMessage("Native"),value:"native",warning:d.getMessage("Warning_unsafe_site_warnings_might_appear_")}],value:g.values.favicon_service});t={id:"action_menu",name:d.getMessage("Action_Menu"),sub_menu_item:!0,need_save:!0,items:[],level:50};t.items.push({name:d.getMessage("Hide_disabled_scripts"),id:"action_menu_scripts_hide_disabled",level:100,option:!0,checkbox:!0,
enabled:g.values.action_menu_scripts_hide_disabled,desc:""});t.items.push({name:d.getMessage("Columns"),id:"action_menu_columns",level:50,option:!0,select:[{name:d.getMessage("1"),value:"1"},{name:d.getMessage("2"),value:"2"},{name:d.getMessage("3"),value:"3"}],value:g.values.action_menu_columns});t.items.push({name:d.getMessage("Script_order"),id:"action_menu_scripts_sort",level:50,option:!0,select:[{name:d.getMessage("Auto"),value:"auto"},{name:d.getMessage("Position_"),value:"position"},{name:d.getMessage("Name"),
value:"name"},{name:d.getMessage("Enabled"),value:"enabled"}],value:g.values.action_menu_scripts_sort});t.items.push({name:d.getMessage("Icon_badge_info"),id:"appearance_badges",level:50,option:!0,select:[{name:d.getMessage("Disabled"),value:"off"},{name:d.getMessage("Running_scripts"),value:"running"},{name:d.getMessage("Unique_running_scripts"),value:"running_unique"},{name:d.getMessage("Disabled_scripts"),value:"disabled"}],value:g.values.appearance_badges});(n.RUNTIME.CHROME||n.RUNTIME.FIREFOX)&&
t.items.push({name:d.getMessage("Icon_badge_color"),id:"appearance_badge_color",level:100,color:!0,value:g.values.appearance_badge_color});n.RUNTIME.FIREFOX&&t.items.push({name:d.getMessage("Icon_badge_text_color"),id:"appearance_badge_text_color",level:100,color:!0,value:g.values.appearance_badge_text_color});r={id:"editor",name:d.getMessage("Editor"),sub_menu_item:!0,level:20,need_save:!0,items:[],warning:d.getMessage("A_reload_is_required"),reload:!0};r.items.push({name:d.getMessage("Enable_Editor"),
id:"editor_enabled",level:100,option:!0,checkbox:!0,enabled:g.values.editor_enabled,desc:""});r.items.push({name:d.getMessage("Theme"),id:"editor_theme",level:50,option:!0,select:Q.getEditorThemes(),value:g.values.editor_theme});r.items.push({name:d.getMessage("Font_Size"),id:"editor_fontSize",level:50,option:!0,select:[{name:"50%",value:50},{name:"70%",value:70},{name:"80%",value:80},{name:"90%",value:90},{name:"100%",value:100},{name:"110%",value:110},{name:"120%",value:120},{name:"150%",value:150}],
value:g.values.editor_fontSize});r.items.push({name:d.getMessage("Key_Mapping"),id:"editor_keyMap",level:50,option:!0,select:[{name:d.getMessage("Windows"),value:"windows"},{name:d.getMessage("Sublime"),value:"sublime"},{name:d.getMessage("Emacs"),value:"emacs"},{name:d.getMessage("Vim"),value:"vim"}],value:g.values.editor_keyMap});r.items.push({name:d.getMessage("Indentation_Width"),id:"editor_indentUnit",level:50,option:!0,select:[{name:d.getMessage("1"),value:1},{name:d.getMessage("2"),value:2},
{name:d.getMessage("3"),value:3},{name:d.getMessage("4"),value:4},{name:d.getMessage("5"),value:5},{name:d.getMessage("6"),value:6},{name:d.getMessage("7"),value:7},{name:d.getMessage("8"),value:8},{name:d.getMessage("9"),value:9},{name:d.getMessage("10"),value:10},{name:d.getMessage("11"),value:11}],value:g.values.editor_indentUnit,desc:""});r.items.push({name:d.getMessage("Indent_with"),id:"editor_indentWithTabs",level:50,option:!0,select:[{name:d.getMessage("Tabs"),value:"tabs"},{name:d.getMessage("Spaces"),
value:"spaces"}],value:g.values.editor_indentWithTabs,desc:""});r.items.push({name:d.getMessage("TabMode"),id:"editor_tabMode",level:50,option:!0,select:[{name:d.getMessage("Classic"),value:"classic"},{name:d.getMessage("Smart"),value:"smart"},{name:d.getMessage("Indent"),value:"indent"}],value:g.values.editor_tabMode,desc:""});r.items.push({name:d.getMessage("Line_break"),id:"editor_lineWrapping",level:50,option:!0,checkbox:!0,enabled:g.values.editor_lineWrapping,desc:""});r.items.push({name:d.getMessage("Reindent_on_typing"),
id:"editor_electricChars",level:50,option:!0,checkbox:!0,enabled:g.values.editor_electricChars,desc:""});r.items.push({name:d.getMessage("Enable_autoSave"),id:"editor_autoSave",level:20,option:!0,checkbox:!0,enabled:g.values.editor_autoSave,desc:""});r.items.push({name:d.getMessage("Enable_easySave"),id:"editor_easySave",level:20,option:!0,checkbox:!0,enabled:g.values.editor_easySave,desc:""});r.items.push({name:d.getMessage("Highlight_trailing_whitespace"),id:"editor_highlightTrailingWhitespace",
level:50,option:!0,checkbox:!0,enabled:g.values.editor_highlightTrailingWhitespace,desc:""});r.items.push({name:d.getMessage("Trim_trailing_whitespace_from_modified_lines"),id:"editor_trimTrailingSpacesFromModifiedLines",level:50,option:!0,checkbox:!0,enabled:g.values.editor_trimTrailingSpacesFromModifiedLines,desc:""});r.items.push({name:d.getMessage("Auto_syntax_check_on_typing"),id:"editor_autoLint",level:50,option:!0,checkbox:!0,enabled:g.values.editor_autoLint,desc:d.getMessage("Enable_this_option_to_automatically_check_the_code_on_typing_")});
r.items.push({name:d.getMessage("Auto_syntax_check_max_length"),id:"editor_autoLintMaxLen",level:50,option:!0,text:!0,value:g.values.editor_autoLintMaxLen,desc:d.getMessage("Check_only_scripts_up_to_this_size_automatically_")});r.items.push({name:d.getMessage("Custom_Linter_Config"),id:"editor_linter_config",level:100,option:!0,input:!0,json:!0,value:g.values.editor_linter_config,validation:{image:"info",opacity:.9,msg:d.getMessage("You_can_add_your_custom_linter_config_here_"),url:"https://eslint.org/docs/user-guide/configuring"}});
f={id:"script_update",name:d.getMessage("Script_Update"),sub_menu_item:!0,level:0,items:[]};f.items.push({name:d.getMessage("Check_disabled_scripts"),id:"scriptUpdateCheckDisabled",level:0,option:!0,checkbox:!0,enabled:g.values.scriptUpdateCheckDisabled,desc:""});f.items.push({name:d.getMessage("Dont_ask_me_for_simple_script_updates"),id:"notification_silentScriptUpdate",level:80,option:!0,checkbox:!0,enabled:g.values.notification_silentScriptUpdate,desc:""});f.items.push({name:d.getMessage("Check_interval"),
id:"scriptUpdateCheckPeriod",level:0,option:!0,select:[{name:d.getMessage("Never"),value:0},{name:d.getMessage("Every_6_Hours"),value:216E5},{name:d.getMessage("Every_12_Hour"),value:432E5},{name:d.getMessage("Every_Day"),value:864E5},{name:d.getMessage("Every_Week"),value:6048E5}],value:g.values.scriptUpdateCheckPeriod,desc:""});f.items.push({name:d.getMessage("Hide_notification_after"),id:"scriptUpdateHideNotificationAfter",level:50,option:!0,select:[{name:d.getMessage("Never"),value:0},{name:d.getMessage("15_Seconds"),
value:15E3},{name:d.getMessage("30_Seconds"),value:3E4},{name:d.getMessage("1_Minute"),value:6E4},{name:d.getMessage("5_Minutes"),value:3E5},{name:d.getMessage("1_Hour"),value:36E5}],value:g.values.scriptUpdateHideNotificationAfter,desc:""});l={id:"externals",name:d.getMessage("Externals"),sub_menu_item:!0,level:0,items:[]};l.items.push({name:d.getMessage("Update_interval"),id:"external_update_interval",level:0,option:!0,select:[{name:d.getMessage("Always"),value:1},{name:d.getMessage("Every_Day"),
value:864E5},{name:d.getMessage("Every_Week"),value:6048E5},{name:d.getMessage("Every_Month"),value:2592E6},{name:d.getMessage("Never"),value:0}],value:g.values.external_update_interval,desc:""});b={id:"security",name:d.getMessage("Security"),sub_menu_item:!0,need_save:!0,level:50,items:[]};n.OPTIONS.HAS_CSP&&(b.items.push({name:d.getMessage("Add_TM_to_CSP"),id:"webrequest_fixCSP",level:80,option:!0,select:[{name:d.getMessage("Yes"),value:"yes"},{name:d.getMessage("No"),value:"no"}],value:g.values.webrequest_fixCSP,
desc:d.getMessage("Tampermonkey_might_not_be_able_to_provide_access_to_the_unsafe_context_when_this_is_disabled")}),b.items.push({name:d.getMessage("Allow_headers_to_be_modified_by_scripts"),id:"webrequest_modHeaders",level:80,option:!0,reload:!0,select:[{name:d.getMessage("Yes"),value:"yes"},{name:d.getMessage("Auto"),value:"auto"},{name:d.getMessage("No"),value:"no"}],value:g.values.webrequest_modHeaders,warning:d.getMessage("Tampermonkey_needs_to_be_restarted_to_make_this_change_apply_Do_you_want_to_continue_"),
desc:""}));n.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS&&b.items.push({name:d.getMessage("Script_local_files_access"),id:"script_file_access",level:80,option:!0,select:[{name:d.getMessage("All_local_files"),value:"all"},{name:d.getMessage("require_and_resource"),value:"externals"},{name:d.getMessage("Disabled"),value:"off"}],value:g.values.script_file_access});b.items.push({name:d.getMessage("Allow_communication_with_cooperate_pages"),id:"external_connect",level:80,option:!0,reload:!0,select:[{name:d.getMessage("Tampermonkey_and_script_version"),
value:"all"},{name:d.getMessage("Tampermonkey_version"),value:"version"},{name:d.getMessage("Disabled"),value:"off"}],value:g.values.external_connect,desc:d.getMessage("This_option_allows_the_Tampermonkey_homepage_and_some_script_hosting_pages_to_determine_the_Tampermonkey_version_and_whether_a_script_is_installed_")});b.items.push({name:d.getMessage("Subresource_Integrity"),id:"require_sri_mode",level:80,option:!0,select:[{name:d.getMessage("Disabled"),value:"ignore"},{name:d.getMessage("Validate_if_supported"),
value:"supported"},{name:d.getMessage("Validate_if_given"),value:"given"},{name:d.getMessage("Enforce"),value:"enforce"}],value:g.values.require_sri_mode,desc:d.getMessage("Script_authors_can_secure_external_resources_by_adding_a_SRI_hash_to_the_URL_")});b.items.push({name:d.getMessage("connect_mode"),id:"connect_mode",level:50,option:!0,select:(80<=g.values.configMode||["off","casual"].includes(g.values.connect_mode)?[{name:d.getMessage("Disabled"),value:"off"},{name:d.getMessage("Casual"),value:"casual"}]:
[]).concat([{name:d.getMessage("Ask_if_unknown"),value:"ask"},{name:d.getMessage("Strict"),value:"strict"},{name:d.getMessage("Always_ask"),value:"paranoid"}]),value:g.values.connect_mode,desc:""});n.RUNTIME.INCOGNITO_MODE&&!rea.extension.inIncognitoContext&&(q="temporary"==g.values.incognito_mode?{}:{image:"critical",msg:"Permanent mode is still a BETA feature!"},b.items.push({name:d.getMessage("Store_data_in_incognito_mode"),id:"incognito_mode",level:50,option:!0,select:[{name:d.getMessage("Temporary"),
value:"temporary"},{name:d.getMessage("Permanent"),value:"permanent"}],value:g.values.incognito_mode,validation:q}));b.items.push({name:d.getMessage("Page_Filter_Mode"),id:"page_filter_mode",level:50,option:!0,select:[{name:d.getMessage("Disabled"),value:"off"},{name:d.getMessage("Blacklist"),value:"black"},{name:d.getMessage("Whitelist"),value:"white"},{name:d.getMessage("Both"),value:"black+white"}],value:g.values.page_filter_mode,desc:""});b.items.push({name:d.getMessage("Whitelisted_Pages"),id:"page_whitelist",
level:50,option:!0,input:!0,array:!0,value:g.values.page_whitelist,desc:""});b.items.push({name:d.getMessage("Blacklisted_Pages"),id:"forbiddenPages",level:50,option:!0,input:!0,array:!0,value:g.values.forbiddenPages,desc:""});a={id:"blackcheck",name:d.getMessage("BlackCheck"),sub_menu_item:!0,need_save:!0,level:50,items:[]};a.items.push({name:d.getMessage("Script_Blacklist_Source"),id:"script_blacklist_type",level:50,option:!0,select:[{name:d.getMessage("Disabled"),value:"off"},{name:d.getMessage("Server_And_Manual"),
value:"server"},{name:d.getMessage("Only_Manual"),value:"only_manual"}],value:g.values.script_blacklist_type});a.items.push({name:d.getMessage("Blacklist_Severity"),id:"script_blacklist_severity",level:50,option:!0,select:[{name:d.getMessage("severity_1"),value:1},{name:d.getMessage("severity_2"),value:2},{name:d.getMessage("severity_3"),value:3},{name:d.getMessage("severity_4"),value:4},{name:d.getMessage("severity_5"),value:5},{name:d.getMessage("severity_6"),value:6},{name:d.getMessage("severity_7"),
value:7},{name:d.getMessage("severity_8"),value:8},{name:d.getMessage("severity_9"),value:9},{name:d.getMessage("severity_10"),value:J.SEVERITY_MAX}],value:g.values.script_blacklist_severity});a.items.push({name:d.getMessage("Manual_Script_Blacklist"),id:"require_blacklist",level:50,option:!0,input:!0,array:!0,value:g.values.require_blacklist,desc:""});if(n.OPTIONS.CAN_DOWNLOAD){let a=!1;q={};y.map("exe sh crx com bat scr".split(" "),a=>"name."+a).forEach(b=>{a|=K.is_whitelisted(b)});a&&(q={image:"critical",
msg:d.getMessage("Your_whitelist_seems_to_include_executable_files_This_means_your_userscripts_may_download_malware_or_spyware_to_your_harddisk_")});B={id:"downloads",name:d.getMessage("Downloads")+" BETA",sub_menu_item:!0,need_save:!0,level:50,items:[]};B.items.push({name:d.getMessage("Download_Mode"),id:"downloads_mode",level:50,option:!0,select:y.select([{name:d.getMessage("Default"),value:K.staticVars.DEFAULT},{name:d.getMessage("Disabled"),value:K.staticVars.OFF},{name:d.getMessage("Native"),
value:K.staticVars.NATIVE},{name:d.getMessage("Browser_API"),value:rea.downloads.supported?K.staticVars.CHROME:null}],a=>a.value),value:g.values.downloads_mode,desc:d.getMessage("The_Browser_API_mode_requires_a_special_permission_")});B.items.push({name:d.getMessage("Whitelisted_File_Extensions"),id:"downloads_extension_whitelist",level:50,option:!0,input:!0,array:!0,value:g.values.downloads_extension_whitelist,desc:d.getMessage("Only_files_with_these_extensions_can_be_saved_to_the_harddisk_Be_careful_to_not_allow_file_extensions_that_represent_executables_at_your_operating_system_"),
validation:q})}c={id:"experimental",name:d.getMessage("Experimental"),sub_menu_item:!0,level:80,items:[]};n.RUNTIME.FAST_EXEC_SUPPORT&&(q="fast"==g.values.runtime_inject_mode?{image:"critical",msg:"This might cause higher CPU usage!"}:{},c.items.push({name:d.getMessage("Inject_Mode"),id:"runtime_inject_mode",level:80,option:!0,select:[{name:d.getMessage("Default"),value:"default"},{name:d.getMessage("Instant"),value:"instant"},{name:d.getMessage("Normal"),value:"normal"}],value:g.values.runtime_inject_mode,
validation:q}));c.items.push({name:d.getMessage("strict_mode"),id:"runtime_strict_mode",level:80,option:!0,select:[{name:d.getMessage("Default"),value:"byscript"},{name:d.getMessage("Always"),value:"on"},{name:d.getMessage("Disabled"),value:"off"}],value:g.values.runtime_strict_mode});rea.webRequest.filterResponseData&&n.OPTIONS.HAS_CSP&&c.items.push({name:d.getMessage("Add_Tampermonkey_to_the_site_s_content_csp"),id:"webrequest_fixContentCSP",level:80,option:!0,select:[{name:d.getMessage("Yes"),
value:"yes"},{name:d.getMessage("No"),value:"no"}],value:g.values.webrequest_fixContentCSP,warning:"Warning: enabling this option is may break pages!"});q={id:"userscripts",name:d.getMessage("Userscripts"),sub_menu_item:!0,need_save:!0,level:80,items:[]};q.items.push({name:d.getMessage("Script_URL_detection"),id:"scriptUrlDetection",level:80,option:!0,select:[{name:d.getMessage("Auto"),value:"auto"},{name:d.getMessage("Disabled"),value:"manual"}],value:g.values.scriptUrlDetection});q.items.push({name:d.getMessage("New_script_template_"),
id:"script_templates",level:80,option:!0,input:!0,array:!0,named:!0,value:g.values.script_templates});k={id:"reset",name:d.getMessage("Reset_Section"),sub_menu_item:!0,level:50,items:[]};k.items.push({name:d.getMessage("Restart_Tampermonkey"),id:"reset_simple",level:50,button:!0,reload:!0,value:0,warning:d.getMessage("This_will_restart_Tampermonkey_Ok_")});k.items.push({name:d.getMessage("Factory_Reset"),id:"reset_factory",level:80,button:!0,reload:!0,value:0,warning:d.getMessage("This_will_remove_all_scripts_and_reset_all_settings_Ok_")});
va&&k.items.push({name:"Install Tests",id:"install_tests",level:80,button:!0,reload:!1,ignore:!0,value:0,warning:"This will install a lot of test scripts!"});return[p,h,t,f,l,void 0,e,void 0,void 0,r,b,a,B,q,c,k].filter(a=>!!a)}}))(),V=(()=>({create:(p,w)=>{p=p||"";w=w||{};const f=b=>l.onebyone(b).fail(()=>{m.warn("tree: wait failed!")}).then(a=>a.filter(a=>a)),h=(b,a)=>{const c=b.replace(/\.$/,"").split(".");let d=t;for(;c.length;){const e=c.shift();if(d[e]){if("function"===typeof d[e])return()=>
d[e](w,!a);d=d[e];c.length||c.unshift("root")}else return m.warn("tree: unable to find",b,w),()=>l.Pledge([])}m.warn("tree: unable to find",b,w);return()=>l.Pledge([])};var t={actions:{root:function(b){const a=l();rea.tabs.getSelected(null,c=>{c&&0<=c.id?w.tab=c:b.tabId&&(w.tab={id:b.tabId,url:null});c=f([h("actions.general"),h("actions.scripts"),h("actions.commands")]);a.consume(c)});return a.promise()},general:function(){var b=w.tab,a=b?b.url:null,c=a&&4<a.length&&""==a.substr(0,4).replace(/file|http/,
"")?a:"";const e=[];b={name:"enabled",sub_menu_item:!0,pos:"top",items:[],tabId:b?b.id:null};b.items.push({name:d.getMessage("Enabled"),display:g.values.enabled?null:"greyed",id:"enabled",button:!0,reload:!0,enabler:!0});b.items=b.items.concat(O.actionStatus().map(a=>({options:a,globalhint:!0})));e.push(b);let f;!qa.isScriptUrl(a,!0)||(f=qa.isScriptUrl(a))&&"manual"!=g.values.scriptUrlDetection||b.items.push({name:f?d.getMessage("Install_this_script"):d.getMessage("Try_to_install_as_script"),image:"script_download",
id:"installFromUrl",data:a,button:!0,reload:!0});a={name:"about",sub_menu_item:!0,pos:"bottom",items:[]};a.items.push({name:d.getMessage("Dashboard"),image:"utilities",url:rea.extension.getURL("options.html")+"#"+["url="+I.Base64.encode(c),"nav=dashboard"].join("&"),newtab:!0});c="version="+rea.extension.manifest.version+"&ext="+rea.runtime.short_id;a.items.push({image:"about",id:"about",urls:[{name:" "+d.getMessage("Help"),url:"https://www.tampermonkey.net/faq.php?"+c,newtab:!0},{name:" "+d.getMessage("Changelog"),
url:"https://www.tampermonkey.net/changelog.php?"+c,newtab:!0}]});e.push(a);return l.Pledge(e)},scripts:{root:function(b){var a=w.tab;const c=a?a.url:null,e=[];var f=c?z.parse(c):null;f=f&&["http:","https:","file:"].includes(f.protocol)?z.woHash(f):"";let h;const p={name:"scripts",sub_menu_item:!0,pos:"center",items:[]};var m=aa.getContexters(!0,null);const n={},t={},v={};let H={};const u={};a&&[x.getUniqueScriptsForTab(a),x.getScriptHistoryForTab(a)].forEach((a,b)=>{let c;Object.keys(a).forEach(e=>
{var f=a[e];b?(n[e]=f.urls,t[e]=f.count,v[e]=f.all_time,(c=H[e])||(f=A.getByUid(e),H[e]=f.script&&f.cond?c=f.script:c={uuid:e,name:d.getMessage("This_script_was_deleted"),enabled:!0,deleted:!0}),u[e]="a"+c.name.toLowerCase()+c.position):(H[e]=c=f.script,u[e]="z"+c.name.toLowerCase()+c.position)})});let C;C="position"==g.values.action_menu_scripts_sort?(a,b)=>a.position-b.position:"name"==g.values.action_menu_scripts_sort?(a,b)=>a.name.toLowerCase()<b.name.toLowerCase()?-1:a.name.toLowerCase()>b.name.toLowerCase()?
1:0:"enabled"==g.values.action_menu_scripts_sort?(a,b)=>1E4*(a.enabled?0:1)+a.position-(1E4*(b.enabled?0:1)+b.position):(a,b)=>u[a.uuid].localeCompare(u[b.uuid]);H=y.values(H).sort(C);m=ua([].concat(H).concat(m),{active_urls:n,active_counts:t,all_time_active_counts:v});const D=a?Ga(a.id):{};g.values.action_menu_scripts_hide_disabled&&(m=m.filter(a=>a.enabled||t[a.uuid]));m.forEach(a=>{let b;if(b=D[a.uuid])a.menu_cmds=b});!g.values.action_menu_scripts_hide_disabled&&2<Math.min(g.values.action_menu_columns,
(b?b.available_columns:null)||99)?(h={name:"scripts_right",sub_menu_item:!0,pos:"right",items:[]},m.forEach(a=>{(a.enabled||t[a.uuid]?p:h).items.push(a)}),e.push(p),h.items.length&&e.push(h)):(h=p,p.items=p.items.concat(m),e.push(p));g.values.enabled&&!m.length&&c&&(X.isAllowed(c)?p.items.push({name:d.getMessage("No_script_is_running"),image:"no_script"}):p.items.push({name:d.getMessage("This_page_is_blacklisted_at_the_security_settings"),image:"critical"}));b=d.getLocale();g.values.enabled&&(m.length?
(a={name:"scripts_new",sub_menu_item:!0,pos:"center",items:[]},e.push(a)):a=p,a.items.push({name:d.getMessage("Get_new_scripts___"),image:"script_search",url:"https://www.tampermonkey.net/scripts.php"+(b?"?locale="+b:""),newtab:!0}),a.items.push({name:d.getMessage("Add_new_script___"),image:"script_add",url:rea.extension.getURL("options.html")+"#url="+I.Base64.encode(f)+"&nav=new-user-script",newtab:!0}));return l.Pledge(e)}},commands:function(){const b=[],a=d.getLocale(),c={name:"commands",id:"commands",
sub_menu_item:!0,pos:"left",items:[]};c.items.push({name:d.getMessage("Check_for_userscripts_updates"),id:"run_script_updates",button:!0,image:"update"});80<=g.values.configMode&&c.items.push({name:d.getMessage("Report_a_bug"),image:"bug",url:"https://www.tampermonkey.net/bug",newtab:!0});n.RUNTIME.SAFARI||c.items.push({name:d.getMessage("Please_consider_a_contribution"),image:"contrib",url:"https://www.tampermonkey.net/contrib.php?src=a"+(a?"&locale="+a:""),newtab:!0});b.push(c);return l.Pledge(b)}},
options:{root:function(){return f([h("options.general"),h("options.verification"),h("options.scripts"),h("options.settings")])},general:function(){let b,a=[];rea.extension.inIncognitoContext&&"temporary"==g.values.incognito_mode?a.push({globalhint:!0,options:{image:"critical",text:d.getMessage("All_modifications_are_only_kept_until_this_incognito_session_is_closed_")}}):(b=O.optionsStatus().map(a=>({options:a,globalhint:!0})))&&b.length?a=a.concat(b):(b=ja.updateAvailable())&&a.push({globalhint:!0,
options:{image:"info",class:"information",text:d.getMessage("0name0_0version0_is_available__Please_re_start_your_browser_to_update_",rea.extension.manifest.name,b)}});return l.Pledge(a)},verification:function(){const b=[];na.getWarnings().forEach(a=>{b.push({globalhint:!0,options:{image:"critical",class:"warning",text:a.text,title:a.description,info_url:a.url}})});return l.Pledge(b)},scripts:{root:function(b,a){const c=l(),e={name:d.getMessage("Installed_userscripts"),main_menu_item:!0,scriptTab:!0,
id:"dashboard"};(()=>{if(b.complete||!a)return f(y.map(["options.scripts.userscripts","options.scripts.new"],a=>h(a)));e.referrer="options.scripts";e.partial=!0;return f([h("options.scripts.new")])})().done(a=>{e.items=a;c.resolve([e])}).fail(c.reject);return c.promise()},"new":function(){const b=[];b.push({name:d.getMessage("New_userscript"),id:null,image:"script_add",icon:Q.images.origin("unknown"),nnew:!0,uuid:"new-user-script",position:-1,positionof:n.RUNTIME.MAX_SCRIPTS,enabled:!0,userscript:!0});
return l.Pledge(b)},userscripts:{root:function(b,a){b=b.complete||!a?null:"options.scripts.userscripts";b=ua(x.determineScriptsToRun(null),{options_page:!0,referrer:b});a=b.length;const c=d.getLocale();b.push({name:d.getMessage("No_script_is_installed"),image:"info",visible:!a});b.push({name:d.getMessage("Get_some_scripts___"),image:"edit_add",url:"https://www.tampermonkey.net/scripts.php"+(c?"?locale="+c:""),newtab:!0,visible:!a});return l.Pledge(b)},matches:function(b){var a=b.filter,c;if(!a)return l.Pledge([]);
a=/\/(.*)\/(.*)/.exec(a.code);const d=new RegExp(a[1],a[2]);b.uuid?(b=A.getByUid(b.uuid),b.script&&b.cond&&(c=[b.script])):c=x.determineScriptsToRun(null);return c?(c=c.map(a=>-1!=a.textContent.search(d)?a.uuid:null).filter(a=>a),l.Pledge(c)):l.Pledge([])},source:function(b){if(!b.uuid)return l.Pledge([]);b=A.getByUid(b.uuid);if(b.script&&b.cond)return b=g.values.showFixedSrc?ma.mkCompat(b.script.textContent,b.script,"off"!=g.values.runtime_strict_mode):b.script.textContent,l.Pledge([b]);m.warn("tree: unable to process ",
b);return l.Breach()},storage:function(b){return b.uuid?l.Pledge([A.getStorageByUid(b.uuid).data]):l.Pledge([])},external:function(b){if(!b.uuid)return l.Pledge([]);const a=A.getByUid(b.uuid);if(a.script&&a.cond){let c;[].concat(a.script.requires).concat(a.script.resources).some(a=>{a=a.url||z.sanitize(a.unsafe_url,a.abs_url);if(a==b.url&&(a=P.getElement(b.uuid,a))&&a.data&&a.data.content)return c=a.data.content,!0});return l.Pledge([c])}m.warn("tree: unable to process ",a);return l.Breach()}}},settings:function(b,
a){const c=l(),e={name:d.getMessage("Settings"),main_menu_item:!0,id:"settings",selected_default:!0};b.complete||!a?b=l.Pledge(Fa.create()):(e.referrer="options.settings",b=l.Pledge());b.done(a=>{e.items=a;c.resolve([e])}).fail(c.reject);return c.promise()}}};m.debug("tree: loading",p,w);return h(p,!0)()},level:d=>d.replace(/\.$/,"").split(".").length}))(),Ga=d=>{const g={};d=null==d||void 0==d?fa.list():fa.listByTabId(d);for(const f in d){if(!d.hasOwnProperty(f))continue;const h=d[f];(g[h.uuid]=
g[h.uuid]||[]).push({name:h.name,uuid:h.uuid,id:h.id,accessKey:h.accessKey,image:"menu_cmd",menucmd:!0})}return g},ua=(p,l)=>{const f=[];l=l||{};const h=new D.Script;["author","copyright"].forEach(d=>{h[d]=!1});Object.keys(p).forEach(m=>{const b=p[m];let a;if(l.options_page){a={};const c=["textContent","requires","resources"];Object.keys(h).forEach(d=>{c.includes(d)||(y.toType(h[d]),a[d]=b[d])});l.referrer?(a.referrer=l.referrer,a.length=b.textContent.length):a.code=b.textContent;["requires","resources"].forEach(c=>
{a[c]=y.map(b[c],a=>{const d=a.url||z.sanitize(a.unsafe_url,a.abs_url),e=P.getElement(b.uuid,d);let f=0,h=null,g=null,k,p,m,n;e&&e.data&&(e.data.content&&(n=e.data.content,f=n.length),g=e.data.sri,h=e.ts,k=e.modified,m=e.data.meta||"text/plain",p="requires"==c||/text\/.*|application\/(?:x-)?(?:java|ecma)script/.test(m));return{display_url:a.url||a.unsafe_url,abs_url:a.abs_url,unsafe_url:a.unsafe_url,url:d,data:{length:f,content:l.externals?n:void 0},sri:g,ts:h,mimetype:m,editable:p,modified:k}})});
a.origin=x.determineOrigin(b);a.contexter=x.isContexter(b);a.temp_connects=la.getSessionConnects(b.uuid);m=A.getStorageByUid(b.uuid);a.storage_key_count=Object.keys(m.data).length;a.remote_url=M.getSyncRemoteUrl(b);a.lastUpdated=b.lastUpdated}else m=x.determineOrigin(b),a={name:b.name,name_i18n:b.name_i18n,uuid:b.uuid,system:b.system,support:!!b.supportURL||m&&!!m.issue_url,abuse:m&&!!m.abuse_url,active_urls:(l.active_urls||{})[b.uuid],active_count:(l.active_counts||{})[b.uuid],all_time_active_count:(l.all_time_active_counts||
{})[b.uuid],referrer:l.referrer,contexter:x.isContexter(b),enabled:b.enabled,position:b.position,deleted:b.deleted};b.evilness&&(b.evilness==J.SEVERITY_FOISTED_SCRIPT?a.foisted=d.getMessage("The_origin_of_this_script_cant_be_determined_"):b.evilness>=Math.min(J.SEVERITY_MAX,g.values.script_blacklist_severity)&&(a.blacklisted=d.getMessage("This_script_is_blacklisted_")));b.evilness&&(a.warnings=J.getWarningsFor(x.determineSourceURL(b)));a.file_url=b.downloadURL||b.fileURL;a.positionof=p.length;a.userscript=
!0;b.icon64||b.icon||(a.icon64=Q.images.origin("unknown"));b.options&&Object.keys(h.options).forEach(c=>{a[c]=b.options[c]});f.push(a)});return f},Y={run:function(d,g){let f=1;const h=()=>{0==--f&&(g&&g(),rea.page.reload())};if("config"==d){const d=u.listValues();Object.keys(d).forEach(b=>{b=d[b];-1==b.search(n.CONSTANTS.PREFIX.SCRIPT)&&-1==b.search(n.CONSTANTS.PREFIX.COND)&&-1==b.search(n.CONSTANTS.PREFIX.STORE)&&-1==b.search(n.CONSTANTS.PREFIX.META)&&(f++,u.deleteValue(b).always(h))})}else"factory"==
d&&(f++,K.remove_permission().done(h),f++,u.factoryReset().always(h));h()},reset:function(d){Y.run(null,d)},factoryReset:function(d){Y.run("factory",d)},configReset:function(d){Y.run("config",d)}},R=(()=>{const p=()=>{rea.runtime.lastError&&void 0},l={init:function(){l.setIcon();let d=g.values.appearance_badge_color||"#ee3131";"#"!==d[0]&&(d="#"+d);rea.browserAction.setBadgeBackgroundColor({color:d});d=g.values.appearance_badge_text_color||"#ffffff";"#"!==d[0]&&(d="#"+d);rea.browserAction.setBadgeTextColor({color:d})},
setIcon:f=>{var h;var l=null;let b=h=!1;void 0===f||C.get.empty(f)||(h=C.get.blocker(f),b=C.get.forbidden(f));b?(h="_forbidden",l=d.getMessage("At_least_one_part_of_this_page_is_listed_at_the_forbidden_pages_setting_")):h?(h="_blocker",l=d.getMessage("Some_scripts_might_be_blocked_by_the_javascript_settings_for_this_page_or_a_script_blocker_")):h=g.values.enabled&&void 0!==f?"":"_grey";m.debug("badge: set icon "+h);h={path:rea.extension.getURL("images/icon"+h+".png")};l={title:l?l:rea.extension.manifest.name};
null!=f&&(h.tabId=f,l.tabId=f);try{rea.browserAction.setIcon(h,p),rea.browserAction.setTitle(l)}catch(a){m.warn("bg: ERROR while setIcon! "+a.message)}},setBadge:d=>{let f=0;"off"==g.values.appearance_badges?f=0:"running"==g.values.appearance_badges?d&&!C.get.empty(d)&&(f=C.get.stats(d).running):"running_unique"==g.values.appearance_badges?d&&!C.get.empty(d)&&(f=C.get.stats(d,!0).unique):"disabled"==g.values.appearance_badges&&d&&!C.get.empty(d)&&(f=C.get.stats(d).disabled);m.debug("badge: set "+
f);f?rea.browserAction.setBadgeText({text:f.toString(),tabId:d}):rea.browserAction.setBadgeText({text:"",tabId:d})}};return l})(),ea=(()=>{let d=null;const g={init:function(){d=u.getValue(n.CONSTANTS.STORAGE.BEGGING,null);let f;const h=Date.now();d?(f=u.getValue(n.CONSTANTS.STORAGE.LAST_START,0))&&12096E5<h-f&&(d.later={type:"after_pause",ts:h},g.save()):(d={first_run:{type:"from_init",ts:h}},g.save())},save:function(){u.setValue(n.CONSTANTS.STORAGE.BEGGING,d)},needed:function(){var f=Date.now();
const h=d.first_run?d.first_run.ts+12096E5<f:!0,g=!d.hide,b=!d.contributed;f=d.later?d.later.ts+12096E5<f:!0;if(!n.RUNTIME.SAFARI&&!n.RUNTIME.DOLPHIN&&h&&g&&b&&f)return d.later?"l":"i"},clicked:function(d,h,g){N.tG("clicked",d,h+g)},dialog:{shown:function(f){const h=Date.now();d.dialog={ts:h,extra:f};g.save();N.tG("dialog")}},button:(()=>{const f={};["contributed","later","hide"].forEach(h=>{f[h]=(f,b)=>{const a=Date.now();d[h]={ts:a,type:f,extra:b};g.save();N.tG("button",h)}});return f})()};return g})(),
oa=(()=>{const d=(a,b)=>{m.debug(a,b);if(b&&a.menuItemId){var c=A.getByUid(a.menuItemId);c&&c.script?Aa.bundle({url:a.frameUrl||a.pageUrl||"<unknown>"},c.script,!0).then(c=>{const d=l();c.method="executeScript";a.frameUrl?c.url=z.woHash(a.frameUrl):c.topframe=!0;rea.tabs.sendMessage(b.id,c,d.resolve);return d.promise()}):m.log("ctxm: unable to find script "+a.menuItemId,a,b)}};let g=[],f=null,h=!1;const n=a=>{const b=[];y.each(a,a=>{const c=l();rea.contextMenus.create({id:a.uuid,contexts:["all"],
parentId:f,title:a.name,type:"normal",documentUrlPatterns:["http://*/*","https://*/*","file://*/*"]},()=>{c.resolve()});g.push(a.uuid);b.push(c.promise())});return l.when(b)},b=()=>{const a=l();rea.contextMenus.removeAll(()=>{f=null;a.resolve()});return a.promise()},a=()=>{const a=l();b().then(()=>{f=rea.contextMenus.create({contexts:["all"],title:"Tampermonkey",type:"normal",documentUrlPatterns:["http://*/*","https://*/*","file://*/*"]},()=>{a.resolve()})});return a.promise()},c=()=>{const c=aa.getContexters(!0,
null);if(c.length){var d=f?l.Pledge():a();return d.then(()=>n(c))}return b().then(e.clean)};var e={init:function(){rea.contextMenus.supported&&(e.clean().then(c).then(()=>{h=!0}),rea.contextMenus.onClicked.addListener(d))},clean:function(){const a=l();g.forEach(a=>{rea.contextMenus.remove(a)});g=[];a.resolve();return a.promise()},onScriptsChanged:function(){if(rea.contextMenus.supported&&h)return e.clean().then(c)},getContexterCount:function(){return g.length}};return e})(),ka=(()=>{const d={},l=
{},f=("TM_"+y.createUUID().substr(0,5)).toLowerCase(),h=["x-webkit-csp","x-content-security-policy","content-security-policy"],t=rea.webRequest.extraHeaderNeeded,b=(a,b)=>{let c,d,e,f,g;a=a.split(";");a.forEach((a,b)=>{0===a.search(/^\s*script-src /)?d=b:0===a.search(/^\s*default-src /)?e=b:0===a.search(/^\s*img-src /)&&(f=b)});let h;void 0!==e&&void 0===d&&(c=!0,a.push(a[e].replace(/default-src /,"script-src ")),d=a.length-1);void 0!==e&&void 0===f&&(c=!0,a.push(a[e].replace(/default-src /,"img-src ")),
f=a.length-1);void 0!==f&&(h=!1,b=a[f],-1==b.search(/'data:'/)&&(h=!0,b=b.replace(/img-src /,"img-src data: ")),-1!=b.search(/'none'/)&&(h=!0,b=b.replace(/ 'none'/,"")),h&&(a[f]=b,c=!0));void 0!==d&&(h=!1,b=a[d],-1==b.search(/'unsafe-eval'/)&&(h=!0,b=b.replace(/script-src /,"script-src 'unsafe-eval' ")),-1!=b.search(/'none'/)&&(h=!0,b=b.replace(/ 'none'/,"")),n.RUNTIME.FIREFOX&&(-1==b.search(/'unsafe-inline'/)&&(h=g=!0,b=b.replace(/script-src /,"script-src 'unsafe-inline' ")),-1==b.search(/'strict-dynamic'/)&&
-1!=b.search(/ '(nonce|sha[0-9]+)-[^']+'/)&&(h=!0,b=b.replace(/ '(nonce|sha[0-9]+)-[^']+'/g," *"))),h&&(a[d]=b,c=!0));void 0!==e&&(h=!1,b=a[e],g&&-1!=b.search(/ 'self'/)&&(h=!0,a[e]=b.replace(/default-src /,"default-src blob: data: ")),h&&(c=!0));return c?a.join(";"):null},a=(a,b)=>{let c,d;a=a.split(";");a.forEach((a,b)=>{0===a.search(/^\s*sync-xhr /)&&(d=b)});let e;void 0!==d&&(e=!1,b=a[d],-1!=b.search(/'none'/)&&(e=!0,b=b.replace(/ 'none'/," *")),e&&(a[d]=b,c=!0));return c?a.join(";"):null},c=
(a,b)=>{let c={};const d=a.url;Object.keys(b).forEach(a=>{const e=b[a];y.each(e.rules,(a,b)=>{var f;let h;if((f=a.selector)&&(h=a.action)){var g=e.id+"/"+b;(b=L.items.regexp.get(g))||(b=x.regexify({inc:f.include,match:f.match,exc:f.exclude}),L.items.regexp.set(g,b));if(x.validUrl(d,b)){if(h.cancel)return m.log("webRequest: request was canceled by script "+e.uuid,d,a,e),e.callback&&e.callback({type:"cancel",details:{rule:a,url:d}}),c={cancel:!0},!1;if(h.redirect){let b,g,k,l;h.redirect.url?b=h.redirect.url:
(g=h.redirect.from)&&(k=h.redirect.to)&&(l=d.match(g,k))&&(l.shift(),b=k,l.concat(["","",""]).forEach((a,c)=>{b=b.replace("$"+(c+1),a||"")}));f=c=>{m.warn("webRequest: error while request redirect by script "+e.uuid,d,a,e);e.callback&&e.callback({type:"redirect",message:"error",details:{description:c,rule:a,url:d,redirect_url:b}})};b?(b=z.woHash(b),X.isAllowed(b)?x.scriptWillRun(e.uuid,b)?(m.log("webRequest: request was redirected by script "+e.uuid,d,b,a,e),e.callback&&e.callback({type:"redirect",
details:{rule:a,url:d,redirect_url:b}}),c.redirectUrl=b):f("the redirect URL needs to be included by the scripts @include or @match tag"):f("the redirect URL is filtered by the security settings")):f("unable to determine the redirect URL")}}}})});return c},e=a=>{let b;n.RUNTIME.CHROME&&63<=n.RUNTIME.BROWSER_VERSION?b=a.initiator:n.RUNTIME.FIREFOX&&(b=a.originUrl);return b&&0!==(b+"/").indexOf(rea.extension.getURL("/"))?b:null},k=a=>{if(!e(a)){var b=[],c=a.requestHeaders||[],d,h,g={},k=new RegExp("^"+
f);c=c.filter(c=>{if(c.name&&0==c.name.search(k))h=c.name.replace(k,""),g[h.toLowerCase()]=!0,"internal"==h?l[a.requestId]=c.value:c.value&&b.push({name:h,value:I.decodeS(c.value)}),d=!0;else return!0});if(d)return{requestHeaders:c.filter(a=>!a.name||!g[a.name.toLowerCase()]).concat(b)}}},u=a=>{if(G.late)if("main_frame"==a.type){if(C.events.reset(a.tabId,!0),0<a.tabId&&"POST"!=a.method&&"auto"==g.values.scriptUrlDetection&&qa.isScriptUrl(a.url))return x.installFromUrl(a.url,{},{silent_fail:!0}).fail(b=>
{m.info("webRequest: user script detected @ "+a.url+" was invalid",b?b.messages:"");rea.tabs.update(a.tabId,{url:a.url+"#bypass=true"},()=>{})}).done(()=>{n.RUNTIME.EDGE&&rea.tabs.query({windowType:"normal"},b=>{b.forEach(b=>{b.id===a.tabId&&rea.tabs.update(b.id,{url:b.url},()=>{})})})}),n.RUNTIME.EDGE?{cancel:!0}:{redirectUrl:"javascript:history.back()"}}else{let b,d;if((b=C.get.requests(a.tabId,a.frameId))&&(d=c(a,b)))return d}else G.registerLateCallback(()=>{u(a)})},q=(c,e)=>{if(G.late){var f=
c.responseHeaders||[];if("xmlhttprequest"==c.type){let a;if(l[c.requestId]){n.XMLHTTPREQUEST.COOKIE_PASSTHROUGH||f.forEach(b=>{b.name&&b.value&&b.name.toLowerCase().includes("set-cookie")&&(f.push({name:"tm-setcookie"+rea.runtime.short_id.toLowerCase(),value:b.value}),a=!0)});if(e=d[c.requestId])f.push({name:"tm-finalurl"+rea.runtime.short_id.toLowerCase(),value:e}),a=!0;if(a)return{responseHeaders:f}}}else{var k,p,m,r=n.OPTIONS.HAS_CSP&&"yes"==g.values.webrequest_fixCSP,t=r&&n.RUNTIME.CHROME&&60<=
n.RUNTIME.BROWSER_VERSION;f.some(a=>{if(a.name)return a=a.name.toLowerCase(),k|="location"==a,r&&(p|=h.includes(a)),t&&(m|="feature-policy"==a),k});if(!k){var w=C.events.response(c.tabId,c.frameId,c.url);w&&(p||m)&&f.forEach((d,e)=>{if(d.name&&d.value){var g=d.name.toLowerCase();if(h.includes(g)){let a;if(a=b(d.value,c))x=!0,f[e]={name:d.name,value:a}}"feature-policy"==g&&(g=a(d.value,c))&&(x=!0,f[e]={name:d.name,value:g})}});var v;if(n.RUNTIME.FAST_EXEC_SUPPORT&&["instant"].includes(g.values.runtime_inject_mode)&&
(v=C.events.run(c.tabId,c.frameId,null,c.url))){var u=z.parse(c.url);u=u.pathname+u.search;u="TM_"+rea.runtime.short_id+I.Base64.encode(u.length+u).substr(0,255).replace(/[#=\/]/g,"_")+Date.now();v=aa.answer(v,c.url);v=JSON.stringify(v);v=new Blob([v],{type:"binary/octet-stream"});v=URL.createObjectURL(v);C.set.objurl(c.tabId,c.frameId,v);f.push({name:"set-cookie",value:u+"="+window.encodeURIComponent(v)+"; max-age=15;"});var x=!0}if(w&&!e&&rea.webRequest.filterResponseData&&n.OPTIONS.HAS_CSP&&"yes"==
g.values.webrequest_fixCSP&&"yes"==g.values.webrequest_fixContentCSP&&["main_frame","sub_frame"].includes(c.type)){let a;f.some(b=>{if(b.name&&b.value&&"content-type"==b.name.toLowerCase()&&"text/html"==b.value.split(";")[0].toLowerCase().trim())return a=!0});if(a){let a=rea.webRequest.filterResponseData(c.requestId);a.ondata=d=>{var e=(new TextDecoder("x-user-defined")).decode(d.data,{stream:!0});const f=new RegExp('(<head>[\\s\\S]*)(<meta[^>]+http-equiv="(?:'+h.join("|")+')"[^>]*>)([\\s\\S]*?<\\/head>)',
"i");let g;e=e.replace(f,(a,d,e,f)=>d+e.replace(/(content=")([^">]+)(")/,(a,d,e,f)=>{if(a=b(e||"",c))g=!0;return d+(a||e)+f})+f);g?a.write(I.str2arrbuf(e)):a.write(d.data);a.disconnect();a=null};a.onstop=()=>{a&&a.disconnect()}}}if(x)return n.RUNTIME.FIREFOX&&(f=f.filter(a=>"cache-control"!=a.name.toLowerCase()),f.push({name:"cache-control",value:"no-cache, no-store, must-revalidate"})),{responseHeaders:f}}}}else G.registerLateCallback(()=>{q(c,!0)})},r=a=>{d[a.requestId]=a.redirectUrl},E=a=>{G.late?
"xmlhttprequest"==a.type?(delete l[a.requestId],delete d[a.requestId]):a.fromCache&&C.events.response(a.tabId,a.frameId,a.url):G.registerLateCallback(()=>{E(a)})},A=a=>{"xmlhttprequest"==a.type?(delete l[a.requestId],delete d[a.requestId]):C.events.reset(a.tabId,!0)};return{getPrefix:function(){return f},init:function(a){try{let b;b=n.RUNTIME.EDGE?["http://*/*","https://*/*"]:["http://*/*","https://*/*","ftp://*/*","file:///*"].concat(n.RUNTIME.WEBREQUEST_WEBSOCKET?["ws://*/*","wss://*/*"]:[]);a?
(rea.webRequest.onBeforeRequest.addListener(u,{urls:b,types:["main_frame","sub_frame","script","xmlhttprequest"].concat(n.RUNTIME.WEBREQUEST_WEBSOCKET?["websocket"]:[])},["blocking"]),rea.webRequest.onHeadersReceived.addListener(q,{urls:b,types:["main_frame","sub_frame","xmlhttprequest"]},["blocking","responseHeaders"].concat(t?["extraHeaders"]:[])),n.RUNTIME.WEBREQUEST_XHR_SUPPORT&&rea.webRequest.onBeforeRedirect.addListener(r,{urls:b,types:["xmlhttprequest"]},[]),rea.webRequest.onResponseStarted.addListener(E,
{urls:b,types:["main_frame","sub_frame","xmlhttprequest"]},[]),rea.webRequest.onErrorOccurred.addListener(A,{urls:b,types:["main_frame","xmlhttprequest"]})):n.RUNTIME.WEBREQUEST_XHR_SUPPORT&&"no"!=g.values.webrequest_modHeaders&&rea.webRequest.onBeforeSendHeaders.addListener(k,{urls:b,types:["xmlhttprequest"]},["blocking","requestHeaders"].concat(t?["extraHeaders"]:[]));rea.webRequest.handlerBehaviorChanged()}catch(H){m.warn("webRequest: error initializings",H.message)}},scripts:{set:function(a,b,
c,d,e){const f=[];d.forEach(a=>{const b="string"===typeof a.selector?{include:[a.selector]}:a.selector;["include","match","exclude"].forEach(b=>{"string"===typeof a.selector[b]&&(a.selector[b]=[a.selector[b]])});let c=a.action;if("string"===typeof c){const a=c;c={};c[a]=!0}"string"===typeof a.action.redirect&&(a.action.redirect={url:a.action.redirect});f.push({selector:b,action:c})});C.set.requests(a,b,c,{id:c+"@"+a+":"+b+"#"+Date.now(),rules:f,uuid:c,callback:e})}}}})(),G={late:!1,callbacks:[],init:function(){},
registerLateCallback:function(d){m.debug("toea: register callback");G.callbacks.push(d)},ensureLate:function(d){G.late?d():G.registerLateCallback(d)},setReady:function(){m.debug("toea: run "+G.callbacks.length+" callbacks");G.late=!0;for(let d=0;d<G.callbacks.length;d++)G.callbacks[d]();G.callbacks=[]}},Ha=(()=>{let d=!1,g=null;const f=()=>{d||(m.debug("Unloader.onbeforeunload()"),g&&g(),d=!0)};return{init:function(d){g=d;window.addEventListener("beforeunload",f,!1)}}})(),ja=(()=>{let p=null;var w=
rea.extension.manifest.version,f=null,h=!1,t=!1;const b=()=>{if(G.late){var a="version="+w+"&ext="+rea.runtime.short_id+"&updated=true";if(h){var c="https://www.tampermonkey.net/installed.php?"+a;t=!0}else a+="&old="+f,c="https://www.tampermonkey.net/changelog.php?"+a;"off"!=g.values.notification_showUpdate&&("notification"==g.values.notification_showUpdate?W.showUpdate(d.getMessage("Updated_to__0version0",w),d.getMessage("Click_here_to_see_the_recent_changes"),Q.images.brand("tampermonkey"),a=>{a.clicked&&
rea.tabs.create({url:c},()=>{})}):"changelog"==g.values.notification_showUpdate&&(t||(c+="&intr=true"),t=!0,rea.tabs.create({url:c,active:t},()=>{})))}else G.registerLateCallback(b)},a=()=>{let a=null,b;const c=l(),d=()=>{b&&(b=null,c.resolve(!!a))};b=window.setTimeout(d,300);rea.idle.queryState(n.MISC.IDLE_TIMEOUT,b=>{a="active"==b;d()});return c.promise()},c=(()=>{const a=l(),b=()=>{var b=Date.now(),c=u.getValue(n.CONSTANTS.STORAGE.LAST_START,0);b=Math.round((b-c)/1E3);c=b<=n.MISC.DISTURBANCE_ALLOWED;
m.log("upd: restart?",c,"(",b,"seconds ago)");a.resolve(c)};G.late?b():G.registerLateCallback(b);return a.promise()})(),e=()=>{let d=!1,e=!1;a().then(a=>{e=a;return c}).then(a=>{d=a}).always(()=>{t=!e||d;b();x=!0})};let k=null;var x=!1;const q={scheduleNotification:function(a,b){x||(f=a,h|=b,k&&window.clearTimeout(k),k=window.setTimeout(e,1E3))},updateAvailable:function(){return p},onInstalled:function(){q.scheduleNotification(null,!0)},onUpdated:function(a){q.scheduleNotification(a,!1)},onUpdateAvailable:a=>
{m.info("An update to version",a.version,"is available");p=a.version;window.setTimeout(()=>{W.show(d.getMessage("Update"),d.getMessage("0name0_0version0_is_available__Please_re_start_your_browser_to_update_",rea.extension.manifest.name,a.version),Q.images.brand("tampermonkey"),{timeout:6E4})},864E5)}};(()=>{G.registerLateCallback(()=>{u.setValue(n.CONSTANTS.STORAGE.LAST_START,Date.now())})})();return q})(),Ia=d=>{(()=>{const m=l();"toggle-enable"==d?(g.values.enabled=!g.values.enabled,m.resolve()):
rea.tabs.getSelected(null,f=>{let g;"open-dashboard"==d?g=rea.extension.getURL("options.html")+"#nav=dashboard":"open-dashboard-with-running-scripts"==d?g=rea.extension.getURL("options.html")+"#nav=dashboard&filter="+encodeURIComponent(f.url):"open-new-script"==d&&(g=rea.extension.getURL("options.html")+"#url="+I.Base64.encode(f.url)+"&nav=new-user-script");m.resolve(g?{url:g,active:!0,parent:f}:null)});return m.promise()})().then(d=>{d&&rea.tabs.create(d)})},wa=(()=>{const d=[],l=(a,b,e)=>{if(G.late){var c=
e.pendingUrl||e.url;"auto"==g.values.scriptUrlDetection&&qa.isScriptUrl(c)&&x.installFromUrl(c,{},{silent_fail:!0});c?"loading"==b.status?C.events.loading(e.id,0,c):"complete"==b.status&&C.events.complete(e.id,0,c):m.warn("tabUpdates: no tab url set! ",e);d.forEach(a=>{a({reason:"updated",status:b.status},e)})}else window.setTimeout(()=>{l(a,b,e)},100)},f=(a,b)=>{ia[a]&&(ia[a].onClose(),delete ia[a]);C.events.remove(a);d.forEach(b=>{b({reason:"removed"},{id:a})})},h=(a,b)=>{f(b,{});R.setIcon(a);R.setBadge(a);
d.forEach(b=>{b({reason:"replaced"},a)})},n=a=>{G.late?(C.events.commited(a.tabId,a.frameId,a.url),0===a.frameId&&d.forEach(b=>{b({reason:"commited"},{url:a.url,id:a.tabId})})):window.setTimeout(()=>{n(a)},100)},b={init:function(){rea.tabs.onUpdated.addListener(l);rea.tabs.onRemoved.addListener(f);rea.tabs.onReplaced.addListener(h);rea.webNavigation.supported&&rea.webNavigation.onCommitted.addListener(n)},openAndWatch:function(a,c){let d=null;const f=(a,e)=>{null!==d&&e.id===d&&(["updated","commited"].includes(a.reason)?
c(e):"removed"==a.reason&&(b.removeListener(f),c()))};rea.tabs.create(a,a=>{d=a.id;c(a)});b.addListener(f);return{cancel:function(){b.removeListener(f);null!==d&&rea.tabs.remove(d,()=>{const a=rea.runtime.lastError;a?m.warn("tab.close",a.message):d=null})}}},addListener:function(a){d.push(a)},removeListener:function(a){let b;d&&-1<(b=d.indexOf(a))&&d.splice(b,1)}};return b})(),Ba=()=>{const d="temporary"==g.values.incognito_mode&&rea.extension.inIncognitoContext;u.setTemporary(d);d&&(g.values.sync_enabled=
!1,g.values.scriptUpdateCheckPeriod=0,g.values.sync_type=0,g.values.statistics_enabled=!1)},Ja=()=>{m.set(g.values.logLevel);d.setLocale(g.values.i18n);var l=n.RUNTIME.WEBREQUEST_XHR_SUPPORT&&"no"!=g.values.webrequest_modHeaders;U=Registry.get("xmlhttprequest");U.setConfig({prefix:l?ka.getPrefix():null,mozAnon:n.RUNTIME.FIREFOX});ca.init();N.init("bg",rea.extension.manifest.version,g.values.statistics_enabled,!0);C.listeners.add.onReset((d,f)=>{fa.clearByTabId(d);A.removeStorageListeners({tabid:d},
!1);f||R.setIcon(d)});l=d=>{0<=d&&rea.tabs.get(d,f=>{!rea.runtime.lastError&&f&&(R.setIcon(d),R.setBadge(d))})};C.listeners.add.onCommited(l);C.listeners.add.onCompleted(l);C.listeners.add.onCompleted(la.purgeAppeals);C.listeners.add.onRemoved(la.purgeAppeals);C.listeners.add.onRemoved(pa.cleanTab);M.init().done(d=>{d&&M.sync()});X.init();J.init();A.init();l=()=>{K.set_mode(g.values.downloads_mode);K.set_whitelist(g.values.downloads_extension_whitelist)};l();K.config_changed_listener=l;ta.init();
ka.init();oa.init();ea.init();da.init()},U,ma,D,F,va;init=()=>{d.init();G.init();ka.init(!0);wa.init();za.init();rea.commands.supported&&rea.commands.onCommand.addListener(Ia);Ha.init(()=>{M.finalize()});ma=Registry.get("compat",n);D=Registry.get("parser");D.init(ma);F=Registry.get("syncinfo",wa);va=Registry.get("test");rea.browserAction.setIcon({path:rea.extension.getURL("images/icon_grey.png")});rea.browserAction.setPopup({popup:"action.html"});rea.browserAction.setTitle({title:"Tampermonkey"});
rea.runtime.onUpdateAvailable.addListener(ja.onUpdateAvailable);rea.runtime.onInstalled.addListener(d=>{m.log("bg: onInstalled",d);d||(d={reason:"mandatory_argument_is_not_set"});if("install"==d.reason)sa.onInstalled();else if("update"==d.reason)sa.onUpdated(d.previousVersion);G.ensureLate(()=>{if("chrome_update"==d.reason)N.tB({updated:!0});else if("install"==d.reason)ja.onInstalled();else if("update"==d.reason)ja.onUpdated(d.previousVersion)})});u.init().then(Ca).then(sa.init).then(g.init).then(()=>
{cfgo=g;Ba();Ja();Ea();R.init();window.setTimeout(da.check,1E4);sa.check().then(()=>{m.log("Listeners registered!");window.setTimeout(G.setReady,1)})})};init()}});
