'use strict';Registry.require(["promise","helper"],()=>{const m=Registry.get("helper"),h=Registry.get("promise");let e={};const n=a=>{const b=m.createUUID();e[b]=a;return b},p=(a,b)=>{const c=h();void 0===b&&(b=!0);rea.tabs.getSelected(null,d=>{d=d?d.index:void 0;rea.tabs.create({url:rea.extension.getURL("ask.html")+"?aid="+a,active:b,index:d},a=>{a||(console.error("rea.tabs.create failed -> giving up now!"),c.reject({error:"rea.tabs.create failed -> giving up now!"}));c.resolve({id:a.id,close:function(){rea.tabs.remove(a.id)}})})});
return c.promise()};let f=null;const q=()=>{const a=Date.now(),b=e;e={};const c=Object.keys(b);c.forEach(d=>{const c=b[d];c&&15E3>a-c.ts?e[d]=c:c.com.reject()});f&&0===c.length&&(window.clearInterval(f),f=null)};let k=!1;const g=(a,b)=>{k||l.init();null===f&&(f=window.setInterval(q,5E3));const c=h();a={ts:Date.now(),com:c,preparat:b,type:a};a=n(a);return p(a,b.active).then(a=>c.promise().done(b=>{(b.ok||b.aborted)&&a.close()}))},l={init:function(){k||(k=!0)},onMessage:function(a){const b=h(),c=a.aid,
d=e[c];if(d)if(d.aborter&&(window.clearTimeout(d.aborter),delete d.aborter),"ping"==a.method)e[c].ts=Date.now(),b.resolve({pong:!0});else if("preparat"==a.method)b.resolve({preparat:d.preparat,type:d.type});else if("install"==a.method)d.com.resolve({ok:!0}),b.resolve({}),delete e[c];else if("import"==a.method)d.com.resolve({ok:!0,import_ids:a.import_ids,global_settings:a.global_settings}),b.resolve({}),delete e[c];else if("permission"==a.method)d.com.resolve({ok:!0,granted:a.granted,permissions:a.permissions,
origins:a.origins}),b.resolve({}),delete e[c];else if("unload"==a.method||"abort"==a.method){b.resolve({});const f=()=>{d.com.resolve({ok:!1,aborted:!0});delete e[c]};"abort"==a.method?f():d.aborter=window.setTimeout(f,3E3)}else"connect"==a.method&&(d.com.resolve(a),b.resolve({}),delete e[c]);else b.reject({error:"unknown_id",please_close:!0});return b.promise()},install:function(a){return g("install",a)},import:function(a,b){return g("import",{scripts:a,global_settings:b})},askForPermission:function(a,
b,c){return g("permission",{permissions:a.permissions,origins:a.origins,title:b,message:c})},installError:function(a){return g("install_error",a)},askForConnect:function(a){return g("connect",a)}};Registry.register("asker","7c765150",l)});
