import MSG_TYPE from"../static/js/common.js";import Settings from"../options/settings.js";import DataSync from"./data-sync.js";import Menu from"./menu.js";var BgPageInstance=function(){let e={notifyTimeoutId:-1},t=function(t){let n="FeJson-notify-id";if(clearTimeout(e.notifyTimeoutId),t.closeImmediately)return chrome.notifications.clear(n);t.icon||(t.icon="static/img/fe-48.png"),t.title||(t.title="温馨提示"),chrome.notifications.create(n,{type:"basic",title:t.title,iconUrl:chrome.runtime.getURL(t.icon),message:t.message}),e.notifyTimeoutId=setTimeout(()=>{chrome.notifications.clear(n)},parseInt(t.autoClose||3e3,10))},n=function(e,t){let n=function(e,t){return function(n){t&&setTimeout(function(){chrome.tabs.sendMessage(n.id,{type:MSG_TYPE.TAB_CREATED_OR_UPDATED,content:t,event:e})},300)}};chrome.tabs.query({windowId:chrome.windows.WINDOW_ID_CURRENT},function(i){Settings.getOptsFromBgPage(o=>{let r,s=!1;if(o.FORBID_OPEN_IN_NEW_TAB){let t=new RegExp("^chrome.*/"+e+"/index.html$","i");for(let e=0,n=i.length;e<n;e++)if(t.test(i[e].url)){s=!0,r=i[e].id;break}}s?chrome.tabs.update(r,{highlighted:!0},n(e,t)):chrome.tabs.create({url:e+"/index.html",active:!0},n(e,t))})})};return{init:function(){setTimeout(()=>{chrome.runtime.requestUpdateCheck(e=>{"update_available"===e&&chrome.runtime.reload()})},1e4),chrome.browserAction.onClicked.addListener(function(e,t,i){n(MSG_TYPE.JSON_FORMAT)}),chrome.runtime.onMessage.addListener(function(e,i,o){return e.type===MSG_TYPE.GET_OPTIONS?Settings.getOptsFromBgPage(o):e.type===MSG_TYPE.SET_OPTIONS?(Settings.setOptsFromBgPage(e.items),Menu.manage(Settings,n),t({message:"配置已生效，请继续使用!",autoClose:2e3})):e.type===MSG_TYPE.JSON_PAGE_FORMAT_REQUEST?Settings.getOptsFromBgPage(e=>{e.JSON_PAGE_FORMAT&&chrome.tabs.query({active:!0,currentWindow:!0},function(t){chrome.tabs.sendMessage(t[0].id,{type:MSG_TYPE.JSON_PAGE_FORMAT,options:{MAX_JSON_KEYS_NUMBER:e.MAX_JSON_KEYS_NUMBER,AUTO_TEXT_DECODE:"true"===String(e.AUTO_TEXT_DECODE)}})})}):e.type===MSG_TYPE.OPEN_OPTION_PAGE?chrome.runtime.openOptionsPage():e.type===MSG_TYPE.OPEN_PAGE&&n(e.page,e.text),!0}),chrome.runtime.onInstalled.addListener(({reason:e,previousVersion:t})=>{switch(e){case"install":chrome.runtime.openOptionsPage();break;case"update":setTimeout(()=>{chrome.browserAction.setBadgeText({text:"+++1"}),setTimeout(()=>{chrome.browserAction.setBadgeText({text:""})},1500)},1500)}}),chrome.runtime.setUninstallURL(chrome.runtime.getManifest().homepage_url),Menu.manage(Settings,n),DataSync.localDataSyncByGoogle()},notify:t}}();BgPageInstance.init();