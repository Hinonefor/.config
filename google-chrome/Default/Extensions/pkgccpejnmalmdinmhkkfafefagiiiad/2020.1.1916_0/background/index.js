import MSG_TYPE from"../static/js/common.js";import Settings from"../options/settings.js";import DataSync from"./data-sync.js";import Menu from"./menu.js";import Awesome from"../dynamic/awesome.js";let BgPageInstance=function(){let FeJson={notifyTimeoutId:-1},notifyText=function(e){let t="FeJson-notify-id";if(clearTimeout(FeJson.notifyTimeoutId),e.closeImmediately)return chrome.notifications.clear(t);e.icon||(e.icon="static/img/fe-48.png"),e.title||(e.title="温馨提示"),chrome.notifications.create(t,{type:"basic",title:e.title,iconUrl:chrome.runtime.getURL(e.icon),message:e.message}),FeJson.notifyTimeoutId=setTimeout(()=>{chrome.notifications.clear(t)},parseInt(e.autoClose||3e3,10))};chrome.DynamicToolRunner=function(e){let t=e.tool||MSG_TYPE.DYNAMIC_TOOL,o=e.withContent,n=e.query,i=function(e,t){return function(o){t&&setTimeout(function(){chrome.tabs.sendMessage(o.id,{type:MSG_TYPE.TAB_CREATED_OR_UPDATED,content:t,event:e})},300)}};t===MSG_TYPE.JSON_FORMAT&&Awesome.detectInstall(t,!1,!0)&&(t=MSG_TYPE.DYNAMIC_TOOL,n="tool=json-format"),chrome.tabs.query({windowId:chrome.windows.WINDOW_ID_CURRENT},function(e){Settings.getOptions(a=>{let r,s=!1;if("true"===a.FORBID_OPEN_IN_NEW_TAB){let o=new RegExp("^chrome.*\\/"+t+"\\/index.html"+(n?"\\?"+n:"")+"$","i");for(let t=0,n=e.length;t<n;t++)if(o.test(e[t].url)){s=!0,r=e[t].id;break}}s?chrome.tabs.update(r,{highlighted:!0},i(t,o)):chrome.tabs.create({url:t+"/index.html"+(n?"?"+n:""),active:!0},i(t,o))})})};let _animateTips=e=>{setTimeout(()=>{chrome.browserAction.setBadgeText({text:e}),setTimeout(()=>{chrome.browserAction.setBadgeText({text:""})},2e3)},3e3)},browserActionClickedHandler=function(e,t,o){chrome.DynamicToolRunner({tool:MSG_TYPE.JSON_FORMAT})},_updateBrowserAction=function(e,t,o){if(o?Menu.manage(Settings):Awesome.getInstalledTools().length?(chrome.browserAction.setPopup({popup:"popup/index.html"}),"install"===e&&_animateTips("+1")):(chrome.browserAction.setPopup({popup:""}),chrome.browserAction.onClicked.hasListener(browserActionClickedHandler)||chrome.browserAction.onClicked.addListener(browserActionClickedHandler),_animateTips("-1")),t){let t="";switch(e){case"install":t="工具已「安装」成功，并已添加到弹出下拉列表，点击FeHelper图标可正常使用！";break;case"upgrade":t="工具已「更新」成功，点击FeHelper图标可正常使用！";break;case"offload":t="工具已「卸载」成功，并已从弹出下拉列表中移除！";break;case"menu-install":t="已将此工具快捷方式加入到「右键菜单」中！";break;case"menu-offload":t="已将此工具快捷方式从「右键菜单」中移除！";break;default:t="恭喜，操作成功！"}notifyText({message:t,autoClose:2500})}},_addExtensionListener=function(){_updateBrowserAction(),chrome.runtime.onMessage.addListener(function(request,sender,callback){if(request.type===MSG_TYPE.DYNAMIC_TOOL_INSTALL_OR_OFFLOAD)_updateBrowserAction(request.action,request.showTips,request.menuOnly),callback&&callback();else if(request.type===MSG_TYPE.OPEN_DYNAMIC_TOOL)chrome.DynamicToolRunner({tool:request.page,query:request.query}),callback&&callback();else if(request.type===MSG_TYPE.OPEN_PAGE)chrome.DynamicToolRunner({tool:request.page}),callback&&callback();else if(request.type===MSG_TYPE.DYNAMIC_ANY_THING){let func=eval(request.func);func&&func(request.params,callback)}else callback&&callback();return!0}),chrome.runtime.onInstalled.addListener(({reason:e,previousVersion:t})=>{switch(e){case"install":chrome.runtime.openOptionsPage();break;case"update":_animateTips("+++1"),"2019.12.2415"===t&&notifyText({message:"历尽千辛万苦，FeHelper已升级到最新版本，可以到插件设置页去安装旧版功能了！",autoClose:5e3})}}),chrome.runtime.setUninstallURL(chrome.runtime.getManifest().homepage_url)},_checkUpdate=function(){setTimeout(()=>{chrome.runtime.requestUpdateCheck(e=>{"update_available"===e&&chrome.runtime.reload()})},1e4)},_init=function(){_checkUpdate(),_addExtensionListener(),Menu.manage(Settings),DataSync.localDataSyncByGoogle()};return{init:_init}}();BgPageInstance.init();