import Settings from"./settings.js";import Awesome from"../dynamic/awesome.js";import MSG_TYPE from"../static/js/common.js";new Vue({el:"#pageContainer",data:{defaultKey:"Alt+Shift+J",selectedOpts:[],maxJsonKeysNumber:0,manifest:{},fhTools:Awesome.allTools,menuFeHelperSeting:!1,menuDownloadCrx:!1},created:function(){this.manifest=chrome.runtime.getManifest(),chrome.commands&&chrome.commands.getAll&&chrome.commands.getAll(e=>{e.some(e=>{if("_execute_browser_action"===e.name&&e.shortcut)return this.defaultKey=e.shortcut,!0})}),Settings.getOptions(e=>{this.selectedOpts=Object.keys(e).filter(t=>"MAX_JSON_KEYS_NUMBER"!==t&&"true"===String(e[t])),this.maxJsonKeysNumber=e.MAX_JSON_KEYS_NUMBER}),this.menuFeHelperSeting="0"!==Awesome.menuMgr("fehelper-setting","get"),this.menuDownloadCrx="1"===Awesome.menuMgr("download-crx","get"),Awesome.getInstalledTools().forEach(e=>{Awesome.checkUpgrade(e).then(t=>{this.fhTools[e].upgrade=t})});let remoteUpgradeUrl=`${this.manifest.homepage_url}/static/js/awesome.js?v=${1*new Date}`;navigator.onLine&&fetch(remoteUpgradeUrl).then(e=>e.text()).then(jsText=>{try{if(!jsText)return!1;eval(jsText),localStorage.setItem(Awesome.TOOLS_FROM_REMOTE,jsText),Object.keys(RemoteAwesome.newTools).forEach(e=>{this.fhTools[e]?(this.fhTools[e].name=RemoteAwesome.newTools[e].name||this.fhTools[e].name,this.fhTools[e].tips=RemoteAwesome.newTools[e].tips||this.fhTools[e].tips,this.fhTools[e].menuConfig=RemoteAwesome.newTools[e].menuConfig||this.fhTools[e].menuConfig,void 0!==RemoteAwesome.newTools[e].contentScript&&this.fhTools[e].contentScript!==RemoteAwesome.newTools[e].contentScript&&(this.fhTools[e].contentScript=RemoteAwesome.newTools[e].contentScript,this.fhTools[e].upgrade=!0),void 0!==RemoteAwesome.newTools[e].contentScriptCss&&this.fhTools[e].contentScriptCss!==RemoteAwesome.newTools[e].contentScriptCss&&(this.fhTools[e].contentScriptCss=RemoteAwesome.newTools[e].contentScriptCss,this.fhTools[e].upgrade=!0),void 0!==RemoteAwesome.newTools[e].offloadForbid&&this.fhTools[e].offloadForbid!==RemoteAwesome.newTools[e].offloadForbid&&(this.fhTools[e].offloadForbid=RemoteAwesome.newTools[e].offloadForbid,this.fhTools[e].upgrade=!0)):this.fhTools[e]=RemoteAwesome.newTools[e]}),RemoteAwesome.removedTools.forEach(e=>{delete this.fhTools[e]}),this.$forceUpdate()}catch(e){console.log(e)}})},methods:{close:()=>{chrome.tabs.query({active:!0,currentWindow:!0},e=>{chrome.tabs.remove(e[0].id)})},cancel:function(){this.close()},save:function(){Settings.setOptions(this.selectedOpts.concat([{MAX_JSON_KEYS_NUMBER:parseInt(this.maxJsonKeysNumber,10)}]),()=>{chrome.runtime.sendMessage({type:MSG_TYPE.DYNAMIC_ANY_THING,func:((e,t)=>{Menu.manage(Settings),notifyText({message:"配置已生效，请继续使用!",autoClose:2e3})}).toString()})});let e=this.menuFeHelperSeting?"install":"offload";Awesome.menuMgr("fehelper-setting",e).then(()=>{chrome.runtime.sendMessage({type:MSG_TYPE.DYNAMIC_TOOL_INSTALL_OR_OFFLOAD,action:`menu-${e}`,showTips:!1,menuOnly:!0})});let t=this.menuDownloadCrx?"install":"offload";Awesome.menuMgr("download-crx",t).then(()=>{chrome.runtime.sendMessage({type:MSG_TYPE.DYNAMIC_TOOL_INSTALL_OR_OFFLOAD,action:`menu-${t}`,showTips:!1,menuOnly:!0})}),setTimeout(()=>{this.close()},1e3)},setShortcuts:function(){return chrome.tabs.create({url:"chrome://extensions/shortcuts"}),!1},donateToggle:function(e){let t=this.$refs.boxDonate;t.classList.contains("hide")?(t.classList.remove("hide"),t.style.top=e.target.offsetTop+30+"px",t.style.left=e.target.offsetLeft+"px"):t.classList.add("hide")},installOrUpgrade:function(e,t){if(!navigator.onLine)return alert("检测到当前网络处于离线状态，但工具需要联网安装，请稍后再试！");if("1"===t.target.getAttribute("data-undergoing"))return!1;t.target.setAttribute("data-undergoing",1);let o=t.target.querySelector("span.x-progress");Awesome.install(e,e=>{o.textContent=`(${e})`}).then(()=>{this.fhTools[e].upgrade&&(this.fhTools[e].upgrade=!1),chrome.runtime.sendMessage({type:MSG_TYPE.DYNAMIC_TOOL_INSTALL_OR_OFFLOAD,toolName:e,action:this.fhTools[e].installed?"upgrade":"install",showTips:!0,backgroundScript:this.fhTools[e].backgroundScript}),this.$nextTick(()=>{t.target.setAttribute("data-undergoing",0),o.textContent="(100%)",setTimeout(()=>{this.fhTools[e].installed=!0,o.textContent=""},500)})},e=>{t.target.setAttribute("data-undergoing",0),alert("目前网络好像不太好，请稍后再试...")})},offLoad:function(e,t){if("1"===t.target.getAttribute("data-undergoing"))return!1;t.target.setAttribute("data-undergoing",1),Awesome.offLoad(e).then(()=>{chrome.runtime.sendMessage({type:MSG_TYPE.DYNAMIC_TOOL_INSTALL_OR_OFFLOAD,action:"offload",showTips:!0}),this.fhTools[e].installed=!1,t.target.setAttribute("data-undergoing",0),Awesome.menuMgr(e,"offload").then(()=>{this.fhTools[e].menu=!1,chrome.runtime.sendMessage({type:MSG_TYPE.DYNAMIC_TOOL_INSTALL_OR_OFFLOAD,action:"menu-offload",showTips:!1,menuOnly:!0})})})},menuMgr:function(e,t){if("1"===t.target.getAttribute("data-undergoing"))return!1;t.target.setAttribute("data-undergoing",1);let o=this.fhTools[e].menu,s=o?"offload":"install";Awesome.menuMgr(e,s).then(()=>{chrome.runtime.sendMessage({type:MSG_TYPE.DYNAMIC_TOOL_INSTALL_OR_OFFLOAD,action:`menu-${s}`,showTips:!0,menuOnly:!0}),this.fhTools[e].menu=!o,t.target.setAttribute("data-undergoing",0)})},openFeOnline:function(){chrome.tabs.create({url:this.manifest.homepage_url})}}});